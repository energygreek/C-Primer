<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  
  <title>又是元气满满的一天</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta property="og:type" content="website">
<meta property="og:title" content="又是元气满满的一天">
<meta property="og:url" content="https://energygreek.github.io/page/3/index.html">
<meta property="og:site_name" content="又是元气满满的一天">
<meta property="og:locale" content="cn">
<meta property="article:author" content="husongtao">
<meta name="twitter:card" content="summary">
  
  
    <link rel="shortcut icon" href="/favicon.png">
  
  
    
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/typeface-source-code-pro@0.0.71/index.min.css">

  
  
<link rel="stylesheet" href="/css/style.css">

  
    
<link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css">

  
<meta name="generator" content="Hexo 4.2.1"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">又是元气满满的一天</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="https://energygreek.github.io"></form>
      </div>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main">
  
    <article id="post-tcp-ip-网络协议" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2020/11/17/tcp-ip-%E7%BD%91%E7%BB%9C%E5%8D%8F%E8%AE%AE/" class="article-date">
  <time class="dt-published" datetime="2020-11-17T06:04:59.000Z" itemprop="datePublished">2020-11-17</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2020/11/17/tcp-ip-%E7%BD%91%E7%BB%9C%E5%8D%8F%E8%AE%AE/">tcp/ip 网络协议</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        
      
    </div>
    <footer class="article-footer">
      <a data-url="https://energygreek.github.io/2020/11/17/tcp-ip-%E7%BD%91%E7%BB%9C%E5%8D%8F%E8%AE%AE/" data-id="ckp6c7anf0021d1ok0nav8gn6" data-title="tcp/ip 网络协议" class="article-share-link">Share</a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-python-package-1" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2020/11/16/python-package-1/" class="article-date">
  <time class="dt-published" datetime="2020-11-16T02:53:51.000Z" itemprop="datePublished">2020-11-16</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2020/11/16/python-package-1/">python package2</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="python-安装方式有2种-pip-和-easy-install"><a href="#python-安装方式有2种-pip-和-easy-install" class="headerlink" title="python 安装方式有2种 pip 和 easy_install"></a>python 安装方式有2种 pip 和 easy_install</h1><p>easy_install 是随setuptools 附带的安装工具<br>pip 是后出的替 代setuptools 的工具</p>
<h2 id="支持情况"><a href="#支持情况" class="headerlink" title="支持情况"></a>支持情况</h2><p>pip 支持新的sdist标准，包括whl二进制包和源码tar包，支持安装和卸载<br>easy_install 支持老的 Egg  格式</p>
<h2 id="总结一句话"><a href="#总结一句话" class="headerlink" title="总结一句话"></a>总结一句话</h2><p>使用pip 不要使用easy_install</p>
<h2 id="包-Platform-tags"><a href="#包-Platform-tags" class="headerlink" title="包 Platform tags"></a>包 Platform tags</h2><p>linux的包的tags有好几个，向后兼容</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">manylinux1 支持 x86_64 i686</span><br><span class="line">manylinux2010 支持 x86_64 i686</span><br><span class="line">manylinux2014 支持 x86_64 i686 arm ppc</span><br></pre></td></tr></table></figure>
<p>manylinux2010 取代了 manylinux1, 而且已经EOL,  所以尽早使用manylinux2014</p>
<h2 id="使用pip打包"><a href="#使用pip打包" class="headerlink" title="使用pip打包"></a>使用pip打包</h2><p>先生成 requirements.txt, 手动加上自己的包myapp</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">pip list &gt; requirements.txt</span><br><span class="line"></span><br><span class="line"># 打包命令</span><br><span class="line">python -m pip wheel --wheel-dir&#x3D;.&#x2F;local&#x2F;wheels -r requirements.txt</span><br></pre></td></tr></table></figure>

<p>查看生成的包</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">cd local&#x2F;wheels</span><br><span class="line">Bootstrap_Flask-1.5.1-py2.py3-none-any.whl  Flask_SQLAlchemy-2.4.4-py2.py3-none-any.whl  Jinja2-2.11.2-py2.py3-none-any.whl                SQLAlchemy-1.3.20-cp38-cp38-manylinux2010_x86_64.whl</span><br><span class="line">click-7.1.2-py2.py3-none-any.whl            Flask_WTF-0.14.3-py2.py3-none-any.whl        MarkupSafe-1.1.1-cp38-cp38-manylinux1_x86_64.whl  Werkzeug-1.0.1-py2.py3-none-any.whl</span><br><span class="line">Flask-1.1.2-py2.py3-none-any.whl            itsdangerous-1.1.0-py2.py3-none-any.whl      myapp-0.1.dev0-py3-none-any.whl                   WTForms-2.3.3-py2.py3-none-any.whl</span><br></pre></td></tr></table></figure>

<h2 id="使用pip-安装"><a href="#使用pip-安装" class="headerlink" title="使用pip 安装"></a>使用pip 安装</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python -m pip install --no-index --find-links&#x3D;.&#x2F;local&#x2F;wheels -r requirements.txt</span><br></pre></td></tr></table></figure>

<h2 id="对于外部的包，需要本地安装"><a href="#对于外部的包，需要本地安装" class="headerlink" title="对于外部的包，需要本地安装"></a>对于外部的包，需要本地安装</h2><p>这个通常是在ci/cd上使用， 先把所有依赖拉到本地，就可以直接从本地的repo里下载依赖，离线安装</p>
<p>首先下载包的依赖，然后进行安装</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">python -m pip download --destination-directory DIR -r requirements.txt</span><br><span class="line"></span><br><span class="line">python -m pip install --no-index --find-links&#x3D;DIR -r requirements.txt</span><br></pre></td></tr></table></figure>

<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>pip和 whell 作为新的打包和安装方式，比较简单也支持多平台CPU, 推荐</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://energygreek.github.io/2020/11/16/python-package-1/" data-id="ckp6c7amy0018d1ok4d70gqza" data-title="python package2" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/python/" rel="tag">python</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-advanced-marco-in-c" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2020/11/10/advanced-marco-in-c/" class="article-date">
  <time class="dt-published" datetime="2020-11-10T10:48:01.000Z" itemprop="datePublished">2020-11-10</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2020/11/10/advanced-marco-in-c/">advanced marco in c</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h1><p>宏定义是在c/c++里特有的方式， 像变量一样， 又像模板编程一样， 但最常见的用法还是做头文件的唯一性保证  </p>
<p>在每一个头文件都套用这种格式，就可以避免多次引入头文件而导致的重复定义报错</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> FILE_NAME</span></span><br><span class="line"><span class="meta">#def FILE_NAME</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 代码</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span> FILE_NAME</span></span><br></pre></td></tr></table></figure>

<h2 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h2><p>宏定义与变量、模板的最大区别在与处理的时期， 宏定义在预编译时处理， 而变量和模板函数则是在编译期处理。<br>查看预编译后的代码可以使用命令<code>gcc -E</code> 或者 <code>cpp</code>， 实际上是前者是调用了后者</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">NAME</span><br><span class="line">       cpp - The C Preprocessor</span><br></pre></td></tr></table></figure>

<h2 id="用法"><a href="#用法" class="headerlink" title="用法"></a>用法</h2><p>除了<code>#ifdef</code> 的用法，宏定义可以分两种类型，变量型和函数型</p>
<h3 id="变量型"><a href="#变量型" class="headerlink" title="变量型"></a>变量型</h3><p>这个最简单，就像使用变量一样，先define 然后再使用</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># marco.c</span><br><span class="line">#define BUFFER_SIZE 1024</span><br><span class="line"></span><br><span class="line">int main()&#123;</span><br><span class="line">	foo &#x3D; (char *) malloc (BUFFER_SIZE);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>执行 <code>gcc -E marco.c</code> 得到</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">foo &#x3D; (char *) malloc (1024);</span><br></pre></td></tr></table></figure>

<p>多行使用 ‘&#39; 来连接</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">#include &lt;stdio.h&gt;</span><br><span class="line">#define GREETING_STR \</span><br><span class="line">  &quot;hello \</span><br><span class="line">world&quot;</span><br></pre></td></tr></table></figure>

<ul>
<li>注意, 宏定义的定义不分前后， 也不像变量那样先定义再使用， 宏定义可以先使用后定义  </li>
</ul>
<p>以下两种方式的效果相同</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">define GREETING_NAME &quot;wayou&quot;</span><br><span class="line"></span><br><span class="line">define GREETING &quot;hello,&quot; GREETING_NAME</span><br><span class="line"></span><br><span class="line">int main() &#123;</span><br><span class="line">printf(GREETING);</span><br><span class="line">return 0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="addition">+define GREETING "hello," GREETING_NAME</span></span><br><span class="line"></span><br><span class="line">define GREETING_NAME "wayou"</span><br><span class="line"></span><br><span class="line"><span class="deletion">-define GREETING "hello," GREETING_NAME</span></span><br><span class="line"></span><br><span class="line">int main() &#123;</span><br><span class="line">printf(GREETING);</span><br><span class="line">return 0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="函数型"><a href="#函数型" class="headerlink" title="函数型"></a>函数型</h3><p>函数类型的宏，可以像正常函数一样指定入参，入参需为逗号分隔合法的 C 字面量。<br>宏的参数必须要用括号包起来，否则当参数为表达式时，会出错</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">#define min(X, Y)  ((X) &lt; (Y) ? (X) : (Y))</span><br><span class="line">  x &#x3D; min(a, b);          →  x &#x3D; ((a) &lt; (b) ? (a) : (b));</span><br><span class="line">  y &#x3D; min(1, 2);          →  y &#x3D; ((1) &lt; (2) ? (1) : (2));</span><br><span class="line">  z &#x3D; min(a + 28, *p);    →  z &#x3D; ((a + 28) &lt; (*p) ? (a + 28) : (*p));</span><br></pre></td></tr></table></figure>

<h3 id="宏定义字符串化"><a href="#宏定义字符串化" class="headerlink" title="宏定义字符串化"></a>宏定义字符串化</h3><p>当宏定义的参数被引号包起来时， 不会进行替换，如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#define foo(x) x, &quot;x&quot;</span><br><span class="line">foo(bar)        → bar, &quot;x&quot;</span><br></pre></td></tr></table></figure>

<p>加入需要将参数替换到字符串里， 可以使用’#’  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">#define WARN_IF(EXP) \</span><br><span class="line">do &#123; if (EXP) \</span><br><span class="line">        fprintf (stderr, &quot;Warning: &quot; #EXP &quot;\n&quot;); &#125; \</span><br><span class="line">while (0)</span><br><span class="line">WARN_IF (x &#x3D;&#x3D; 0);</span><br><span class="line">     → do &#123; if (x &#x3D;&#x3D; 0)</span><br><span class="line">           fprintf (stderr, &quot;Warning: &quot; &quot;x &#x3D;&#x3D; 0&quot; &quot;\n&quot;); &#125; while (0);</span><br></pre></td></tr></table></figure>

<p>而当 这里的x 也是宏定义时， 只有if里的x会替换， 字符串里的x则不会替换  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#define X ( 1 - 1 )</span><br><span class="line">WARN_IF ( X &#x3D;&#x3D; 0);</span><br></pre></td></tr></table></figure>
<p>会被替换为  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">do &#123; if (( 1 - 1 ) &#x3D;&#x3D; 0) fprintf (</span><br><span class="line">stderr</span><br><span class="line">, &quot;Warning: &quot; &quot;X &#x3D;&#x3D; 0&quot; &quot;\n&quot;); &#125; while (0);</span><br></pre></td></tr></table></figure>

<h3 id="拼接"><a href="#拼接" class="headerlink" title="拼接"></a>拼接</h3><p>通过 ## 可将两个宏展开成一个，即将两者进行了拼接，宏拼接一般用在需要拼接的宏是来自宏参数的情况，<br>其他情况，大可直接将两个宏写在一起即可</p>
<p>当有以下情况时非常有用</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">struct command</span><br><span class="line">&#123;</span><br><span class="line">  char *name;</span><br><span class="line">  void (*function) (void);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">struct command commands[] &#x3D;</span><br><span class="line">&#123;</span><br><span class="line">&#123; &quot;quit&quot;, quit_command &#125;,</span><br><span class="line">&#123; &quot;help&quot;, help_command &#125;,</span><br><span class="line">…</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>可以使用如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">#define COMMAND(NAME)  &#123; #NAME, NAME ## _command &#125;</span><br><span class="line"></span><br><span class="line">struct command commands[] &#x3D;</span><br><span class="line">&#123;</span><br><span class="line">COMMAND (quit),</span><br><span class="line">COMMAND (help),</span><br><span class="line">…</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h3 id="不定参数和混合参数"><a href="#不定参数和混合参数" class="headerlink" title="不定参数和混合参数"></a>不定参数和混合参数</h3><p>宏定义也可以使用不定参数</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">#define eprintf(args…) fprintf (stderr, args)</span><br></pre></td></tr></table></figure>

<p>也可以使用混合参数</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">#define eprintf(format, args...) fprintf (stderr, format, args)</span><br></pre></td></tr></table></figure>
<p>这个可以常在格式化打印时用到， 例如 <code>spdlog</code> 库  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">#define SPDLOG_LOGGER_CALL(logger, level, ...)                                                                                             \</span><br><span class="line">    if (logger-&gt;should_log(level))                                                                                                         \</span><br><span class="line">    logger-&gt;log(spdlog::source_loc&#123;SPDLOG_FILE_BASENAME(__FILE__), __LINE__, SPDLOG_FUNCTION&#125;, level, __VA_ARGS__)</span><br><span class="line"></span><br><span class="line">#if SPDLOG_ACTIVE_LEVEL &lt;&#x3D; SPDLOG_LEVEL_TRACE</span><br><span class="line">#define SPDLOG_LOGGER_TRACE(logger, ...) SPDLOG_LOGGER_CALL(logger, spdlog::level::trace, __VA_ARGS__)</span><br><span class="line">#define SPDLOG_TRACE(...) SPDLOG_LOGGER_TRACE(spdlog::default_logger_raw(), __VA_ARGS__)</span><br><span class="line">#else</span><br><span class="line">#define SPDLOG_LOGGER_TRACE(logger, ...) (void)0</span><br><span class="line">#define SPDLOG_TRACE(...) (void)0</span><br><span class="line">#endif</span><br><span class="line"></span><br><span class="line">#if SPDLOG_ACTIVE_LEVEL &lt;&#x3D; SPDLOG_LEVEL_DEBUG</span><br><span class="line">#define SPDLOG_LOGGER_DEBUG(logger, ...) SPDLOG_LOGGER_CALL(logger, spdlog::level::debug, __VA_ARGS__)</span><br><span class="line">#define SPDLOG_DEBUG(...) SPDLOG_LOGGER_DEBUG(spdlog::default_logger_raw(), __VA_ARGS__)</span><br><span class="line">#else</span><br><span class="line">#define SPDLOG_LOGGER_DEBUG(logger, ...) (void)0</span><br><span class="line">#define SPDLOG_DEBUG(...) (void)0</span><br><span class="line">#endif</span><br></pre></td></tr></table></figure>

<h2 id="重复和覆盖"><a href="#重复和覆盖" class="headerlink" title="重复和覆盖"></a>重复和覆盖</h2><p>这些是相似的：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">#define FOUR (2 + 2)</span><br><span class="line">#define FOUR         (2    +    2)</span><br><span class="line">#define FOUR (2 &#x2F;* two *&#x2F; + 2)</span><br></pre></td></tr></table></figure>

<p>以下都是不同的宏</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">#define FOUR (2 + 2)</span><br><span class="line">#define FOUR ( 2+2 ) &#x2F;&#x2F; 空白位置不一样 </span><br><span class="line">#define FOUR (2 * 2) &#x2F;&#x2F; 宏的内容不一样</span><br><span class="line">#define FOUR(score,and,seven,years,ago) (2 + 2) &#x2F;&#x2F; 入参不一样</span><br></pre></td></tr></table></figure>

<p>对于使用了 #undef 注销过的宏，再次定义同名的宏时，要求新定义的宏不与老的相似。</p>
<p>而如果说一个已经存在的宏，并没有注销，重复定义时，如果相似，则新的定义会忽略，如果不相似，编译器会报警告同时使用新定义的宏。这允许在多个文件中定义同一个宏。</p>
<h2 id="最后"><a href="#最后" class="headerlink" title="最后"></a>最后</h2><p> 可以查看更多<a href="https://gcc.gnu.org/onlinedocs/cpp/Predefined-Macros.html#Predefined-Macros" target="_blank" rel="noopener">内置宏定义</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://energygreek.github.io/2020/11/10/advanced-marco-in-c/" data-id="ckp6c7am50004d1okaczb0tv4" data-title="advanced marco in c" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/c-c/" rel="tag">c/c++</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-python-package" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2020/11/10/python-package/" class="article-date">
  <time class="dt-published" datetime="2020-11-10T02:36:23.000Z" itemprop="datePublished">2020-11-10</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2020/11/10/python-package/">python package</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="python-包的管理"><a href="#python-包的管理" class="headerlink" title="python 包的管理"></a>python 包的管理</h1><p>python 有 sdist 和 wheel 两种方式管理包：</p>
<p>sdist 是在 <code>python setup.py sdist</code>时产生的包，是一个源码压缩包，在安装时需要编译，所以环境依赖make和gcc<br>wheel 是在<code>python setup.py  bdist_wheel</code>是产生的whl 格式包</p>
<p>从命令都可以看出来sdist即source源码包， bdist 即binary二进制包  </p>
<p>sdist 由distutils、setuptools 定义和依赖的编译系统， 可以运行任意的代码<br>wheel 包为编译和安装时提供了简单的接口，里面包含了二进制的包，可以让安装者不需要知道编译体系,依赖wheel</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install wheel</span><br></pre></td></tr></table></figure>

<h2 id="两种包的打包命令"><a href="#两种包的打包命令" class="headerlink" title="两种包的打包命令"></a>两种包的打包命令</h2><p>前提是环境安装了setuptools和wheel, 且编写了setup.py文件如  </p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># setup.py</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> setuptools <span class="keyword">import</span> setup,find_namespace_packages</span><br><span class="line"><span class="comment">#import pathlib</span></span><br><span class="line"><span class="comment">#import pkg_resources</span></span><br><span class="line"><span class="comment">#import os</span></span><br><span class="line"><span class="comment">#import sys</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#sys.path.insert(0, os.path.join(</span></span><br><span class="line"><span class="comment">#    os.path.dirname(os.path.abspath(__file__)), 'src'))</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 解析文本文件</span></span><br><span class="line"><span class="comment">#with pathlib.Path('requirements.txt').open() as requirements_txt:</span></span><br><span class="line"><span class="comment">#    install_requires = [str(requirement) for requirement in pkg_resources.parse_requirements(requirements_txt) ]</span></span><br><span class="line"></span><br><span class="line">setup(name=<span class="string">'myflask'</span>,</span><br><span class="line">      version=<span class="string">'1.3'</span>,</span><br><span class="line">      install_requires=[</span><br><span class="line">            <span class="string">'Bootstrap-Flask==1.4'</span>,</span><br><span class="line">            <span class="string">'Flask==1.1.2'</span>,</span><br><span class="line">            <span class="string">'Flask-Login==0.5.0'</span>,</span><br><span class="line">            <span class="string">'SQLAlchemy==1.3.18'</span>,</span><br><span class="line">            <span class="string">'Werkzeug==1.0.1'</span>,</span><br><span class="line">            <span class="string">'WTForms==2.3.1'</span></span><br><span class="line">          ],</span><br><span class="line">      entry_points=&#123;</span><br><span class="line">             <span class="string">'console_scripts'</span>:[</span><br><span class="line">                   <span class="string">'myflask=wsgi:main'</span></span><br><span class="line">                   ]</span><br><span class="line">            &#125;,</span><br><span class="line">      package_data = &#123;</span><br><span class="line">        <span class="string">''</span>: [<span class="string">'*.html'</span>],</span><br><span class="line">        <span class="string">''</span>: [<span class="string">'*.css'</span>],</span><br><span class="line">        <span class="string">''</span>: [<span class="string">'*.js'</span>],</span><br><span class="line">        <span class="string">''</span>: [<span class="string">'static/*'</span>],</span><br><span class="line">        <span class="string">''</span>: [<span class="string">'templates/*'</span>],</span><br><span class="line">      &#125;,</span><br><span class="line">      py_modules=[<span class="string">'myflask'</span>],</span><br><span class="line">      packages=find_namespace_packages(),</span><br><span class="line">      zip_safe=<span class="literal">False</span>,</span><br><span class="line">      include_package_data=<span class="literal">True</span>,</span><br><span class="line">      )</span><br></pre></td></tr></table></figure>
<p>我这里定义了安装模块，myflask,可以被uwsgi 文件引入，方便管理， 同时也加入了很多html的静态文件， 是一个完整的网站  </p>
<ol>
<li><p>生成sdist包， 在项目目录执行<code>python setup.py sdist</code>，可以在sdit目录看到tar包</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># myflask &gt; ls dist                                                                                                                                                                                                      </span></span><br><span class="line">myflask-1.3.tar.gz</span><br></pre></td></tr></table></figure>
</li>
<li><p>生成wheel包，在项目目录执行<code>python setup.py bdist_wheel</code>，可以在sdit目录看到whl包</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># myflask &gt; ls dist</span><br><span class="line">myflask-1.3-py3-none-any.whl  myflask-1.3.tar.gz</span><br></pre></td></tr></table></figure>

</li>
</ol>
<h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><p>安装命令相同，<code>pip install myflask-1.3.tar.gz</code> <code>pip instal myflask-1.3-py3-none-any.whl</code>。但过程不同</p>
<p>举例安装yarl 的源码包, 源码包需要编译，如果环境没有gcc,就会安装失败</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">Collecting yarl&lt;2.0,&gt;&#x3D;1.0 (from aiohttp&#x3D;&#x3D;3.6.2)</span><br><span class="line">  Downloading yarl-1.6.2.tar.gz (177kB)</span><br><span class="line">  Installing build dependencies: started</span><br><span class="line">  Installing build dependencies: finished with status &#39;done&#39;</span><br><span class="line">  Getting requirements to build wheel: started</span><br><span class="line">  Getting requirements to build wheel: finished with status &#39;done&#39;</span><br><span class="line">    Preparing wheel metadata: started</span><br><span class="line">    Preparing wheel metadata: finished with status &#39;done&#39;</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">  gcc -pthread -Wno-unused-result -Wsign-compare -DNDEBUG -g -fwrapv -O3 -Wall -fPIC -I&#x2F;opt&#x2F;ha&#x2F;include&#x2F;python3.8 -c yarl&#x2F;_quoting_c.c -o build&#x2F;temp.linux-x86_64-3.8&#x2F;yarl&#x2F;_quoting_c.o</span><br><span class="line">  error: command &#39;gcc&#39; failed with exit status 1</span><br><span class="line">  ----------------------------------------</span><br><span class="line">  ERROR: Failed building wheel for yarl</span><br><span class="line">  Running setup.py clean for yarl</span><br><span class="line">Failed to build yarl</span><br></pre></td></tr></table></figure>

<p>此时，如果使用wheel包就不会出问题，但如果wheel包里面依赖了二进制文件，则需要区分cpu架构和系统了<br>我的myflask不依赖任何二进制文件，所以是none, 所有cpu和系统都可以安装  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">myflask-1.3-py3-none-any.whl</span><br></pre></td></tr></table></figure>
<p>对于yarl不同， 在pypi.org 下载时，需要选择正确的包。或者选择源码包<code>yarl-1.6.2.tar.gz</code>来安装编译  </p>
<p>当然如果让pip选择在线安装就不需要考虑， 他会自动帮你寻找对应你系统的版本</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">Download files</span><br><span class="line"></span><br><span class="line">Download the file for your platform. If you&#39;re not sure which to choose, learn more about installing packages.</span><br><span class="line">Files for yarl, version 1.6.2</span><br><span class="line">Filename, size 	File type 	Python version 	Upload date 	Hashes</span><br><span class="line">yarl-1.6.2-cp36-cp36m-macosx_10_14_x86_64.whl (128.3 kB) 	Wheel 	cp36 	Oct 13, 2020 	View</span><br><span class="line">yarl-1.6.2-cp36-cp36m-manylinux1_i686.whl (293.5 kB) 	Wheel 	cp36 	Oct 13, 2020 	View</span><br><span class="line">yarl-1.6.2-cp36-cp36m-manylinux2014_aarch64.whl (294.5 kB) 	Wheel 	cp36 	Oct 13, 2020 	View</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">yarl-1.6.2.tar.gz (177.5 kB) 	Source 	None 	Oct 13, 2020 	View</span><br></pre></td></tr></table></figure>


      
    </div>
    <footer class="article-footer">
      <a data-url="https://energygreek.github.io/2020/11/10/python-package/" data-id="ckp6c7amz001ad1ok7u1hhtwe" data-title="python package" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/python-%E5%8C%85%E7%AE%A1%E7%90%86/" rel="tag">python 包管理</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-system-calls-method" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2020/11/09/system-calls-method/" class="article-date">
  <time class="dt-published" datetime="2020-11-09T08:13:11.000Z" itemprop="datePublished">2020-11-09</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2020/11/09/system-calls-method/">system calls method</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>之前学汇编发现教材和实际的有出入， 书上写的int, 但是汇编不通过，而gcc 反汇编的结果是调用syscall。<br>原来这是两种方式调用方式即： int  0x80 和 syscall  </p>
<p>除此之外还有一个名词是vdso,  很多elf文件会链接这个vdso库</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ldd a.out                                                                                                                                                                                                                   √ 19:03:30 </span><br><span class="line">	linux-vdso.so.1 (0x00007fffb3de0000)</span><br><span class="line">	libc.so.6 &#x3D;&gt; &#x2F;usr&#x2F;lib&#x2F;libc.so.6 (0x00007f5b48d4a000)</span><br><span class="line">	&#x2F;lib64&#x2F;ld-linux-x86-64.so.2 &#x3D;&gt; &#x2F;usr&#x2F;lib64&#x2F;ld-linux-x86-64.so.2 (0x00007f5b48f36000)</span><br></pre></td></tr></table></figure>

<h2 id="词汇说明"><a href="#词汇说明" class="headerlink" title="词汇说明"></a>词汇说明</h2><p><code>int 0x80</code> 即80中断， 是最老的系统函数调用方式<br><code>syscall/sysret</code> 是amd64 制定的标准， 也是目前的x86 64位的标准，即<code>amd64</code><br><code>sysenter/syssysexit</code> 是inter制定的x86 64位标准， 目前已被放弃<br><code>vdso</code> 是linux内核虚拟出的so, 实现了int 80 和 syscall，调用方式为 <code>vsyscall</code></p>
<h2 id="系统函数调用路径"><a href="#系统函数调用路径" class="headerlink" title="系统函数调用路径"></a>系统函数调用路径</h2><p>系统调用多被封装成库函数提供给应用程序调用，应用程序调用库函数后，由 glibc 库负责进入内核调用系统调用函数。<br>即<code>用户函数-&gt; glibc -&gt; 系统调用</code></p>
<h2 id="int-0x80"><a href="#int-0x80" class="headerlink" title="int 0x80"></a>int 0x80</h2><p>int 即是interrupt 中断， 0x80是IDT上注册的中断向量， 每个编号对应一个处理函数handle， linux的0x80的handle即是内核，即系统调用。<br>所以不同的系统设置的0x80的handle可能不同</p>
<p>调用方式：首先是将参数复制到寄存器， 参数包括系统调用编号和传入参数，然后执行 init  0x80<br>例如，以下的进程退出的系统调用</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">.data</span><br><span class="line">    s:</span><br><span class="line">        .ascii &quot;hello world\n&quot;</span><br><span class="line">        len &#x3D; . - s</span><br><span class="line">.text</span><br><span class="line">    .global _start</span><br><span class="line">    _start:</span><br><span class="line"></span><br><span class="line">        movl $4, %eax   &#x2F;* write system call number *&#x2F;</span><br><span class="line">        movl $1, %ebx   &#x2F;* stdout *&#x2F;</span><br><span class="line">        movl $s, %ecx   &#x2F;* the data to print *&#x2F;</span><br><span class="line">        movl $len, %edx &#x2F;* length of the buffer *&#x2F;</span><br><span class="line">        int $0x80</span><br><span class="line"></span><br><span class="line">        movl $1, %eax   &#x2F;* 退出的系统调用编号 *&#x2F;</span><br><span class="line">        movl $0, %ebx   &#x2F;* exit status *&#x2F;</span><br><span class="line">        int $0x80</span><br></pre></td></tr></table></figure>

<h2 id="vdos"><a href="#vdos" class="headerlink" title="vdos"></a>vdos</h2><p>vdos即 linux-vdso.so.1， 几乎很多elf 都会链接这个库，但其实他并不是真实存在的so文件，<br>而是由内核虚拟的文件，再映射到用户的进程来调用。</p>
<p>vdos  是对以下几个函数的实现，称作快速调用</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">#define __NR_gettimeofday 96 &#x2F;&#x2F;0x60</span><br><span class="line">#define __NR_time 201 &#x2F;&#x2F;0xc9</span><br><span class="line">#define __NR_clock_gettime 228 &#x2F;&#x2F;0xE4</span><br><span class="line">#define __NR_getcpu 309 &#x2F;&#x2F;0x135</span><br></pre></td></tr></table></figure>

<h2 id="对比"><a href="#对比" class="headerlink" title="对比"></a>对比</h2><p>所以以上总结其实就3种方式， int ，syscall/sysret ， vdso</p>
<p>int 0x80 方式很慢，所以出现了syscall 即快速调用</p>
<p>执行区别</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">在 x86 保护模式中，处理 INT 中断指令时，CPU 首先从中断描述表 IDT 取出对应的门描述符，判断门描述符的种类，然后检查门描述符的级别 DPL 和 INT 指令调用者的级别 CPL，当 CPL&lt;&#x3D;DPL 也就是说 INT 调用者级别高于描述符指定级别时，才能成功调用，最后再根据描述符的内容，进行压栈、跳转、权限级别提升。内核代码执行完毕之后，调用 IRET 指令返回，IRET 指令恢复用户栈，并跳转会低级别的代码。</span><br><span class="line"></span><br><span class="line">其实，在发生系统调用，由 Ring3 进入 Ring0 的这个过程浪费了不少的 CPU 周期，例如，系统调用必然需要由 Ring3 进入 Ring0（由内核调用 INT 指令的方式除外，这多半属于 Hacker 的内核模块所为），权限提升之前和之后的级别是固定的，CPL 肯定是 3，而 INT 80 的 DPL 肯定也是 3，这样 CPU 检查门描述符的 DPL 和调用者的 CPL 就是完全没必要。正是由于如此，Intel x86 CPU 从 PII 300（Family 6，Model 3，Stepping 3）之后，开始支持新的系统调用指令 sysenter&#x2F;sysexit。sysenter 指令用于由 Ring3 进入 Ring0，SYSEXIT 指令用于由 Ring0 返回 Ring3。由于没有特权级别检查的处理，也没有压栈的操作，所以执行速度比 INT n&#x2F;IRET 快了不少。</span><br></pre></td></tr></table></figure>

<p>返回的区别</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">在 Intel 的手册中，还提到了 sysenter&#x2F;sysexit 和 int n&#x2F;iret 指令的一个区别，那就是 sysenter&#x2F;sysexit 指令并不成对，sysenter 指令并不会把 SYSEXIT 所需的返回地址压栈，sysexit 返回的地址并不一定是 sysenter 指令的下一个指令地址。调用 sysenter&#x2F;sysexit 指令地址的跳转是通过设置一组特殊寄存器实现的。</span><br></pre></td></tr></table></figure>

<p>vdos的局限（syscall）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">而&quot;快速系统调用指令&quot;比起中断方式的系统调用方式，还存在一定局限，例如无法在一个系统调用处理过程中再通过&quot;快速系统调用指令&quot;调用别的系统调用。因此，并不一定每个系统调用都需要通过&quot;快速系统调用指令&quot;来实现。比如，对于复杂的系统调用例如 fork，两种系统调用方式的时间差和系统调用本身运行消耗的时间来比，可以忽略不计，此处采取&quot;快速系统调用指令&quot;方式没有什么必要。而真正应该使用&quot;快速系统调用指令&quot;方式的，是那些本身运行时间很短，对时间精确性要求高的系统调用，例如 getuid、gettimeofday 等等。</span><br></pre></td></tr></table></figure>

<h2 id="最后总结"><a href="#最后总结" class="headerlink" title="最后总结"></a>最后总结</h2><p>int 是最老的方式，目前用amd64的 syscall 方式， 而vdso是基于syscall实现的快速调用。<br>只有在调用clock_gettime、gettimeofday、getcpu、time这些系统调用时，才会使用vdso，其他系统调用是通过syscall实现的</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://energygreek.github.io/2020/11/09/system-calls-method/" data-id="ckp6c7and001xd1okgxq4hsrb" data-title="system calls method" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/linux-%E7%B3%BB%E7%BB%9F%E8%B0%83%E7%94%A8/" rel="tag">linux 系统调用</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-huawei-unlock-bootloader" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2020/11/05/huawei-unlock-bootloader/" class="article-date">
  <time class="dt-published" datetime="2020-11-05T08:01:42.000Z" itemprop="datePublished">2020-11-05</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2020/11/05/huawei-unlock-bootloader/">huawei unlock bootloader</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="目的"><a href="#目的" class="headerlink" title="目的"></a>目的</h1><p>解锁华为平板M3的BL锁，以及获取root权限</p>
<h1 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h1><p>我有一个华为平板M3，WIFI版, 型号BTV-W09，系统是emui5， 买来没什么用，最大的功能就是看视频。 偶尔发现一个app，LinuxDeploy, 可以在安卓上安装完整的Linux系统，而不是内置的阉割版， 前提是获得root权限。</p>
<h1 id="步骤"><a href="#步骤" class="headerlink" title="步骤"></a>步骤</h1><p>全部步骤分4个：   </p>
<ol>
<li>解BL</li>
<li>刷入recovery 也就是RTWP</li>
<li>将root压缩包复制到平板，在RTWP下安装</li>
<li>安装supersu 的apk</li>
<li>可选刷入xposed框架，并安装xposed manager，步骤参考3,4</li>
</ol>
<h2 id="解锁"><a href="#解锁" class="headerlink" title="解锁"></a>解锁</h2><p>因为华为官方停止申请解锁BL的服务， 所以需要上淘宝找人帮你搞定。 解锁BL之后， 在关机状态按住电源和音量减，进入fastboot模式时，有红字提示unlocked</p>
<h2 id="刷入rec"><a href="#刷入rec" class="headerlink" title="刷入rec"></a>刷入rec</h2><p>找到与设备型号对应的rec非常重要，因为型号不对会刷不进去，我尝试了很多个版本，最终在华为论坛找到了。<br>有了rec后， 让手机处于fastboot状态， 连接手机到电脑，使用 <code>fastboot flash recovery rec</code> 来刷入 ，提书刷入成功之后，可能自动重启，如果没有重启，长按电源键强制关机。<br>关机状态下， 按住电源键和音量+，进入recovery ， 能看到RTWP的界面说明输入成功，如果没有看到RTWP,而是进入华为官方的eRecovery 表示失败，又可能是被华为覆盖了。<br>一旦能进入RTWP, 那么RTWP会自动安装，以后就不用担心被覆盖的问题。</p>
<h2 id="刷入root工具"><a href="#刷入root工具" class="headerlink" title="刷入root工具"></a>刷入root工具</h2><p>将root.zip 拷贝到平板的储存卡目录，进入RTWP，点INSTALL,  然后选择root.zip 就会开始安装了， 安装后再安装supersu 的应用</p>
<p>这样就root成功了， 所以步骤很简单，找到对应机型的rec 很关键。 </p>
<h2 id="刷入xposed"><a href="#刷入xposed" class="headerlink" title="刷入xposed"></a>刷入xposed</h2><p>xposed 很强大，但是xposed只是个框架，需要安装包来实现对app的hack。但是我安装完，没发现什么很强大包，感觉也没什么用。 </p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://energygreek.github.io/2020/11/05/huawei-unlock-bootloader/" data-id="ckp6c7aml000pd1ok4goy2hr0" data-title="huawei unlock bootloader" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/misc/" rel="tag">misc</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-Install-KVM-on-Debian-of-aarch64-architecture" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2020/10/30/Install-KVM-on-Debian-of-aarch64-architecture/" class="article-date">
  <time class="dt-published" datetime="2020-10-30T08:29:37.000Z" itemprop="datePublished">2020-10-30</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2020/10/30/Install-KVM-on-Debian-of-aarch64-architecture/">Install KVM on Debian of aarch64 architecture </a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h1><p>公司有台arm64位的设备，安装的银河麒麟系统，经验证就是debian 9。<br>现在需要运行更多arm64虚拟机。</p>
<h1 id="安装步骤"><a href="#安装步骤" class="headerlink" title="安装步骤"></a>安装步骤</h1><h2 id="配置免密sudoer"><a href="#配置免密sudoer" class="headerlink" title="配置免密sudoer"></a>配置免密sudoer</h2><p>这里记一个坑， 第一次配置时拼写错误，导致sudo 命令执行失败。需要重置密码，所以很麻烦。<br>然后推荐使用 <code>sudo visudo</code> 命令来修改sudoer配置文件，这个命令在编辑结束后校验配置文件，避免出现编辑错误导致无法使用sudo的情况。  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kylin@Kylin:~$ cat &#x2F;etc&#x2F;sudoers.d&#x2F;kylin </span><br><span class="line">kylin	ALL&#x3D;(ALL:ALL) NOPASSWD:ALL</span><br></pre></td></tr></table></figure>

<h2 id="配置软件源"><a href="#配置软件源" class="headerlink" title="配置软件源"></a>配置软件源</h2><p>第一个是本地iso, 下面的是中科大的镜像源。 每个都设置了trust免校验gpg</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">deb [trusted&#x3D;yes] file:&#x2F;&#x2F;&#x2F;mnt&#x2F;iso&#x2F; juniper main multiverse restricted universe</span><br><span class="line">deb [trusted&#x3D;yes] http:&#x2F;&#x2F;ftp.cn.debian.org&#x2F;debian&#x2F; stretch main contrib non-free</span><br><span class="line">deb [trusted&#x3D;yes] http:&#x2F;&#x2F;ftp.cn.debian.org&#x2F;debian&#x2F; stretch-updates main contrib non-free</span><br><span class="line">deb [trusted&#x3D;yes] http:&#x2F;&#x2F;mirrors.ustc.edu.cn&#x2F;debian-security&#x2F; stretch&#x2F;updates main contrib non-free</span><br><span class="line">deb [trusted&#x3D;yes] http:&#x2F;&#x2F;ftp.cn.debian.org&#x2F;debian&#x2F; stretch-backports main contrib non-free</span><br></pre></td></tr></table></figure>

<h2 id="安装虚拟工具"><a href="#安装虚拟工具" class="headerlink" title="安装虚拟工具"></a>安装虚拟工具</h2><p>安装 qemu, libvirt, virt-manager</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt install  qemu  libvirt virt-manager</span><br></pre></td></tr></table></figure>

<h2 id="libvirt-没有网络"><a href="#libvirt-没有网络" class="headerlink" title="libvirt 没有网络"></a>libvirt 没有网络</h2><p>执行<code>virsh net-list -all</code> 发现default 网络处于未激活状态， 于是执行 <code>systemctl status libvirtd</code> 发现</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">10月 30 15:46:27 Kylin libvirtd[16741]: 2020-10-30 07:46:27.262+0000: 16764: error : virFileReadAll:1420 : 打开文件 &#39;&#x2F;sys&#x2F;class&#x2F;net&#x2F;virbr0-nic&#x2F;operstate&#39; 失败: 没有那个文件或目录</span><br><span class="line">10月 30 15:46:27 Kylin libvirtd[16741]: 2020-10-30 07:46:27.262+0000: 16764: error : virNetDevGetLinkInfo:2530 : unable to read: &#x2F;sys&#x2F;class&#x2F;net&#x2F;virbr0-nic&#x2F;operstate: 没有那个文件或目录</span><br><span class="line">10月 30 15:46:54 Kylin libvirtd[16741]: 2020-10-30 07:46:54.710+0000: 16745: error : virFirewallApply:916 : 内部错误：Failed to initialize a valid firewall backend</span><br></pre></td></tr></table></figure>
<p>需要安装以下组件，然后重启libvirtd，这是因为libvirt的网络依赖这几个组件来创建nat 网络</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo apt install ebtables iptables dnsmasq</span><br><span class="line">systemctl restart libvirtd</span><br></pre></td></tr></table></figure>

<h2 id="virt-manager-提示aarch64-安装-uefi-错误"><a href="#virt-manager-提示aarch64-安装-uefi-错误" class="headerlink" title="virt-manager 提示aarch64 安装 uefi 错误"></a>virt-manager 提示aarch64 安装 uefi 错误</h2><p>直接安装 qemu-efi</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">apt install qemu-efi</span><br></pre></td></tr></table></figure>

<h2 id="virt-manager-允许非root用户访问"><a href="#virt-manager-允许非root用户访问" class="headerlink" title="virt-manager 允许非root用户访问"></a>virt-manager 允许非root用户访问</h2><p>因为当以普通用户运行 virt-manager 时，qemu的连接指向非qemu:///system， 这时看到的虚拟机和root看到的不一样，所以必须使用sudo运行。<br>通过修改配置来启用普通用户也访问<code>qemu:///system</code>， 将uri_defualt 的注释去掉。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">vim &#x2F;etc&#x2F;libvirt&#x2F;libvirt.conf </span><br><span class="line"></span><br><span class="line">#</span><br><span class="line"># These can be used in cases when no URI is supplied by the application</span><br><span class="line"># (@uri_default also prevents probing of the hypervisor driver).</span><br><span class="line">#</span><br><span class="line">uri_default &#x3D; &quot;qemu:&#x2F;&#x2F;&#x2F;system&quot;</span><br></pre></td></tr></table></figure>


<h1 id="这样就可以使用virt-manager来创建虚拟机了，跟x86的使用一样。"><a href="#这样就可以使用virt-manager来创建虚拟机了，跟x86的使用一样。" class="headerlink" title="这样就可以使用virt-manager来创建虚拟机了，跟x86的使用一样。"></a>这样就可以使用virt-manager来创建虚拟机了，跟x86的使用一样。</h1><p>顺便记一下vnc的配置， 因为机器在机房里， 通过tigervnc来使用桌面。<br>另外提示一下，virt-manager 配置好后，可以直接连接远程的virt-manager,非常方便。</p>
<p>使用tigervnc 连接需要在远程主机安装 tigervnc-server 和 tigervnc-password。<br>使用普通用户执行 <code>tigervnc-password</code> 设置访问密码，然后直接执行<code>tigervnc-server</code>。</p>
<p>这时候vnc只接受本地连接， 如果远程访问，要使用ssh 本地转发来实现。 这也是vnc推荐的方式。</p>
<p>现在本地允许本地转发命令， 监听本地端口 9302, 转发到远程的 9300</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh -L 9302:localhost:9300   -N -f  ssh-kylin</span><br></pre></td></tr></table></figure>

<p>然后执行 <code>vncviewer  127.0.0.1:9302</code> ，输入密码就能打开远程桌面了。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://energygreek.github.io/2020/10/30/Install-KVM-on-Debian-of-aarch64-architecture/" data-id="ckp6c7als0000d1ok0g3r9at3" data-title="Install KVM on Debian of aarch64 architecture " class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/aarch64/" rel="tag">aarch64</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-lvm-snapshot" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2020/10/22/lvm-snapshot/" class="article-date">
  <time class="dt-published" datetime="2020-10-22T08:01:53.000Z" itemprop="datePublished">2020-10-22</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2020/10/22/lvm-snapshot/">lvm snapshot</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="LVM-快照功能"><a href="#LVM-快照功能" class="headerlink" title="LVM 快照功能"></a>LVM 快照功能</h1><p>当系统是安装在LVM文件系统之上，那么当需要进行高危操作的时候，可以先对分区进行快照备份，避免操作失败又无法恢复。<br>公司有一台centos7的自用系统， 需要升级到Centos8 以支持 Docker buildx。<br>虽然因操作到无法运行yum,dnf 时宣布失败，但好在有snapshot备份， 恢复后完好如初，太好用。</p>
<h2 id="步骤"><a href="#步骤" class="headerlink" title="步骤"></a>步骤</h2><ol>
<li>挂载如下</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ lsblk </span><br><span class="line">NAME                  MAJ:MIN RM   SIZE RO TYPE  MOUNTPOINT</span><br><span class="line">sda                     8:0    0   477G  0 disk  </span><br><span class="line">├─sda1                  8:1    0   200M  0 part  /boot/efi</span><br><span class="line">├─sda2                  8:2    0     1G  0 part  /boot</span><br><span class="line">└─sda3                  8:3    0 475.8G  0 part  </span><br><span class="line">  ├─centos-root       253:2    0    50G  0 lvm   /</span><br><span class="line">  ├─centos-swap       253:4    0  15.7G  0 lvm   [SWAP]</span><br><span class="line">  ├─centos-docker     253:18   0   150G  0 lvm   /var/lib/docker</span><br></pre></td></tr></table></figure>

<p>根分区为50G, 而卷组还剩余160G,完全足够生成一个镜像，50G并未完全使用。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ sudo vgs</span><br><span class="line">  VG     #PV #LV #SN Attr   VSize   VFree   </span><br><span class="line">  centos   1   4   0 wz--n- 475.74g  160.05g</span><br><span class="line">  data     1  13   0 wz--n-  &lt;7.28t &lt;721.91g</span><br></pre></td></tr></table></figure>

<ol start="2">
<li><p>我先对根分区进行快照，注意是<code>根分区</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># lvcreate -s -n &lt;snapshot_name&gt; -L &lt;size&gt; &lt;logical_volume&gt;</span><br><span class="line"></span><br><span class="line">$ lvcreate -s -n backup -L 50G  &#x2F;dev&#x2F;centos&#x2F;root</span><br></pre></td></tr></table></figure>
<p>这里指定了快照的大小为50G, 理论上是要比源分区大， 这里也可以直接设置100G, 系统会自动调整大小到合适。</p>
</li>
<li><p>进行一顿操作后， 进行恢复, 提示根分区正在使用， 重启后生效。</p>
</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ lvconvert --mergesnapshot &#x2F;dev&#x2F;centos&#x2F;backup </span><br><span class="line">  Delaying merge since origin is open.</span><br><span class="line">  Merging of snapshot centos&#x2F;backup will occur on next activation of centos&#x2F;root.</span><br></pre></td></tr></table></figure>

<h2 id="保存"><a href="#保存" class="headerlink" title="保存"></a>保存</h2><p>如果需要对快照进行备份到其他位置， 可以直接将快照分区挂载，然后通过tarball 来压缩。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tar -cvzf backup.tar.gz &#x2F;mnt&#x2F;lv_snapshot</span><br></pre></td></tr></table></figure>

<p>还可以直接通过rsync 将挂载的snapshort 传输到其他服务器上</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rsync -aPh &#x2F;mnt&#x2F;lv_snapshot  &lt;remote_user&gt;@&lt;destination_server&gt;:&lt;remote_destination&gt;</span><br></pre></td></tr></table></figure>

<h2 id="最后"><a href="#最后" class="headerlink" title="最后"></a>最后</h2><p>lvm的snapshort 也是写时复制的（copy on write），所以创建快照操作非常快，<br>当分区进行删除和修改操作的时候， lvm文件系统会拷贝文件到其他地方保存。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://energygreek.github.io/2020/10/22/lvm-snapshot/" data-id="ckp6c7amq000wd1okamri17n4" data-title="lvm snapshot" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/lvm/" rel="tag">lvm</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-Linux-Interrupts" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2020/10/19/Linux-Interrupts/" class="article-date">
  <time class="dt-published" datetime="2020-10-19T08:15:16.000Z" itemprop="datePublished">2020-10-19</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2020/10/19/Linux-Interrupts/">Linux Interrupts</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="Linux-中断请求"><a href="#Linux-中断请求" class="headerlink" title="Linux 中断请求"></a>Linux 中断请求</h1><p>中断请求的英文是IRQ（Interrupt Request）,是用来驱动CPU正常工作的重要机制。 中断根据源头分类成：<br>由外设发出的硬件中断，软件发出的软中断，以及异常组成。</p>
<p>以前，每个外设都连接一根线到PIC(programmable Interrupt circuit)芯片，有PIC芯片来发生数据到CPU,并将CPU的INTR引脚置位。<br>现在，CPU集成了PIC成为APIC(Advanced PIC)。</p>
<h2 id="中断分类"><a href="#中断分类" class="headerlink" title="中断分类"></a>中断分类</h2><p>中断分为3类型</p>
<h3 id="硬件中断"><a href="#硬件中断" class="headerlink" title="硬件中断"></a>硬件中断</h3><p>鼠标和键盘，还有IO设备都会发出硬件中断，例如网卡的数据到了，就会出发中断请求（IRQ），<br>这个请求会触发CPU去执行ISR, 而这个ISR需要在系统启动的时候注册的。一个Vector表。</p>
<h2 id="软件中断"><a href="#软件中断" class="headerlink" title="软件中断"></a>软件中断</h2><p>当播放电影的时候，声音和画面的同步非常重要，这是由系统的定时器<a href="https://elinux.org/Kernel_Timer_Systems" target="_blank" rel="noopener">jiffies</a>来不停地调度声音播放器来准确播放对应的声音。<br>软中断在实时操作系统的作用也非常重要。</p>
<h3 id="异常中断"><a href="#异常中断" class="headerlink" title="异常中断"></a>异常中断</h3><p>异常中断又分为3类： 缺页异常(Faults)，陷入异常(Traps)，异常退出(Aborts)</p>
<p>例如当程序的内存被swap到硬盘了或者一段动态链接库还没有载入到内存里来，在程序走到这个位置之前，<br>程序就会提前发出缺页异常，当系统检查了权限和地址有效后（地址有效表示在逻辑地址范围内），<br>CPU开始为程序执行加载需要的数据，并清除这个异常。 所以这个异常是可以修正的，这个请求必须提前发出。</p>
<p>当GDB调试的时，设置断点会插入一条特殊的指令到程序里，当执行到断点位置就会出发Traps请求，软件的主导权由CPU交给GDB。</p>
<p>当程序触发一个异常例如0/0时，会出发退出异常，由cpu来清理堆栈。</p>
<h2 id="请求的可阻塞性"><a href="#请求的可阻塞性" class="headerlink" title="请求的可阻塞性"></a>请求的可阻塞性</h2><p>对于硬件中断请求，CPU的决策是立即执行，对于软中断和异常，CPU采用尽量延后的策略。</p>
<h2 id="查看系统的中断"><a href="#查看系统的中断" class="headerlink" title="查看系统的中断"></a>查看系统的中断</h2><p>在中断执行 <code>watch -n1 &quot;cat /proc/interrupts&quot;</code>可以定时更新中断的次数</p>
<p>列的含义从左至右以此为：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">IRQ vector, interrupt count per CPU (0 .. n), the hardware source, the hardware source&#39;s channel information, and the name of the device that caused the IRQ.</span><br></pre></td></tr></table></figure>



      
    </div>
    <footer class="article-footer">
      <a data-url="https://energygreek.github.io/2020/10/19/Linux-Interrupts/" data-id="ckp6c7alz0001d1okg0km03ws" data-title="Linux Interrupts" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Linux-%E5%86%85%E6%A0%B8%E5%8E%9F%E7%90%86/" rel="tag">Linux 内核原理</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-rhce8-question" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2020/08/29/rhce8-question/" class="article-date">
  <time class="dt-published" datetime="2020-08-29T03:40:56.000Z" itemprop="datePublished">2020-08-29</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2020/08/29/rhce8-question/">rhce8 question</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="记录一下上课笔记"><a href="#记录一下上课笔记" class="headerlink" title="记录一下上课笔记"></a>记录一下上课笔记</h1><ol>
<li>进入nfs，autofs目录卡住，如何退出，应该是进入了D状态 </li>
<li>chrome 需要笔记本插件，js控制插件</li>
<li>修改root密码时，在linux 选项后面添加 rd.break 然后默认进入内核根目录，然后rw重新挂载系统根目录 /sysroot/ </li>
<li>fdisk 设置分区类型: 在创建分区结束后，使用<code>t</code>来标记文件类型, 然后使用<code>L</code>查看类型代码，查找到Linux swap 对应的代码是85</li>
</ol>
<h2 id="RHCIA"><a href="#RHCIA" class="headerlink" title="RHCIA"></a>RHCIA</h2><h3 id="修改了网络信息之后，必须使用nmcli-connection-down和up-connection才会生效"><a href="#修改了网络信息之后，必须使用nmcli-connection-down和up-connection才会生效" class="headerlink" title="修改了网络信息之后，必须使用nmcli connection down和up connection才会生效"></a>修改了网络信息之后，必须使用nmcli connection down和up connection才会生效</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">nmtui connection down Wired_connection1</span><br><span class="line">nmtui connection up Wired_connection1</span><br></pre></td></tr></table></figure>

<h3 id="配置httpd服务时，修改port后，因为port非标准端口，需要用semanage打tag。否则失败，可以查看journeyctl-e-查看到错误信息和解决办法"><a href="#配置httpd服务时，修改port后，因为port非标准端口，需要用semanage打tag。否则失败，可以查看journeyctl-e-查看到错误信息和解决办法" class="headerlink" title="配置httpd服务时，修改port后，因为port非标准端口，需要用semanage打tag。否则失败，可以查看journeyctl -e 查看到错误信息和解决办法"></a>配置httpd服务时，修改port后，因为port非标准端口，需要用semanage打tag。否则失败，可以查看journeyctl -e 查看到错误信息和解决办法</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">semanage port -a -t http_port_t -p tcp 82</span><br></pre></td></tr></table></figure>


<h3 id="创建-home-admins-目录，并设置在目录中创建的文件，其组所有权自动设置为-adminusr。-这里就是设置s位，有数值方法和-法"><a href="#创建-home-admins-目录，并设置在目录中创建的文件，其组所有权自动设置为-adminusr。-这里就是设置s位，有数值方法和-法" class="headerlink" title="创建/home/admins 目录，并设置在目录中创建的文件，其组所有权自动设置为 adminusr。 这里就是设置s位，有数值方法和+-法"></a>创建/home/admins 目录，并设置在目录中创建的文件，其组所有权自动设置为 adminusr。 这里就是设置s位，有数值方法和+-法</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">chmod 2770 &#x2F;home&#x2F;admins</span><br><span class="line"></span><br><span class="line"># 或</span><br><span class="line"></span><br><span class="line">chmod o-x &#x2F;home&#x2F;admins</span><br><span class="line">chmod o-r &#x2F;home&#x2F;admins</span><br><span class="line">chmod g+w &#x2F;home&#x2F;admins</span><br><span class="line">chmod g+s &#x2F;home&#x2F;admins # 这里设置组的s位</span><br></pre></td></tr></table></figure>

<p>验证方法，进入目录创建文件，查看组名</p>
<h3 id="autofs-挂载有两个关键，第一在-etc-auto-master-d-目录下创建后缀名为autofs的文件，-第二是编辑挂载配置文件"><a href="#autofs-挂载有两个关键，第一在-etc-auto-master-d-目录下创建后缀名为autofs的文件，-第二是编辑挂载配置文件" class="headerlink" title="autofs 挂载有两个关键，第一在/etc/auto.master.d/ 目录下创建后缀名为autofs的文件， 第二是编辑挂载配置文件"></a>autofs 挂载有两个关键，第一在/etc/auto.master.d/ 目录下创建后缀名为autofs的文件， 第二是编辑挂载配置文件</h3><p>内容格式</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># cat &#x2F;etc&#x2F;auto.master.d&#x2F;indirect</span><br><span class="line">#主挂载点	挂载配置</span><br><span class="line">&#x2F;internal	&#x2F;etc&#x2F;auto.demo</span><br></pre></td></tr></table></figure>

<p>内容配置，* 表示所有目录（根据nfsserver的情况）， 和&amp;搭配使用</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># cat &#x2F;etc&#x2F;auto.demo</span><br><span class="line"># 间接挂载目录	挂载配置	挂载路径（nfs地址）</span><br><span class="line">*	-rw,fstype&#x3D;nfs4,sync	servera:&#x2F;shares&#x2F;indirect&#x2F;&amp;</span><br></pre></td></tr></table></figure>

<h3 id="setfacl-和getfacl-设置和显示文件属性"><a href="#setfacl-和getfacl-设置和显示文件属性" class="headerlink" title="setfacl 和getfacl 设置和显示文件属性"></a>setfacl 和getfacl 设置和显示文件属性</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">设置natash用户读写权限</span><br><span class="line">setfacl u:natasha:rw	&#x2F;var&#x2F;tmp&#x2F;fstab</span><br><span class="line">设置harry用户没有任何权限 </span><br><span class="line">setfacl u:harry:-	&#x2F;var&#x2F;tmp&#x2F;fstab</span><br></pre></td></tr></table></figure>

<h3 id="重置root密码，在linux-行末追加-rd-local-按ctrl-x-启动"><a href="#重置root密码，在linux-行末追加-rd-local-按ctrl-x-启动" class="headerlink" title="重置root密码，在linux 行末追加 rd.local, 按ctrl+x 启动"></a>重置root密码，在linux 行末追加 rd.local, 按ctrl+x 启动</h3><p>重新挂载系统根目录, chroot到根目录和修改密码</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mount -orw,remount &#x2F;systemroot&#x2F;</span><br><span class="line">chroot &#x2F;systemroot&#x2F;</span><br><span class="line">passwd</span><br></pre></td></tr></table></figure>

<h3 id="逻辑卷扩容"><a href="#逻辑卷扩容" class="headerlink" title="逻辑卷扩容"></a>逻辑卷扩容</h3><p>设置分区start位置的时候，输入2048s。 s指扇区，一个扇区为512字节， 2048s指1M，这1M的分区为esp分区</p>
<p>扩容命令lvextrend，这个扩容只是将逻辑卷扩容， 而题目要求对文件系统扩容， 还需要执行文件系统类型对应的扩容命令如resize2fs(ext), xfs_growfs(xfs)。<br>但对lvextend命令添加 -r 参数可以一步到位</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 扩容到300MB</span><br><span class="line">lvextend -r -L 300MB &#x2F;dev&#x2F;new_redhat&#x2F;lv1</span><br></pre></td></tr></table></figure>

<h3 id="创建逻辑分区-注意避免磁盘不够用，尽量共用上一题的磁盘。而且创建卷组的时候不要忘记-s参数"><a href="#创建逻辑分区-注意避免磁盘不够用，尽量共用上一题的磁盘。而且创建卷组的时候不要忘记-s参数" class="headerlink" title="创建逻辑分区, 注意避免磁盘不够用，尽量共用上一题的磁盘。而且创建卷组的时候不要忘记-s参数"></a>创建逻辑分区, 注意避免磁盘不够用，尽量共用上一题的磁盘。而且创建卷组的时候不要忘记-s参数</h3><p>题目可能不是直接给分区大小，而是给出扩展块大小和拓展块个数，其实分区大小=拓展块大小 × 拓展块个数。 在lvcreate -l 来指定块个数 </p>
<p>这时必须使用msdos分区类型才有主分区和拓展分区，而且为拓展分区分配剩余的所有空间。 最后在拓展分区上创建逻辑分区， 并将创建的逻辑分区加入卷组</p>
<p>创建分区，大小通过上面的算法计算出来</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">parted </span><br><span class="line">mkpart</span><br><span class="line">print</span><br><span class="line">exit</span><br></pre></td></tr></table></figure>

<p>创建卷组</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vgcreate -s 20MB -n npgroup &#x2F;dev&#x2F;vdb2</span><br></pre></td></tr></table></figure>
<p>创建逻辑卷, 注意是小写l</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lvcreate -l 45 -n np npgroup</span><br></pre></td></tr></table></figure>
<p>这样就创建了一个 20×45 = 900MB的逻辑卷</p>
<h3 id="创建新的swap分区，注意需要修改fstab-而且验证的时候，不需要重启系统，而是执行"><a href="#创建新的swap分区，注意需要修改fstab-而且验证的时候，不需要重启系统，而是执行" class="headerlink" title="创建新的swap分区，注意需要修改fstab, 而且验证的时候，不需要重启系统，而是执行"></a>创建新的swap分区，注意需要修改fstab, 而且验证的时候，不需要重启系统，而是执行</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">systemctl daemon-reload </span><br><span class="line">swapon -a  # 类似mount -a</span><br><span class="line">swapon --show</span><br></pre></td></tr></table></figure>

<h3 id="vdo-–vdoLogicalSize-5G-不能使用GB"><a href="#vdo-–vdoLogicalSize-5G-不能使用GB" class="headerlink" title="vdo  –vdoLogicalSize 5G, 不能使用GB"></a>vdo  –vdoLogicalSize 5G, 不能使用GB</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vdo create --name test --vdoLogicalSize 5G --device &#x2F;dev&#x2F;vdb</span><br></pre></td></tr></table></figure>
<p><code>blkid</code> 查到 UUID, 最后添加到fstab</p>
<h3 id="vdo-持久挂载-mount"><a href="#vdo-持久挂载-mount" class="headerlink" title="vdo 持久挂载 mount"></a>vdo 持久挂载 mount</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">default,x-systemd.requires&#x3D;vdo.service</span><br></pre></td></tr></table></figure>

<h2 id="RHCE"><a href="#RHCE" class="headerlink" title="RHCE"></a>RHCE</h2><p>ansible的有用命令<br>ansbile-doc -l | grep  查找模块和介绍<br>ansible-doc 模块 查看模块具体说明</p>
<h3 id="创建inventory-文件，-子组的写法为"><a href="#创建inventory-文件，-子组的写法为" class="headerlink" title="创建inventory 文件， 子组的写法为"></a>创建inventory 文件， 子组的写法为</h3><p>[webservices:children]<br>prod</p>
<p>prod 是webserverices组的子组</p>
<h3 id="创建ansible-cfg-文件，可以复制-etc-ansbile-ansible-cfg-到～-ansbile-目录下"><a href="#创建ansible-cfg-文件，可以复制-etc-ansbile-ansible-cfg-到～-ansbile-目录下" class="headerlink" title="创建ansible.cfg 文件，可以复制 /etc/ansbile/ansible.cfg 到～/ansbile/目录下"></a>创建ansible.cfg 文件，可以复制 /etc/ansbile/ansible.cfg 到～/ansbile/目录下</h3><p>容易忘记的选项是远程登陆身份， 即配置 remote_user = devops<br>如果环境没有配置免密登陆，需要在[defaults] 栏添加 <code>ask_pass = True</code></p>
<p>验证方法 <code>ansible all -m ping</code></p>
<h3 id="ansbile-ad-hoc-添加yum-源-ansible-模块的使用方法-ansible-主机名-m-模块-a-‘参数’"><a href="#ansbile-ad-hoc-添加yum-源-ansible-模块的使用方法-ansible-主机名-m-模块-a-‘参数’" class="headerlink" title="ansbile ad-hoc 添加yum 源  ansible 模块的使用方法 ansible 主机名 -m 模块 -a ‘参数’"></a>ansbile ad-hoc 添加yum 源  ansible 模块的使用方法 ansible 主机名 -m 模块 -a ‘参数’</h3><p>脚本要添加可执行权限</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 先要切换到工作目录</span></span><br><span class="line"><span class="built_in">cd</span> /home/devops/ansible/</span><br><span class="line"></span><br><span class="line">ansible all -m yum-repository  -a <span class="string">'name=  description=  baseurl=  enabled= gpgcheck= gpgkey= '</span></span><br></pre></td></tr></table></figure>

<h3 id="安装软件包"><a href="#安装软件包" class="headerlink" title="安装软件包"></a>安装软件包</h3><p>安装软件包如’Development Tools’, 需要在包名前面加‘@’即 ‘@Development Tools’<br>验证yaml 语法格式: <code>ansible-playbook --syntax-check *.yml</code></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">install</span>  <span class="string">development</span> <span class="string">tools</span></span><br><span class="line">  <span class="attr">hosts:</span> <span class="string">dev</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">install</span> <span class="string">development</span> <span class="string">tools</span></span><br><span class="line">        <span class="attr">yum:</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">"@Development Tools"</span></span><br><span class="line">          <span class="attr">state:</span> <span class="string">present</span></span><br></pre></td></tr></table></figure>

<h3 id="同步时间依赖角色，安装角色包’rhel-system-roles’-需要在配置文件里添加上roles路径"><a href="#同步时间依赖角色，安装角色包’rhel-system-roles’-需要在配置文件里添加上roles路径" class="headerlink" title="同步时间依赖角色，安装角色包’rhel-system-roles’ 需要在配置文件里添加上roles路径"></a>同步时间依赖角色，安装角色包’rhel-system-roles’ 需要在配置文件里添加上roles路径</h3><p>playbook 示例在/usr/share/ansibe/roles/rhel-system-roles.timesync/Readme.md<br>现成的yml示例在/usr/share/doc/rhel-system-roles/timesync/example-timesync-playbook.yml</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># ansible.cfg</span><br><span class="line">[default]</span><br><span class="line">roles_path &#x3D; &#x2F;home&#x2F;devops&#x2F;ansible&#x2F;roles:&#x2F;usr&#x2F;share&#x2F;ansible&#x2F;roles</span><br></pre></td></tr></table></figure>

<h3 id="使用ansible-galaxy-命令安装角色，安装到本地roles目录"><a href="#使用ansible-galaxy-命令安装角色，安装到本地roles目录" class="headerlink" title="使用ansible-galaxy 命令安装角色，安装到本地roles目录"></a>使用ansible-galaxy 命令安装角色，安装到本地roles目录</h3><p>yml文件很简单, 执行命令 ansible-galaxy install -r roles/requirement.yml -p roles/<br>-p 表示安装路径 </p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">balancer</span></span><br><span class="line">  <span class="attr">file:</span> <span class="string">/home/devops/ansible/files/5/haproxy.tar</span></span><br></pre></td></tr></table></figure>

<h3 id="创建apache角色，-角色对应一系列的任务和模板文件"><a href="#创建apache角色，-角色对应一系列的任务和模板文件" class="headerlink" title="创建apache角色， 角色对应一系列的任务和模板文件"></a>创建apache角色， 角色对应一系列的任务和模板文件</h3><p>通过<code>ansible-galaxy init apache</code> 来初始化角色目录，修改角色目录下的tasks/mail.yml 来添加任务，任务所需的模板文件在同级目录templates下<br>通过<code>ansible servera -m setup</code> 来查询环境变量， 在模板文件中使用<code>ansible_facts[&#39;fqdn&#39;]</code> 来引用变量<br>题目说的hostname 是<code>serverc.lab.example.com</code> 对应变量是fqdn, 另外一个是ip即 [‘default_ipv4’][‘address’]</p>
<p>例如，安装httpd用到yum模块， 启用httpd 用到service模块， 防火墙配置用到firewalld模块</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># home/devops/ansible/role/apache/tasks/main.yml</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">install</span> <span class="string">httpd</span></span><br><span class="line">  <span class="attr">yum:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">httpd</span></span><br><span class="line">    <span class="attr">state:</span> <span class="string">present</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">enable</span> <span class="string">httpd</span></span><br><span class="line">  <span class="attr">service:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">httpd</span></span><br><span class="line">    <span class="attr">state:</span> <span class="string">started</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">yes</span></span><br><span class="line">    </span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">firewalld</span> <span class="string">config</span></span><br><span class="line">  <span class="attr">firewalld:</span></span><br><span class="line">    <span class="attr">service:</span> <span class="string">httpd</span></span><br><span class="line">    <span class="attr">immediate:</span> <span class="literal">yes</span></span><br><span class="line">    <span class="attr">permanent:</span> <span class="literal">yes</span></span><br><span class="line">    <span class="attr">state:</span> <span class="string">enabled</span></span><br><span class="line">   </span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">install</span> <span class="string">templates</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">src:</span> <span class="string">index.html.j2</span></span><br><span class="line">    <span class="attr">dest:</span> <span class="string">/var/www/html/index.html</span></span><br></pre></td></tr></table></figure>

<p>模块文件放到templates目录下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># home&#x2F;devops&#x2F;ansible&#x2F;role&#x2F;apache&#x2F;templates&#x2F;index.html.j2</span><br><span class="line">Welcome to &#123;&#123; ansible_facts[&#39;fqdn&#39;] &#125;&#125; on &#123;&#123; ansible_facts[&#39;default_ipv4&#39;][&#39;address&#39;] &#125;&#125;</span><br></pre></td></tr></table></figure>

<p>最后还需要创建一个playbook, 如同其他playbook 一样执行</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># newrole.yml</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">install</span> <span class="string">new</span> <span class="string">role</span></span><br><span class="line">  <span class="attr">hosts:</span> <span class="string">webservers</span></span><br><span class="line">  <span class="attr">roles:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">apache</span></span><br></pre></td></tr></table></figure>

<h3 id="执行balancer-角色-创建一个负载均衡"><a href="#执行balancer-角色-创建一个负载均衡" class="headerlink" title="执行balancer 角色, 创建一个负载均衡"></a>执行balancer 角色, 创建一个负载均衡</h3><p>验证：<br>ssh到serverd 上，curl localhost, 先是访问的serverb, 然后访问的serverc</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">deploy</span> <span class="string">apache</span> <span class="string">on</span> <span class="string">webservers</span></span><br><span class="line">  <span class="attr">hosts:</span> <span class="string">webservers</span></span><br><span class="line">  <span class="attr">roles:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">apache</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">deploy</span> <span class="string">balancer</span> <span class="string">on</span> <span class="string">balancer</span></span><br><span class="line">  <span class="attr">hosts:</span> <span class="string">balancers</span></span><br><span class="line">  <span class="attr">roles:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">balancer</span></span><br><span class="line">    </span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">deploy</span> <span class="string">phpinfo</span> <span class="string">on</span> <span class="string">webservers</span></span><br><span class="line">  <span class="attr">hosts:</span> <span class="string">webservers</span></span><br><span class="line">  <span class="attr">roles:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">phpinfo</span></span><br></pre></td></tr></table></figure>

<h4 id="可能出现的错误，提示应该使用bind，这是由于balance-role的template-错误"><a href="#可能出现的错误，提示应该使用bind，这是由于balance-role的template-错误" class="headerlink" title="可能出现的错误，提示应该使用bind，这是由于balance role的template 错误"></a>可能出现的错误，提示应该使用bind，这是由于balance role的template 错误</h4><p>修改办法, 将listen行换行并加上bind</p>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># /home/devops/ansible/roles/balancer/templates/haproxy.cfg.j2</span><br><span class="line"></span><br><span class="line">backend app</span><br><span class="line">  &#123;% for host in groups.balancers %&#125;</span><br><span class="line"><span class="deletion">-  	listen &#123;&#123; daemonname &#125;&#125; 0.0.0.0:&#123;&#123; listenport &#125;&#125;</span></span><br><span class="line"><span class="addition">+  	listen &#123;&#123; daemonname &#125;&#125; </span></span><br><span class="line"><span class="addition">+	bind 0.0.0.0:&#123;&#123; listenport &#125;&#125;</span></span><br><span class="line">  &#123;% endfor %&#125;</span><br></pre></td></tr></table></figure>

<h3 id="创建逻辑卷，考验block-rescue-always-使用lvol，when-和play对齐"><a href="#创建逻辑卷，考验block-rescue-always-使用lvol，when-和play对齐" class="headerlink" title="创建逻辑卷，考验block/rescue/always, 使用lvol，when 和play对齐"></a>创建逻辑卷，考验block/rescue/always, 使用lvol，<code>when</code> 和play对齐</h3><p>使用了block/rescue/always就不需要tasks关键词</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">create</span> <span class="string">a</span> <span class="string">logic</span> <span class="string">volume</span> <span class="string">with</span> <span class="string">size</span> <span class="string">of</span> <span class="number">5000</span> <span class="string">and</span> <span class="string">format</span></span><br><span class="line">  <span class="attr">hosts:</span> <span class="string">all</span></span><br><span class="line">  <span class="attr">block:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">create</span> <span class="string">logic</span> <span class="string">volume</span></span><br><span class="line">	  <span class="attr">lvol:</span></span><br><span class="line">	    <span class="attr">vg:</span> <span class="string">research</span></span><br><span class="line">	    <span class="attr">lv:</span> <span class="string">data</span></span><br><span class="line">	    <span class="attr">size:</span> <span class="number">1500</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">fomat</span> <span class="string">data</span> <span class="string">volume</span></span><br><span class="line">        <span class="attr">filesystem:</span></span><br><span class="line">          <span class="attr">fstype:</span> <span class="string">ext4</span></span><br><span class="line">          <span class="attr">dev:</span> <span class="string">/dev/research/data</span></span><br><span class="line">  <span class="attr">rescue:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">debug</span> <span class="string">message</span></span><br><span class="line">      <span class="attr">debug:</span></span><br><span class="line">        <span class="attr">msg:</span> <span class="string">can't</span> <span class="string">create</span> <span class="string">a</span> <span class="string">size</span> <span class="string">of</span> <span class="number">1800</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">create</span> <span class="string">a</span> <span class="string">logical</span> <span class="string">volume</span> <span class="string">with</span> <span class="string">size</span> <span class="string">of</span> <span class="number">800</span> <span class="string">and</span> <span class="string">format</span></span><br><span class="line">        <span class="attr">lvol:</span></span><br><span class="line">          <span class="attr">vg:</span> <span class="string">research</span></span><br><span class="line">          <span class="attr">lv:</span> <span class="string">data</span></span><br><span class="line">          <span class="attr">size:</span> <span class="number">1500</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">fomat</span> <span class="string">data</span> <span class="string">volume</span></span><br><span class="line">        <span class="attr">filesystem:</span></span><br><span class="line">          <span class="attr">fstype:</span> <span class="string">ext4</span></span><br><span class="line">          <span class="attr">dev:</span> <span class="string">/dev/research/data</span></span><br><span class="line">      <span class="attr">when:</span> <span class="string">ansible_facts['lvm']['vgs']['research']</span> <span class="string">is</span> <span class="string">defined</span></span><br><span class="line">      <span class="attr">ignore_errors:</span> <span class="literal">yes</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">debug</span> <span class="number">2</span> </span><br><span class="line">        <span class="attr">debug:</span></span><br><span class="line">          <span class="attr">msg:</span> <span class="string">volume</span> <span class="string">group</span> <span class="string">does</span> <span class="string">not</span> <span class="string">exist</span></span><br><span class="line">      <span class="attr">when:</span> <span class="string">ansible_facts['lvm']['vgs']['research']</span> <span class="string">is</span> <span class="string">undefined</span></span><br></pre></td></tr></table></figure>

<h3 id="创建hosts文件，-考验jinija-的for循环和读inventory文件"><a href="#创建hosts文件，-考验jinija-的for循环和读inventory文件" class="headerlink" title="创建hosts文件， 考验jinija 的for循环和读inventory文件"></a>创建hosts文件， 考验jinija 的for循环和读inventory文件</h3><p>取facts变量的方法参考balancer的模板：<br>/home/ansible/roles/balancer/roles/template/haproxy.cfg.j2</p>
<p>基于给的hosts.j2 文件修改, 拼凑出<code>ip url alias</code>格式，分别对应 default_ipv4.address, fqdn, hostname<br>ansible_facts在hostvars[host]中</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 取</span></span><br><span class="line"><span class="string">&#123;%</span> <span class="string">for</span> <span class="string">host</span> <span class="string">in</span> <span class="string">groups.all</span> <span class="string">%&#125;</span></span><br><span class="line"><span class="string">&#123;&#123;</span> <span class="string">hostvars[host]['ansible_facts']</span> <span class="string">*忽露不写了*</span> <span class="string">&#125;&#125;</span> <span class="string">×</span> <span class="string">×</span> </span><br><span class="line"><span class="string">&#123;%</span> <span class="string">endfor</span> <span class="string">%&#125;</span></span><br><span class="line"><span class="string">---</span> </span><br><span class="line"></span><br><span class="line"><span class="string">创建playbook的要小心，题目要求生成所有主机的纪录，所以hosts是all,</span> <span class="string">但只部署在dev组的主机上要加when,</span>   </span><br><span class="line"><span class="string">要加`when:</span> <span class="string">'dev'</span> <span class="string">in</span> <span class="string">group_names`</span></span><br><span class="line"></span><br><span class="line"><span class="string">```yml</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">gen</span> <span class="string">hosts</span> <span class="string">and</span> <span class="string">deploy</span> <span class="string">on</span> <span class="string">dev</span> <span class="string">group</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">gen</span> <span class="string">hosts</span> <span class="string">and</span> <span class="string">deploy</span></span><br><span class="line">        <span class="attr">template:</span></span><br><span class="line">          <span class="attr">src:</span> <span class="string">hosts.j2</span></span><br><span class="line">          <span class="attr">dest:</span> <span class="string">/etc/myhosts</span></span><br><span class="line">      <span class="attr">when:</span> <span class="string">"'dev' in group_names"</span></span><br></pre></td></tr></table></figure>

<h3 id="创建web-server-注意将文件标注setype为httpd-system-content-t"><a href="#创建web-server-注意将文件标注setype为httpd-system-content-t" class="headerlink" title="创建web server, 注意将文件标注setype为httpd_system_content_t"></a>创建web server, 注意将文件标注setype为httpd_system_content_t</h3><p>通过man semanager-fcontext 查询setype, 或者使用<code>ls -ldZ</code>来查询selinux标签</p>
<p>创建文件，目录、链接都用file模块，但操作文件内容用copy模块<br>创建组用group模块,创建用户用user模块<br>容易搞反的链接的src是指向的文件，所以是/webdev, 可以看帮助文档</p>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">---</span></span><br><span class="line"><span class="deletion">- name: create web server</span></span><br><span class="line">  hosts: webservers</span><br><span class="line">  tasks:</span><br><span class="line">    - name: add group</span><br><span class="line">        group:</span><br><span class="line">           name: webdev</span><br><span class="line">           state: present</span><br><span class="line">    - name: create directory</span><br><span class="line">        file:</span><br><span class="line">          path: /webdev</span><br><span class="line">          group: webdev</span><br><span class="line">          state: directory</span><br><span class="line">          mode: u+rwx,g+rwxs,o-rx</span><br><span class="line"> -        setype: httpd_system_content_t</span><br><span class="line">    - name: create a symbolic link</span><br><span class="line">        file:</span><br><span class="line"> -        src: /var/www/html/webdev</span><br><span class="line"> -        dest: /webdev</span><br><span class="line"> +        src: /webdev</span><br><span class="line"> +        dest: /var/www/html/webdev</span><br><span class="line">          state: link</span><br><span class="line">    - name: create index.html</span><br><span class="line">        copy:</span><br><span class="line">          content: Development</span><br><span class="line">          dest: /var/www/html/webdev/index.html</span><br><span class="line"><span class="addition">+         setype: httpd_system_content_t</span></span><br></pre></td></tr></table></figure>

<h3 id="创建硬件报告，用到loops进行数组循环，内置变量item和-regexs匹配，lineinfile-进行文件编辑"><a href="#创建硬件报告，用到loops进行数组循环，内置变量item和-regexs匹配，lineinfile-进行文件编辑" class="headerlink" title="创建硬件报告，用到loops进行数组循环，内置变量item和 regexs匹配，lineinfile 进行文件编辑"></a>创建硬件报告，用到loops进行数组循环，内置变量item和 regexs匹配，lineinfile 进行文件编辑</h3><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">generate</span> <span class="string">hw</span> <span class="string">report</span></span><br><span class="line">  <span class="attr">hosts:</span> <span class="string">all</span></span><br><span class="line">  <span class="attr">vars:</span></span><br><span class="line">    <span class="attr">hw_all:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">hw_name:</span> <span class="string">HOST</span></span><br><span class="line">        <span class="attr">hw_content:</span> <span class="string">"<span class="template-variable">&#123;&#123; ansible_facts['hostname'] &#125;&#125;</span>"</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">hw_name:</span> <span class="string">BIOS_version</span></span><br><span class="line">        <span class="attr">hw_content:</span> <span class="string">"<span class="template-variable">&#123;&#123; ansible_facts['bios_version'] &#125;&#125;</span>"</span></span><br></pre></td></tr></table></figure>

<h3 id="创建加密文件，用到ansible-vault命令"><a href="#创建加密文件，用到ansible-vault命令" class="headerlink" title="创建加密文件，用到ansible-vault命令"></a>创建加密文件，用到ansible-vault命令</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ansible-vault encrypt lock.yml --vault-password-file&#x3D;secret.txt</span><br></pre></td></tr></table></figure>

<h3 id="添加用户，-ansible-playbook-通过-–vault-password-file-secret-txt-来传密码文件"><a href="#添加用户，-ansible-playbook-通过-–vault-password-file-secret-txt-来传密码文件" class="headerlink" title="添加用户， ansible-playbook 通过 –vault-password-file=secret.txt 来传密码文件"></a>添加用户， ansible-playbook 通过 –vault-password-file=secret.txt 来传密码文件</h3><p>通过<code>vars_files</code>来读取变量文件， loop 来循环遍历数组变量， 然后模板直接取密码后用’| password_hash(‘sha512’)’ 来加密密码<br>通常情况下在playbook中，开头位置引用一个变量时都需要”“， 但是在when块里，则直接使用 variable。 另外字符串要用“string”  </p>
<p>创建用户时， 指定附属组用groups, 主要组是group</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">- &#123;&#123; variable &#125;&#125; ## 错误</span><br><span class="line">key: &#123;&#123; variable &#125;&#125; ## 错误</span><br><span class="line">- &quot;&#123;&#123; variable&#125;&#125;&quot; ## 正确</span><br><span class="line">key: &quot;&#123;&#123; variable &#125;&#125;&quot; ## 正确</span><br></pre></td></tr></table></figure>

<p>结果</p>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">---</span></span><br><span class="line"><span class="deletion">- name: create user on dev,test</span></span><br><span class="line">  hosts: dev,test</span><br><span class="line">  vars_files:</span><br><span class="line">    - lock.yml</span><br><span class="line">    - user_list.yml</span><br><span class="line">  tasks:</span><br><span class="line">    - name: create group devops</span><br><span class="line">      group:</span><br><span class="line">        name: devops</span><br><span class="line">        state: present</span><br><span class="line">    - name: create user </span><br><span class="line">      user:</span><br><span class="line">        name: "&#123;&#123; item.name &#125;&#125;"</span><br><span class="line"><span class="deletion">-       group: devops</span></span><br><span class="line"><span class="addition">+       groups: devops        </span></span><br><span class="line">        password: "&#123;&#123; pw_developer | password_hash('sha512') &#125;&#125;"</span><br><span class="line">      loop: "&#123;&#123; user &#125;&#125;"</span><br><span class="line"><span class="deletion">-     when: "&#123;&#123; item.job &#125;&#125;" == developer</span></span><br><span class="line"><span class="addition">+     when: item.job == "developer"</span></span><br><span class="line"><span class="deletion">- name: create user on prod</span></span><br><span class="line">  hosts: prod</span><br><span class="line">  vars_files:</span><br><span class="line">    - lock.yml</span><br><span class="line">    - users_list.yml</span><br><span class="line">  tasks:</span><br><span class="line">    - name: create group manager</span><br><span class="line">      group:</span><br><span class="line">        name: manager</span><br><span class="line">        state: present</span><br><span class="line">    - name: create user</span><br><span class="line">      user:</span><br><span class="line">        name: "&#123;&#123; item.name &#125;&#125;"</span><br><span class="line">        groups: manager</span><br><span class="line">        password: "&#123;&#123; pw_manager | password_hash('sha512') &#125;&#125;"</span><br><span class="line">      loop: "&#123;&#123; user &#125;&#125;"</span><br><span class="line"><span class="deletion">-     when: "&#123;&#123; item.job &#125;&#125;" == manager</span></span><br><span class="line"><span class="addition">+     when: item.job == "manager"</span></span><br></pre></td></tr></table></figure>

<h3 id="修改密码-使用ansible-vault-rekey-修改密码，或者先解密后加密"><a href="#修改密码-使用ansible-vault-rekey-修改密码，或者先解密后加密" class="headerlink" title="修改密码, 使用ansible-vault rekey 修改密码，或者先解密后加密"></a>修改密码, 使用<code>ansible-vault rekey</code> 修改密码，或者先解密后加密</h3><h3 id="修改文件内容-使用copy模块，以及when条件判断"><a href="#修改文件内容-使用copy模块，以及when条件判断" class="headerlink" title="修改文件内容, 使用copy模块，以及when条件判断"></a>修改文件内容, 使用copy模块，以及when条件判断</h3><p>在playbook的内建变量 inventory_hostname 表示定义在inventory里的主机名称<br>也可以使用ansible_facts[‘hostname’],前提是被管理节点的hostname必须如果管理节点定义名称一样。 因为后者是到被管理节点获取。</p>
<p>使用when 限定条件， 满足条件才能执行这个task</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">create</span> <span class="string">issue</span></span><br><span class="line">  <span class="attr">hosts:</span> <span class="string">all</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">create</span> <span class="string">issue</span> <span class="string">file</span></span><br><span class="line">      <span class="attr">copy:</span></span><br><span class="line">        <span class="attr">content:</span> <span class="string">"Development"</span></span><br><span class="line">        <span class="attr">dest:</span> <span class="string">/etc/issue</span></span><br><span class="line">      <span class="attr">when:</span> <span class="string">inventory_name</span> <span class="string">in</span> <span class="string">groups.dev</span>  </span><br><span class="line"><span class="string">```</span>      </span><br><span class="line"></span><br><span class="line"><span class="comment">### 第二次排错</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#### ansible-galaxy 安装角色, 指定方法分别是 src/name</span></span><br><span class="line"></span><br><span class="line"><span class="string">```yml</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">src:</span> <span class="string">files/5/balancer.tar</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">balancer</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">src:</span> <span class="string">files/5/phpinfo.tar</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">phpinfo</span></span><br></pre></td></tr></table></figure>

<h3 id="timesync-看doc-示例，-验证方法是看timedatectl-看system-clock-syncronize-为-yes"><a href="#timesync-看doc-示例，-验证方法是看timedatectl-看system-clock-syncronize-为-yes" class="headerlink" title="timesync 看doc 示例， 验证方法是看timedatectl 看system clock syncronize 为 yes"></a>timesync 看doc 示例， 验证方法是看timedatectl 看system clock syncronize 为 yes</h3><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">use</span> <span class="string">timesync</span> <span class="string">role</span></span><br><span class="line">  <span class="attr">hosts:</span> <span class="string">all</span></span><br><span class="line">  <span class="attr">vars:</span></span><br><span class="line">    <span class="attr">timesync_ntp_servers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">hostname:</span> </span><br><span class="line">        <span class="attr">iburst:</span> <span class="literal">yes</span></span><br><span class="line">  <span class="attr">roles:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">rhel_system_roles.timesync</span></span><br></pre></td></tr></table></figure>

<h3 id="创建hosts-要用"><a href="#创建hosts-要用" class="headerlink" title="创建hosts, 要用 "></a>创建hosts, 要用 </h3><h3 id="使用firewalld模块时，需要指定immediate-参数，确保能立即生效"><a href="#使用firewalld模块时，需要指定immediate-参数，确保能立即生效" class="headerlink" title="使用firewalld模块时，需要指定immediate 参数，确保能立即生效"></a>使用firewalld模块时，需要指定immediate 参数，确保能立即生效</h3><h3 id="设置文件的权限时，应使用u-rwx-g-rwxs-o-rw-而不是u-rwx，原因很好理解"><a href="#设置文件的权限时，应使用u-rwx-g-rwxs-o-rw-而不是u-rwx，原因很好理解" class="headerlink" title="设置文件的权限时，应使用u=rwx,g=rwxs,o=rw, 而不是u+rwx，原因很好理解"></a>设置文件的权限时，应使用u=rwx,g=rwxs,o=rw, 而不是u+rwx，原因很好理解</h3>
      
    </div>
    <footer class="article-footer">
      <a data-url="https://energygreek.github.io/2020/08/29/rhce8-question/" data-id="ckp6c7an8001nd1okcwmp0mfo" data-title="rhce8 question" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/rhce8/" rel="tag">rhce8</a></li></ul>

    </footer>
  </div>
  
</article>



  


  <nav id="page-nav">
    
    <a class="extend prev" rel="prev" href="/page/2/">&laquo; Prev</a><a class="page-number" href="/">1</a><a class="page-number" href="/page/2/">2</a><span class="page-number current">3</span><a class="page-number" href="/page/4/">4</a><a class="page-number" href="/page/5/">5</a><a class="extend next" rel="next" href="/page/4/">Next &raquo;</a>
  </nav>

</section>
        
          <aside id="sidebar">
  
    

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/Linux-%E5%86%85%E6%A0%B8%E5%8E%9F%E7%90%86/" rel="tag">Linux 内核原理</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/aarch64/" rel="tag">aarch64</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/algorithm/" rel="tag">algorithm</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/c/" rel="tag">c++</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/c-c/" rel="tag">c/c++</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/cmake/" rel="tag">cmake</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/dns/" rel="tag">dns</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/docker/" rel="tag">docker</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/docker-filesystem/" rel="tag">docker, filesystem</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/experience/" rel="tag">experience</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/filesystem/" rel="tag">filesystem</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/git/" rel="tag">git</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/grub/" rel="tag">grub</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/k8s/" rel="tag">k8s</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/linux-%E7%B3%BB%E7%BB%9F%E8%B0%83%E7%94%A8/" rel="tag">linux 系统调用</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/linux%E5%9F%BA%E7%A1%80/" rel="tag">linux基础</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/lvm/" rel="tag">lvm</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/maintaince/" rel="tag">maintaince</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/memory-shared-ptr-unique-ptr-exception-safe/" rel="tag">memory,shared_ptr,unique_ptr,exception-safe</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/misc/" rel="tag">misc</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/printer-linux/" rel="tag">printer linux</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/program-lock/" rel="tag">program,lock</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/python/" rel="tag">python</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/python-%E5%8C%85%E7%AE%A1%E7%90%86/" rel="tag">python 包管理</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/rancher-k8s/" rel="tag">rancher,k8s</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/rhce8/" rel="tag">rhce8</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/safe/" rel="tag">safe</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/socket-udp-socketopt/" rel="tag">socket, udp, socketopt</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/sql/" rel="tag">sql</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/sysemd-%E8%BF%90%E7%BB%B4/" rel="tag">sysemd, 运维</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/systemd-tmpfile/" rel="tag">systemd,tmpfile</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/terminal-urxvt/" rel="tag">terminal,urxvt</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/tool/" rel="tag">tool</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/weechat/" rel="tag">weechat</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E4%BA%8C%E5%8F%89%E6%A0%91/" rel="tag">二叉树</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/Linux-%E5%86%85%E6%A0%B8%E5%8E%9F%E7%90%86/" style="font-size: 10px;">Linux 内核原理</a> <a href="/tags/aarch64/" style="font-size: 10px;">aarch64</a> <a href="/tags/algorithm/" style="font-size: 10px;">algorithm</a> <a href="/tags/c/" style="font-size: 20px;">c++</a> <a href="/tags/c-c/" style="font-size: 13.33px;">c/c++</a> <a href="/tags/cmake/" style="font-size: 10px;">cmake</a> <a href="/tags/dns/" style="font-size: 10px;">dns</a> <a href="/tags/docker/" style="font-size: 10px;">docker</a> <a href="/tags/docker-filesystem/" style="font-size: 10px;">docker, filesystem</a> <a href="/tags/experience/" style="font-size: 10px;">experience</a> <a href="/tags/filesystem/" style="font-size: 10px;">filesystem</a> <a href="/tags/git/" style="font-size: 10px;">git</a> <a href="/tags/grub/" style="font-size: 10px;">grub</a> <a href="/tags/k8s/" style="font-size: 10px;">k8s</a> <a href="/tags/linux-%E7%B3%BB%E7%BB%9F%E8%B0%83%E7%94%A8/" style="font-size: 10px;">linux 系统调用</a> <a href="/tags/linux%E5%9F%BA%E7%A1%80/" style="font-size: 10px;">linux基础</a> <a href="/tags/lvm/" style="font-size: 10px;">lvm</a> <a href="/tags/maintaince/" style="font-size: 10px;">maintaince</a> <a href="/tags/memory-shared-ptr-unique-ptr-exception-safe/" style="font-size: 10px;">memory,shared_ptr,unique_ptr,exception-safe</a> <a href="/tags/misc/" style="font-size: 10px;">misc</a> <a href="/tags/printer-linux/" style="font-size: 10px;">printer linux</a> <a href="/tags/program-lock/" style="font-size: 10px;">program,lock</a> <a href="/tags/python/" style="font-size: 13.33px;">python</a> <a href="/tags/python-%E5%8C%85%E7%AE%A1%E7%90%86/" style="font-size: 10px;">python 包管理</a> <a href="/tags/rancher-k8s/" style="font-size: 10px;">rancher,k8s</a> <a href="/tags/rhce8/" style="font-size: 10px;">rhce8</a> <a href="/tags/safe/" style="font-size: 13.33px;">safe</a> <a href="/tags/socket-udp-socketopt/" style="font-size: 10px;">socket, udp, socketopt</a> <a href="/tags/sql/" style="font-size: 10px;">sql</a> <a href="/tags/sysemd-%E8%BF%90%E7%BB%B4/" style="font-size: 10px;">sysemd, 运维</a> <a href="/tags/systemd-tmpfile/" style="font-size: 10px;">systemd,tmpfile</a> <a href="/tags/terminal-urxvt/" style="font-size: 10px;">terminal,urxvt</a> <a href="/tags/tool/" style="font-size: 16.67px;">tool</a> <a href="/tags/weechat/" style="font-size: 10px;">weechat</a> <a href="/tags/%E4%BA%8C%E5%8F%89%E6%A0%91/" style="font-size: 10px;">二叉树</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/05/">May 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/04/">April 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/03/">March 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/02/">February 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/01/">January 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/11/">November 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/10/">October 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/08/">August 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/07/">July 2020</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2021/05/13/manage-temporary-file-with-systemd-tmpfiles/">使用systemd-tmpfiles来管理临时文件</a>
          </li>
        
          <li>
            <a href="/2021/04/02/ways-to-use-third-party-library-in-cmake/">cmake 使用第三方库</a>
          </li>
        
          <li>
            <a href="/2021/03/25/my-urxvt/">urxvt配置</a>
          </li>
        
          <li>
            <a href="/2021/03/17/static-compile-warning-if-namespace-resolving-function-used/">static compile warning if namespace resolving function used</a>
          </li>
        
          <li>
            <a href="/2021/03/15/shared-pointer/">智能指针</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      
      &copy; 2021 husongtao<br>
      Powered by <a href="https://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    


<script src="/js/jquery-3.4.1.min.js"></script>



  
<script src="/fancybox/jquery.fancybox.min.js"></script>




<script src="/js/script.js"></script>





  </div>
</body>
</html>