<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  
  <title>又是元气满满的一天</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta property="og:type" content="website">
<meta property="og:title" content="又是元气满满的一天">
<meta property="og:url" content="https://energygreek.github.io/index.html">
<meta property="og:site_name" content="又是元气满满的一天">
<meta property="og:locale" content="cn">
<meta property="article:author" content="husongtao">
<meta name="twitter:card" content="summary">
  
  
    <link rel="shortcut icon" href="/favicon.png">
  
  
    
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/typeface-source-code-pro@0.0.71/index.min.css">

  
  
<link rel="stylesheet" href="/css/style.css">

  
    
<link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css">

  
<meta name="generator" content="Hexo 4.2.1"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">又是元气满满的一天</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="https://energygreek.github.io"></form>
      </div>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main">
  
    <article id="post-manage-temporary-file-with-systemd-tmpfiles" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2021/05/13/manage-temporary-file-with-systemd-tmpfiles/" class="article-date">
  <time class="dt-published" datetime="2021-05-13T03:01:12.000Z" itemprop="datePublished">2021-05-13</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2021/05/13/manage-temporary-file-with-systemd-tmpfiles/">使用systemd-tmpfiles来管理临时文件</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>vscode使用clangd作为c++的lsp非常好用，可以支持跳转、补全、clang-tidy、提示，但同时也对配置有要求，我的12Gi内存经常不够用而非常卡<br>于是摸索了一下，发现有两个问题：</p>
<ol>
<li>clangd会占用很多内存 </li>
<li>clangd在处理代码文件时会产生pch文件默认放到/tmp目录占用内存</li>
</ol>
<p>这里会说怎么解决这2个问题，也顺便用到systemd-tmpfiles工具</p>
<h2 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h2><h3 id="搜索过程"><a href="#搜索过程" class="headerlink" title="搜索过程"></a>搜索过程</h3><p>由于代码比较复杂，随便跳转几个文件就开始感到卡顿，一会就不能动了。切换X界面到终端, 执行<code>free</code>命令，可以看到shared和buff/cache两个部分占用很大内存</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">~ &gt; free -h</span><br><span class="line">               total        used        free      shared  buff&#x2F;cache   available</span><br><span class="line">Mem:            11Gi       7.1Gi       721Mi       1.0Gi       3.7Gi       3.1Gi</span><br><span class="line">Swap:             0B          0B          0B</span><br></pre></td></tr></table></figure>

<p>通过man可以知道这几项的意思, 可见share在我的系统指’/tmp’, 因为tmpfs挂载在/tmp目录</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">shared </span><br><span class="line">Memory used (mostly) by tmpfs (Shmem in &#x2F;proc&#x2F;meminfo)</span><br><span class="line"></span><br><span class="line">buffers</span><br><span class="line">Memory used by kernel buffers (Buffers in &#x2F;proc&#x2F;meminfo)</span><br><span class="line"></span><br><span class="line">cache  </span><br><span class="line">Memory used by the page cache and slabs (Cached and SReclaimable in &#x2F;proc&#x2F;meminfo)</span><br><span class="line"></span><br><span class="line">buff&#x2F;cache</span><br><span class="line">Sum of buffers and cache</span><br></pre></td></tr></table></figure>
<p>而buff/cache指的缓存(cache)和内核(buff)占用, 通过<code>cat /proc/meminfo</code> 查看到buff占用不大，不是内核问题(因为我用的最新内核,所以抱有怀疑态度)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">~ &gt; cat &#x2F;proc&#x2F;meminfo  | grep &quot;Buffers\|Cached&quot;</span><br><span class="line">Buffers:          308440 kB</span><br><span class="line">Cached:          3297168 kB</span><br></pre></td></tr></table></figure>

<p>所以主要是/tmp目录占用内存过大，以及clangd占用内存过大</p>
<h3 id="解决办法"><a href="#解决办法" class="headerlink" title="解决办法"></a>解决办法</h3><ol>
<li>对于clangd占用内存过大， 只有添加<code>-background-index=0</code>时，才能避免内存占用过大</li>
<li>clangd在分析代码文件的时候，产生大量pch文件, 这些都会占用内存</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">~ &gt; ls &#x2F;tmp&#x2F;*.pch -lh</span><br><span class="line">-rw-r--r-- 1  100M May 13 11:18 &#x2F;tmp&#x2F;preamble-133598.pch</span><br><span class="line">-rw-r--r-- 1  104M May 13 11:17 &#x2F;tmp&#x2F;preamble-457bd6.pch</span><br><span class="line">-rw-r--r-- 1  104M May 13 11:17 &#x2F;tmp&#x2F;preamble-465a46.pch</span><br><span class="line">-rw-r--r-- 1  104M May 13 11:18 &#x2F;tmp&#x2F;preamble-99f5e5.pch</span><br><span class="line">-rw-r--r-- 1  99M May 13 11:17 &#x2F;tmp&#x2F;preamble-b56fad.pch</span><br></pre></td></tr></table></figure>

<h2 id="使用systemd-tmpfiles-clean-来清除-tmp目录下的pch文件"><a href="#使用systemd-tmpfiles-clean-来清除-tmp目录下的pch文件" class="headerlink" title="使用systemd-tmpfiles-clean 来清除/tmp目录下的pch文件"></a>使用systemd-tmpfiles-clean 来清除/tmp目录下的pch文件</h2><h3 id="systemd-tmpfiles-介绍"><a href="#systemd-tmpfiles-介绍" class="headerlink" title="systemd-tmpfiles 介绍"></a>systemd-tmpfiles 介绍</h3><p>systemd-tmpfiles 通过<code>systemd-tmpfiles-clean.timer</code>定时调用<code>systemd-tmpfiles-clean.service</code>, 来清理零时文件，且是默认启动的。<br>虽然/tmp目录使用的内存挂载<code>tmpfs</code>（也有写发行版使用物理磁盘来挂载），在重启时会清空，但对于服务器这种常年不会重启的系统，就需要这样的机制清理内存/磁盘。  </p>
<p>timer默认的配置文件，<code>OnBootSec=15min</code>表示在系统启动15分钟后开始执行，而<code>OnUnitActiveSec=1d</code>表示在执行一次后，1天后再执行</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">~ &gt; cat &#x2F;usr&#x2F;lib&#x2F;systemd&#x2F;system&#x2F;systemd-tmpfiles-clean.timer</span><br><span class="line">#  SPDX-License-Identifier: LGPL-2.1-or-later</span><br><span class="line">#</span><br><span class="line">#  This file is part of systemd.</span><br><span class="line">#</span><br><span class="line">#  systemd is free software; you can redistribute it and&#x2F;or modify it</span><br><span class="line">#  under the terms of the GNU Lesser General Public License as published by</span><br><span class="line">#  the Free Software Foundation; either version 2.1 of the License, or</span><br><span class="line">#  (at your option) any later version.</span><br><span class="line"></span><br><span class="line">[Unit]</span><br><span class="line">Description&#x3D;Daily Cleanup of Temporary Directories</span><br><span class="line">Documentation&#x3D;man:tmpfiles.d(5) man:systemd-tmpfiles(8)</span><br><span class="line"></span><br><span class="line">[Timer]</span><br><span class="line">OnBootSec&#x3D;15min</span><br><span class="line">OnUnitActiveSec&#x3D;1d</span><br></pre></td></tr></table></figure>


<p>上面的timer会定时调用<code>systemd-tmpfiles-clean.service</code>这个服务</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">~ &gt; sudo systemctl status systemd-tmpfiles-clean.service</span><br><span class="line">○ systemd-tmpfiles-clean.service - Cleanup of Temporary Directories</span><br><span class="line">     Loaded: loaded (&#x2F;usr&#x2F;lib&#x2F;systemd&#x2F;system&#x2F;systemd-tmpfiles-clean.service; static)</span><br><span class="line">     Active: inactive (dead) since Wed 2021-05-12 16:37:27 HKT; 22h ago</span><br><span class="line">TriggeredBy: ● systemd-tmpfiles-clean.timer</span><br><span class="line">       Docs: man:tmpfiles.d(5)</span><br><span class="line">             man:systemd-tmpfiles(8)</span><br><span class="line">    Process: 36637 ExecStart&#x3D;systemd-tmpfiles --clean (code&#x3D;exited, status&#x3D;0&#x2F;SUCCESS)</span><br></pre></td></tr></table></figure>

<h2 id="systemd-tmpfiles-配置"><a href="#systemd-tmpfiles-配置" class="headerlink" title="systemd-tmpfiles 配置"></a>systemd-tmpfiles 配置</h2><p>上面是timer的设置，这个timer适合服务器，但并不建议修改它们。而是添加规则，再手动调用<code>systemd-tmpfiles --clean</code><br>配置规则的方法可以查看<code>man tmpfiles.d 5</code>，但只建议在/etc 和 ～/ 目录添加规则, 前者对所有用户生效，后者只对自己生效</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">TMPFILES.D(5)                                                                           tmpfiles.d                                                                           TMPFILES.D(5)</span><br><span class="line"></span><br><span class="line">NAME</span><br><span class="line">       tmpfiles.d - Configuration for creation, deletion and cleaning of volatile and temporary files</span><br><span class="line"></span><br><span class="line">SYNOPSIS</span><br><span class="line">       &#x2F;etc&#x2F;tmpfiles.d&#x2F;*.conf</span><br><span class="line">       &#x2F;run&#x2F;tmpfiles.d&#x2F;*.conf</span><br><span class="line">       &#x2F;usr&#x2F;lib&#x2F;tmpfiles.d&#x2F;*.conf</span><br><span class="line"></span><br><span class="line">       ~&#x2F;.config&#x2F;user-tmpfiles.d&#x2F;*.conf</span><br><span class="line">       $XDG_RUNTIME_DIR&#x2F;user-tmpfiles.d&#x2F;*.conf</span><br><span class="line">       ~&#x2F;.local&#x2F;share&#x2F;user-tmpfiles.d&#x2F;*.conf</span><br></pre></td></tr></table></figure>

<p>直接从/usr/lib/tmpfs.d/ 找合适的配置，拷贝到自己的目录再改</p>
<p>删除/tmp/*.pch文件的效果</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">~ &gt; free</span><br><span class="line">               total        used        free      shared  buff&#x2F;cache   available</span><br><span class="line">Mem:        12158548     7808240      854296     1010820     3496012     3019688</span><br><span class="line">Swap:              0           0           0</span><br><span class="line">~ &gt; rm &#x2F;tmp&#x2F;*.pch</span><br><span class="line">~ &gt; free</span><br><span class="line">               total        used        free      shared  buff&#x2F;cache   available</span><br><span class="line">Mem:        12158548     7804356     1169052      699936     3185140     3334460</span><br><span class="line">Swap:              0           0           0</span><br></pre></td></tr></table></figure>

<p>shared项少了许多, 再设置<code>background-index=0</code>后，内存占用大大减小</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>使用systemd-tmpfs 来清除文件的方式不太适合这种场景, 但其本身是非常功能强大的管理工具</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://energygreek.github.io/2021/05/13/manage-temporary-file-with-systemd-tmpfiles/" data-id="ckp6c7amq000yd1ok5brg7rv3" data-title="使用systemd-tmpfiles来管理临时文件" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/systemd-tmpfile/" rel="tag">systemd,tmpfile</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-ways-to-use-third-party-library-in-cmake" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2021/04/02/ways-to-use-third-party-library-in-cmake/" class="article-date">
  <time class="dt-published" datetime="2021-04-02T06:15:03.000Z" itemprop="datePublished">2021-04-02</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2021/04/02/ways-to-use-third-party-library-in-cmake/">cmake 使用第三方库</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="cmake-使用第三方库"><a href="#cmake-使用第三方库" class="headerlink" title="cmake 使用第三方库"></a>cmake 使用第三方库</h1><p>在项目中链接第三方包的方法大都是<code>target_link_library</code>, 但是查找方法有以下方式</p>
<h2 id="预先安装到环境或者docker环境"><a href="#预先安装到环境或者docker环境" class="headerlink" title="预先安装到环境或者docker环境"></a>预先安装到环境或者docker环境</h2><p>环境安装依赖包的时候，在项目的CMakeList.txt中使用find_package(), 然后可以在链接的时候使用第三方库</p>
<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">find_package</span>()</span><br></pre></td></tr></table></figure>

<h3 id="当find-package失败时"><a href="#当find-package失败时" class="headerlink" title="当find_package失败时"></a>当find_package失败时</h3><p>当find_package找不到，但是库确实安装在<code>/usr/lib/</code>或<code>/usr/local/lib</code>等标准位置，说明cmake缺少找包module<br>这时候有3个办法</p>
<ol>
<li>执行cmake时，手动指定位置</li>
<li>使用安装包管理工具安装cmake-extra包, 这样可以增加找到包的可能性<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ pacman -S extra-cmake-modules</span><br></pre></td></tr></table></figure>
然后执行下面的命令，可以看到大量的’*.cmake’文件<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ls &#x2F;usr&#x2F;share&#x2F;cmake-3.20&#x2F;Modules&#x2F;</span><br></pre></td></tr></table></figure></li>
<li>自己写cmake查找文件<br>在项目根目录创建文件夹<code>cmake_module</code>,使用<code>set(CMAKE_MODULE_PATH ${CMAKE_SOURCE_DIR}/cmake_module)</code>来指定module的路径 </li>
</ol>
<p>最后在’cmake_module’下创建以.cmake结尾的文件，这个文件用来写找header和lib规则</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">find_path(Grpc_INCLUDE_DIR grpc++&#x2F;grpc++.h)</span><br><span class="line">mark_as_advanced(Grpc_INCLUDE_DIR)</span><br><span class="line"></span><br><span class="line">find_library(Grpc++_LIBRARY NAMES grpc++ grpc++-1-dll)</span><br><span class="line">mark_as_advanced(Grpc++_LIBRARY)</span><br></pre></td></tr></table></figure>
<p>有这个文件之后，可以在项目的cmake中直接使用<code>find_package()</code>和<code>include()</code></p>
<h2 id="将第三方库源码放到项目指定目录如third"><a href="#将第三方库源码放到项目指定目录如third" class="headerlink" title="将第三方库源码放到项目指定目录如third"></a>将第三方库源码放到项目指定目录如third</h2><ol>
<li>放到third目录并可以使用<code>git submodule</code>管理</li>
<li>在thrid目录添加CMakeList.txt，在其中添加目标，已备在项目中链接<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># for gsl-lite target</span><br><span class="line">add_library(gsl-lite INTERFACE)</span><br><span class="line">target_include_directories(gsl-lite SYSTEM INTERFACE $&#123;CMAKE_CURRENT_SOURCE_DIR&#125;&#x2F;gsl-lite&#x2F;include)</span><br></pre></td></tr></table></figure>

</li>
</ol>
<h2 id="ExternalProject-Add"><a href="#ExternalProject-Add" class="headerlink" title="ExternalProject_Add"></a>ExternalProject_Add</h2><p>这个不常用</p>
<h2 id="FetchContent"><a href="#FetchContent" class="headerlink" title="FetchContent"></a>FetchContent</h2><p>cmake3.11之后，可以使用这个办法来自动拉取网上的库，并可以直接在自己的项目中使用</p>
<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># <span class="doctag">NOTE:</span> This example uses cmake version 3.14 (FetchContent_MakeAvailable).</span></span><br><span class="line"><span class="comment"># Since it streamlines the FetchContent process</span></span><br><span class="line"><span class="keyword">cmake_minimum_required</span>(VERSION <span class="number">3.14</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">include</span>(FetchContent)</span><br><span class="line"></span><br><span class="line"><span class="comment"># In this example we are picking a specific tag.</span></span><br><span class="line"><span class="comment"># You can also pick a specific commit, if you need to.</span></span><br><span class="line">FetchContent_Declare(GSL</span><br><span class="line">    GIT_REPOSITORY <span class="string">"https://github.com/microsoft/GSL"</span></span><br><span class="line">    GIT_TAG <span class="string">"v3.1.0"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">FetchContent_MakeAvailable(GSL)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Now you can link against the GSL interface library</span></span><br><span class="line"><span class="keyword">add_executable</span>(foobar)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Link against the interface library (IE header only library)</span></span><br><span class="line"><span class="keyword">target_link_libraries</span>(foobar PRIVATE GSL)</span><br></pre></td></tr></table></figure>

<p>##cmake使用openssl存在问题</p>
<p>因为openssl不用cmake,也就没有.cmake文件, 导致项目配置失败 </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Could NOT find OpenSSL, try to set the path to OpenSSL root folder in the</span><br><span class="line"> system variable OPENSSL_ROOT_DIR (missing: OPENSSL_LIBRARIES</span><br><span class="line"> OPENSSL_INCLUDE_DIR)</span><br></pre></td></tr></table></figure>
<p>后面发现它是使用package_config方式</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">#&#x2F;usr&#x2F;local&#x2F;lib&#x2F;pkgconfig&#x2F;openssl.pc</span><br><span class="line">prefix&#x3D;&#x2F;usr</span><br><span class="line">exec_prefix&#x3D;$&#123;prefix&#125;</span><br><span class="line">libdir&#x3D;$&#123;exec_prefix&#125;&#x2F;lib</span><br><span class="line">includedir&#x3D;$&#123;prefix&#125;&#x2F;include</span><br><span class="line"></span><br><span class="line">Name: OpenSSL</span><br><span class="line">Description: Secure Sockets Layer and cryptography libraries and tools</span><br><span class="line">Version: 1.1.1k</span><br><span class="line">Requires: libssl libcrypto</span><br></pre></td></tr></table></figure>

<p>这种情况除了通过cmake_module来解决之外，还可以通过指定pc文件的路径</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cmake -DOPENSSL_ROOT_DIR&#x3D;&#x2F;usr&#x2F;local&#x2F;</span><br></pre></td></tr></table></figure>

<h2 id="find-package-和-find-library-区别"><a href="#find-package-和-find-library-区别" class="headerlink" title="find_package 和 find_library 区别"></a>find_package 和 find_library 区别</h2><p>find_library 是cmake的底层方法，在find_path指定的目录下查找库文件。 而find_package是通过上面的几种方式来找库<br>也就是说，find_package是find_library的上层方法，而且find_package在找到目标后，会定义一些变量，如下面的’Findlibproxy.cmake’文件头</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"># - Try to find libproxy</span><br><span class="line"># Once done this will define</span><br><span class="line">#</span><br><span class="line">#  LIBPROXY_FOUND - system has libproxy</span><br><span class="line">#  LIBPROXY_INCLUDE_DIR - the libproxy include directory</span><br><span class="line">#  LIBPROXY_LIBRARIES - libproxy library</span><br><span class="line">#</span><br><span class="line"># Copyright (c) 2010, Dominique Leuenberger</span><br><span class="line">#</span><br><span class="line"># Redistribution and use is allowed according the license terms</span><br><span class="line"># of libproxy, which this file is integrated part of.</span><br><span class="line"></span><br><span class="line"># Find proxy.h and the corresponding library (libproxy.so)</span><br><span class="line">FIND_PATH(LIBPROXY_INCLUDE_DIR proxy.h )</span><br><span class="line">FIND_LIBRARY(LIBPROXY_LIBRARIES NAMES proxy )</span><br></pre></td></tr></table></figure>
<p>当找到libproxy.so的时候，LIBPROXY_FOUND被设置为TRUE等</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://energygreek.github.io/2021/04/02/ways-to-use-third-party-library-in-cmake/" data-id="ckp6c7ank002cd1ok4o6scmng" data-title="cmake 使用第三方库" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/cmake/" rel="tag">cmake</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-my-urxvt" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2021/03/25/my-urxvt/" class="article-date">
  <time class="dt-published" datetime="2021-03-25T08:39:47.000Z" itemprop="datePublished">2021-03-25</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2021/03/25/my-urxvt/">urxvt配置</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>自使用arch以来，一直在用urxvt, 它简洁，轻量，但不可否认的有问题，比如中文输入模式长时间时会无法输入中文，配置麻烦, 需要在启动脚本配置.xresource<br>这里要记一下自己的urxvt的配置以做备份  </p>
<h2 id="使用urxvt的主要功能"><a href="#使用urxvt的主要功能" class="headerlink" title="使用urxvt的主要功能"></a>使用urxvt的主要功能</h2><p>urxvt 非常简洁的tab功能,支持多路复用以及右键菜单格式化字符串，而且支持假透明，非常轻量。</p>
<p>urxvt不够现代化，不是开箱即用的，需要如下修改： </p>
<ul>
<li>tab功能需要修改perl的包，因为默认情况下不支持切换tab</li>
<li>不支持icon, 需要在配置文件手动指定icon的位置</li>
<li>tab功能需要额外启动参数，所以顺便编一个desktop启动文件</li>
</ul>
<h2 id="perl修改"><a href="#perl修改" class="headerlink" title="perl修改"></a>perl修改</h2><p>复制/usr/lib/perl/ext/tabbed到用户目录~/.urxvt/ext/, 修改<code>tab_key_press</code>函数如下</p>
<figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># if ($keysym == 0xff51 || $keysym == 0xff53)  表示使用ctrl+shift 和方向键来移动tab</span></span><br><span class="line"><span class="function"><span class="keyword">sub</span> <span class="title">tab_key_press</span> </span>&#123;</span><br><span class="line">   <span class="keyword">my</span> ($self, $tab, $event, $keysym, $str) = @_;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">if</span> ($event-&gt;&#123;state&#125; &amp; urxvt::ShiftMask &amp;&amp; !($event-&gt;&#123;state&#125; &amp; urxvt::ControlMask) ) &#123;</span><br><span class="line">      <span class="keyword">if</span> ($keysym == <span class="number">0xff51</span> || $keysym == <span class="number">0xff53</span>) &#123;</span><br><span class="line">         <span class="keyword">my</span> ($idx) = <span class="keyword">grep</span> $self-&gt;&#123;tabs&#125;[$_] == $tab, <span class="number">0</span> .. $#&#123; $self-&gt;&#123;tabs&#125; &#125;;</span><br><span class="line"></span><br><span class="line">         --$idx <span class="keyword">if</span> $keysym == <span class="number">0xff51</span>;</span><br><span class="line">         ++$idx <span class="keyword">if</span> $keysym == <span class="number">0xff53</span>;</span><br><span class="line"></span><br><span class="line">         $self-&gt;make_current ($self-&gt;&#123;tabs&#125;[$idx % @&#123; $self-&gt;&#123;tabs&#125;&#125;]);</span><br><span class="line"></span><br><span class="line">         <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">      &#125; <span class="keyword">elsif</span> ($keysym == <span class="number">0xff54</span>) &#123;</span><br><span class="line">         $self-&gt;new_tab;</span><br><span class="line"></span><br><span class="line">         <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;<span class="keyword">elsif</span> ($event-&gt;&#123;state&#125; &amp; urxvt::ControlMask &amp;&amp; $event-&gt;&#123;state&#125; &amp; urxvt::ShiftMask) &#123;</span><br><span class="line">      <span class="keyword">if</span> ($keysym == <span class="number">0xff51</span> || $keysym == <span class="number">0xff53</span>) &#123;</span><br><span class="line">         <span class="keyword">my</span> ($idx1) = <span class="keyword">grep</span> $self-&gt;&#123;tabs&#125;[$_] == $tab, <span class="number">0</span> .. $#&#123; $self-&gt;&#123;tabs&#125; &#125;;</span><br><span class="line">         <span class="keyword">my</span>  $idx2  = ($idx1 + ($keysym == <span class="number">0xff51</span> ? -<span class="number">1</span> : +<span class="number">1</span>)) % @&#123; $self-&gt;&#123;tabs&#125; &#125;;</span><br><span class="line"></span><br><span class="line">         ($self-&gt;&#123;tabs&#125;[$idx1], $self-&gt;&#123;tabs&#125;[$idx2]) =</span><br><span class="line">            ($self-&gt;&#123;tabs&#125;[$idx2], $self-&gt;&#123;tabs&#125;[$idx1]);</span><br><span class="line"></span><br><span class="line">         $self-&gt;make_current ($self-&gt;&#123;tabs&#125;[$idx2]);</span><br><span class="line"></span><br><span class="line">         <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   ()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="urxvt-启动文件"><a href="#urxvt-启动文件" class="headerlink" title="urxvt 启动文件"></a>urxvt 启动文件</h2><p>创建启动文件，使其默认为tab模式 ‘.local/share/applications/urxvtq.desktop’</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[Desktop Entry]</span><br><span class="line">Version&#x3D;1.0</span><br><span class="line">Name&#x3D;urxvtq</span><br><span class="line">Comment&#x3D;An unicode capable rxvt clone</span><br><span class="line">Exec&#x3D;urxvt -pe tabbed</span><br><span class="line">Icon&#x3D;utilities-terminal</span><br><span class="line">Terminal&#x3D;false</span><br><span class="line">Type&#x3D;Application</span><br><span class="line">Categories&#x3D;System;TerminalEmulator;</span><br></pre></td></tr></table></figure>

<h2 id="urxvt-配置"><a href="#urxvt-配置" class="headerlink" title="urxvt 配置"></a>urxvt 配置</h2><p>创建如下的文件，并要在合适的启动脚本里添加一行<code>[ -f &quot;$HOME/.Xresources&quot; ] &amp;&amp;  xrdb -merge &quot;$HOME/.Xresources&quot;</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line">!!$HOME&#x2F;.Xresources</span><br><span class="line"></span><br><span class="line">!! dbi</span><br><span class="line">Xft.dpi:98</span><br><span class="line"></span><br><span class="line">&#x2F;* Couleurs Tango *&#x2F;</span><br><span class="line"></span><br><span class="line">!! 下划线色</span><br><span class="line">URxvt.colorUL:  #87afd7</span><br><span class="line">URxvt.colorBD:  white</span><br><span class="line">URxvt.colorIT:  green</span><br><span class="line"></span><br><span class="line">!! tab 配色</span><br><span class="line">URxvt.tabbed.tabbar-fg: 2</span><br><span class="line">URxvt.tabbed.tabbar-bg: 0</span><br><span class="line">URxvt.tabbed.tab-fg:    3</span><br><span class="line">URxvt.tabbed.tab-bg:    2</span><br><span class="line">URxvt.tabbed.tabren-bg: 3</span><br><span class="line">URxvt.tabbed.tabdiv-fg: 8</span><br><span class="line">URxvt.tabbed.tabsel-fg: 1</span><br><span class="line">URxvt.tabbed.tabsel-bg: 8</span><br><span class="line"></span><br><span class="line">!! fake transparent</span><br><span class="line">URxvt.transparent: true</span><br><span class="line">URxvt.shading:     10</span><br><span class="line">URxvt.fading:      40</span><br><span class="line">!! font</span><br><span class="line">URxvt.font:        xft:Monospace,xft:Awesome:pixelsize&#x3D;14</span><br><span class="line">URxvt.boldfont:    xft:Monospace,xft:Awesome:style&#x3D;Bold:pixelsize&#x3D;16</span><br><span class="line"></span><br><span class="line">!! scroll behavior</span><br><span class="line">URxvt.scrollBar:         false</span><br><span class="line">URxvt.scrollTtyOutput:   false</span><br><span class="line">URxvt.scrollWithBuffer:  true</span><br><span class="line">URxvt.scrollTtyKeypress: true</span><br><span class="line"></span><br><span class="line">!! addtional</span><br><span class="line">URxvt.internalBorder:     0</span><br><span class="line">URxvt.cursorBlink: true</span><br><span class="line">URxvt.saveLines:          2000</span><br><span class="line">URxvt.mouseWheelScrollPage:             false</span><br><span class="line"></span><br><span class="line">! Restore Ctrl+Shift+(c|v)</span><br><span class="line">URxvt.keysym.Shift-Control-V: eval:paste_clipboard</span><br><span class="line">URxvt.keysym.Shift-Control-C: eval:selection_to_clipboard</span><br><span class="line">URxvt.iso14755: false</span><br><span class="line">URxvt.iso14755_52: false</span><br><span class="line"></span><br><span class="line">! alt+s 搜索</span><br><span class="line">URxvt.perl-ext:   default,matcher,searchable-scrollback</span><br><span class="line">URxvt.keysym.M-s: searchable-scrollback:start</span><br><span class="line"></span><br><span class="line">! url match 问题是tab模式下不支持跳转浏览器</span><br><span class="line">URxvt.url-launcher:       &#x2F;usr&#x2F;bin&#x2F;firefox</span><br><span class="line">URxvt.matcher.button:     1</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">URxvt.termName:         xterm-256color</span><br><span class="line">URxvt.iconFile:		&#x2F;usr&#x2F;share&#x2F;icons&#x2F;gnome&#x2F;32x32&#x2F;apps&#x2F;gnome-terminal-icon.png</span><br><span class="line">! fast key</span><br><span class="line">URxvt.keysym.Control-Up:     \033[1;5A</span><br><span class="line">URxvt.keysym.Control-Down:   \033[1;5B</span><br><span class="line">URxvt.keysym.Control-Left:   \033[1;5D</span><br><span class="line">URxvt.keysym.Control-Right:  \033[1;5C</span><br></pre></td></tr></table></figure>

<h2 id="最后"><a href="#最后" class="headerlink" title="最后"></a>最后</h2><p>用了kitty就不会有输入法的问题，字体也很丰富, 推荐现代化模拟终端kitty</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://energygreek.github.io/2021/03/25/my-urxvt/" data-id="ckp6c7amr0010d1ok58bq3pou" data-title="urxvt配置" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/terminal-urxvt/" rel="tag">terminal,urxvt</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-static-compile-warning-if-namespace-resolving-function-used" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2021/03/17/static-compile-warning-if-namespace-resolving-function-used/" class="article-date">
  <time class="dt-published" datetime="2021-03-17T02:47:35.000Z" itemprop="datePublished">2021-03-17</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2021/03/17/static-compile-warning-if-namespace-resolving-function-used/">static compile warning if namespace resolving function used</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>当程序里面有使用到解析函数的时候， 静态编译程序会报warning</p>
<h2 id="现象"><a href="#现象" class="headerlink" title="现象"></a>现象</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">..&#x2F;..&#x2F;lib&#x2F;libhacore.a(File.cpp.o): In function &#96;_ZN2ha4core9gid2groupB5cxx11Ej&#39;:</span><br><span class="line">&#x2F;tmp&#x2F;src&#x2F;ha&#x2F;core&#x2F;File.cpp:213: warning: Using &#39;getgrgid_r&#39; in statically linked applications requires at runtime the shared libraries from the glibc version used for linking</span><br><span class="line">..&#x2F;..&#x2F;lib&#x2F;libhacore.a(File.cpp.o): In function &#96;ha::core::group2gid(std::__cxx11::basic_string&lt;char, std::char_traits&lt;char&gt;, std::allocator&lt;char&gt; &gt; const&amp;, unsigned int&amp;)&#39;:</span><br><span class="line">&#x2F;tmp&#x2F;src&#x2F;ha&#x2F;core&#x2F;File.cpp:291: warning: Using &#39;getgrnam_r&#39; in statically linked applications requires at runtime the shared libraries from the glibc version used for linking</span><br><span class="line">..&#x2F;..&#x2F;lib&#x2F;libhacore.a(File.cpp.o): In function &#96;ha::core::username2uid(std::__cxx11::basic_string&lt;char, std::char_traits&lt;char&gt;, std::allocator&lt;char&gt; &gt; const&amp;, unsigned int&amp;)&#39;:</span><br><span class="line">&#x2F;tmp&#x2F;src&#x2F;ha&#x2F;core&#x2F;File.cpp:271: warning: Using &#39;getpwnam_r&#39; in statically linked applications requires at runtime the shared libraries from the glibc version used for linking</span><br><span class="line">..&#x2F;..&#x2F;lib&#x2F;libhacore.a(File.cpp.o): In function &#96;_ZN2ha4core12uid2usernameB5cxx11Ej&#39;:</span><br><span class="line">&#x2F;tmp&#x2F;src&#x2F;ha&#x2F;core&#x2F;File.cpp:194: warning: Using &#39;getpwuid_r&#39; in statically linked applications requires at runtime the shared libraries from the glibc version used for linking</span><br><span class="line">CMakeFiles&#x2F;hasync-exec.dir&#x2F;main.cpp.o: In function &#96;boost::asio::detail::socket_ops::getaddrinfo(char const*, char const*, addrinfo const&amp;, addrinfo**, boost::system::error_code&amp;)&#39;:</span><br><span class="line">&#x2F;usr&#x2F;local&#x2F;include&#x2F;boost&#x2F;asio&#x2F;detail&#x2F;impl&#x2F;socket_ops.ipp:3348: warning: Using &#39;getaddrinfo&#39; in statically linked applications requires at runtime the shared libraries from the glibc version used for linking</span><br><span class="line">&#x2F;usr&#x2F;local&#x2F;lib&#x2F;gcc&#x2F;x86_64-pc-linux-gnu&#x2F;8.2.0&#x2F;..&#x2F;..&#x2F;..&#x2F;..&#x2F;lib64&#x2F;libcrypto.a(b_sock.o): In function &#96;BIO_gethostbyname&#39;:</span><br><span class="line">b_sock.c:(.text+0x51): warning: Using &#39;gethostbyname&#39; in statically linked applications requires at runtime the shared libraries from the glibc version used for linking</span><br><span class="line">&#x2F;usr&#x2F;local&#x2F;lib&#x2F;gcc&#x2F;x86_64-pc-linux-gnu&#x2F;8.2.0&#x2F;..&#x2F;..&#x2F;..&#x2F;..&#x2F;lib64&#x2F;libcares.a(libcares_la-ares_getaddrinfo.o): In function &#96;ares_getaddrinfo&#39;:</span><br><span class="line">ares_getaddrinfo.c:(.text+0x73f): warning: Using &#39;getservbyname&#39; in statically linked applications requires at runtime the shared libraries from the glibc version used for linking</span><br><span class="line">&#x2F;usr&#x2F;local&#x2F;lib&#x2F;gcc&#x2F;x86_64-pc-linux-gnu&#x2F;8.2.0&#x2F;..&#x2F;..&#x2F;..&#x2F;..&#x2F;lib64&#x2F;libcares.a(libcares_la-ares_getnameinfo.o): In function &#96;lookup_service.part.0.constprop.2&#39;:</span><br><span class="line">ares_getnameinfo.c:(.text+0x32d): warning: Using &#39;getservbyport_r&#39; in statically linked applications requires at runtime the shared libraries from the glibc version used for linking</span><br></pre></td></tr></table></figure>

<h2 id="结论"><a href="#结论" class="headerlink" title="结论"></a>结论</h2><p>即使静态链接glibc, glibc内部在运行时依旧要调用<code>动态库</code>，这些库函数多与域名解析有关, 所以要求运行时的库版本要与编译时相同， 当然基于容器化部署就不用担心了  </p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://energygreek.github.io/2021/03/17/static-compile-warning-if-namespace-resolving-function-used/" data-id="ckp6c7anc001vd1okb5gh9gxd" data-title="static compile warning if namespace resolving function used" class="article-share-link">Share</a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-shared-pointer" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2021/03/15/shared-pointer/" class="article-date">
  <time class="dt-published" datetime="2021-03-15T09:16:05.000Z" itemprop="datePublished">2021-03-15</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2021/03/15/shared-pointer/">智能指针</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="智能指针"><a href="#智能指针" class="headerlink" title="智能指针"></a>智能指针</h1><p>智能指针是c++11加入的特性，包括shared_ptr和unique_ptr，weak_ptr，以及make_shared函数，但make_unique是c++14才出来<br>不过c++11可以通过模版来实现make_unique</p>
<h2 id="普通指针和智能指针的区别"><a href="#普通指针和智能指针的区别" class="headerlink" title="普通指针和智能指针的区别"></a>普通指针和智能指针的区别</h2><p>shared_ptr和unique_ptr都是异常安全的(exception-safe)，而普通指针不是，举例如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">void nonsafe_call(T1* t1, T2* t2);</span><br><span class="line">void safe_call(unique_ptr&lt;T1&gt; t1, unique_ptr&lt;T2&gt; t2);</span><br><span class="line"></span><br><span class="line">nonsafe_call(new T1, new T2);</span><br><span class="line">safe_call(make_unique&lt;T1&gt;, make_unique&lt;T2&gt;);</span><br></pre></td></tr></table></figure>

<h3 id="当形参为普通指针时"><a href="#当形参为普通指针时" class="headerlink" title="当形参为普通指针时"></a>当形参为普通指针时</h3><p>虽然new是安全的，会先申请内存再构造对象t1。 如果t1的构造函数抛异常，申请的内存会自动释放，不会内存泄漏<br>但当两个new作为函数参数时，情况不同。 因为参数必须在调用函数前决断，所以步骤如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">1. 为t1申请内存</span><br><span class="line">2. 构造t1</span><br><span class="line">3. 为t2申请内存</span><br><span class="line">4. 构造t2</span><br><span class="line">5. 调用函数</span><br></pre></td></tr></table></figure>

<ul>
<li>当执行到2失败时，不会泄漏，new会释放t1的内存</li>
<li>当执行到4失败是，会泄漏t1，因为t1已经构造完成，不会释放内存</li>
</ul>
<h3 id="当形参为智能指针时"><a href="#当形参为智能指针时" class="headerlink" title="当形参为智能指针时"></a>当形参为智能指针时</h3><p>步骤为</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">1. t1 &#x3D; make_unique&lt;T1&gt;()</span><br><span class="line">2. t2 &#x3D; make_unique&lt;T2&gt;()</span><br><span class="line">3. 调用函数</span><br></pre></td></tr></table></figure>
<p>如果2失败，t1的对象由unique_ptr管理，当t1释放时，会释放内存，所以无论t1构造失败还是t2构造失败，都能正确释放内存，不会导致泄漏<br>就因为unique_ptr和shared_ptr是内存安全的</p>
<h3 id="但以普通指针构造智能指针的方式不是异常安全的"><a href="#但以普通指针构造智能指针的方式不是异常安全的" class="headerlink" title="但以普通指针构造智能指针的方式不是异常安全的"></a>但以普通指针构造智能指针的方式不是异常安全的</h3><p>即<code>foo(std::unique_ptr&lt;T1&gt;(new T1()), std::unique_ptr&lt;T2&gt;(new T2()));</code> 不是异常安全的</p>
<p>此时步骤可能如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">1. 为t1申请内存</span><br><span class="line">2. 构造t1</span><br><span class="line">3. 为t2申请内存</span><br><span class="line">4. 构造t2</span><br><span class="line">5. 构造unique_ptr&lt;T1&gt;</span><br><span class="line">6. 构造unique_ptr&lt;T2&gt;</span><br><span class="line">7. 调用函数</span><br></pre></td></tr></table></figure>
<p>当步骤4发生异常时，t1并未被unique_ptr管理，所以不会去释放t1的内存，故发生内存泄漏</p>
<h2 id="智能指针的构造"><a href="#智能指针的构造" class="headerlink" title="智能指针的构造"></a>智能指针的构造</h2><p>shared_ptr对应的函数是make_shared<T><br>但c++11中没有make_unique, 可以使用模版实现如下</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T,<span class="keyword">typename</span> ...Args&gt;</span><br><span class="line"><span class="function"><span class="built_in">std</span>::<span class="built_in">unique_ptr</span>&lt;T&gt; <span class="title">make_unique</span><span class="params">(Args&amp;&amp; ...args)</span></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">std</span>::<span class="built_in">unique_ptr</span>&lt;T&gt;(<span class="keyword">new</span> T(<span class="built_in">std</span>::forward&lt;Args&gt;(args)... ));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>那为什么这样就能异常安全呢？因为调用make_uniqe时，可以确保t1的内存被unique_ptr管理了 </p>
<h2 id="make-shared创建智能指针和用new创建智能指针的区别"><a href="#make-shared创建智能指针和用new创建智能指针的区别" class="headerlink" title="make_shared创建智能指针和用new创建智能指针的区别"></a>make_shared创建智能指针和用new创建智能指针的区别</h2><p>除了上面说所的make_shared/make_unique是异常安全，而unique_ptr<T>(new T()) 不是异常安全外，其构造的智能指针也不同  </p>
<p>智能指针之所以会释放内存，是因为智能指针本身也是一个对象，在其生命周期结束后会调用dtor, 并在那里释放内存<br>所以智能指针的对象内存即包含了T，也包含了智能指针本身，而make_shared<T>() 和 shared_ptr<T>(new T)的区别在于<code>前者是两个部分的地址连续，而后者并不一定连续</code></p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>为了避免多参数决断时，导致已经决断的参数内存泄漏，应尽可能使用智能指针来管理内存</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://energygreek.github.io/2021/03/15/shared-pointer/" data-id="ckp6c7ana001rd1ok9p902p60" data-title="智能指针" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/memory-shared-ptr-unique-ptr-exception-safe/" rel="tag">memory,shared_ptr,unique_ptr,exception-safe</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-setup-printer-use-avahi" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2021/03/10/setup-printer-use-avahi/" class="article-date">
  <time class="dt-published" datetime="2021-03-10T08:06:52.000Z" itemprop="datePublished">2021-03-10</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2021/03/10/setup-printer-use-avahi/">使用avahi将传统打印机支持无线打印</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>自从知道mdns之后，发现它非常方便，例如可以找到lan下有哪些ftp服务，ssh服务等。甚至我配置好的打印机服务。</p>
<h2 id="mdns介绍"><a href="#mdns介绍" class="headerlink" title="mdns介绍"></a>mdns介绍</h2><p>有别于dns, mdns专门用来解析链路域名（TLD为*.local）， 且不需要域名服务器（nameserver）。<br>原理是同一个lan里的主机通过avahi或zeroconfig类似的工具，向lan广播自己的ip信息和服务</p>
<h2 id="avahi-介绍"><a href="#avahi-介绍" class="headerlink" title="avahi 介绍"></a>avahi 介绍</h2><p>avahi是zeroconfig的开源实现，在linux下还有systemd-resolve 同样可以实现mdns解析，但是avahi依旧是linux预装的软件。</p>
<h3 id="avahi-配置"><a href="#avahi-配置" class="headerlink" title="avahi 配置"></a>avahi 配置</h3><p>主要修改<code>/etc/avahi/avahi-daemon.conf</code>, 这里使用了br0和wlan0两个网卡，avahi就可以访问两个网络</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">use-ipv4&#x3D;yes</span><br><span class="line">allow-interfaces&#x3D;br0,wlan0</span><br></pre></td></tr></table></figure>
<p>再设置自启动</p>
<h3 id="nss-配置"><a href="#nss-配置" class="headerlink" title="nss 配置"></a>nss 配置</h3><p>要让主机能解析到*.local 域名，需要修改配置文件<code>/etc/nsswitch.conf</code> </p>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="deletion">- hosts: files mymachines myhostname resolve [!UNAVAIL=return] dns</span></span><br><span class="line"><span class="addition">+ hosts: files mymachines myhostname mdns_minimal [NOTFOUND=return] resolve [!UNAVAIL=return] dns</span></span><br></pre></td></tr></table></figure>
<p>这样，在主机请求解析域名的时候， 会先去请求avahi解析，如果avahi解析失败（说明不是一个local域名）才会去查找域名解析（dns）</p>
<h3 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h3><p>首先可以ping 本地local域名</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">~ &gt; ping hst.local                                                                                                                                                                                      </span><br><span class="line">PING hst.local(hst (fe80::3e9c:fff:fe8c:69c3%wlan0)) 56 data bytes</span><br><span class="line">64 bytes from hst (fe80::3e9c:fff:fe8c:69c3%wlan0): icmp_seq=1 ttl=64 time=0.113 ms</span><br><span class="line">64 bytes from hst (fe80::3e9c:fff:fe8c:69c3%wlan0): icmp_seq=2 ttl=64 time=0.144 ms</span><br></pre></td></tr></table></figure>

<p>然后执行<code>avahi-discover-standalone</code> 可以查找到很多*.local的地址，特别是在公司网络里</p>
<h2 id="广告自己的服务"><a href="#广告自己的服务" class="headerlink" title="广告自己的服务"></a>广告自己的服务</h2><p>配置好了avahi, 就可以向外界发布自己的服务，让其他人知道，也可以选择不发布<br>例如要广告我的ssh服务, 只需要将预设的配置文件拷贝到avahi的配置目录下</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo cp /usr/share/doc/avahi/ssh.service /etc/avahi/services</span><br></pre></td></tr></table></figure>
<p>这样，别人就能发现我的ssh服务了</p>
<h2 id="配置打印机"><a href="#配置打印机" class="headerlink" title="配置打印机"></a>配置打印机</h2><p>linux的打印功能依赖CUPS这个软件，先安装CUPS，设置自启动，然后就可以访问CUPS的网页版管理界面<code>http://localhost:631</code><br>在这个网页中添加网络打印机或者本地打印机，然后测试打印是否正常</p>
<h2 id="最后，配置无线功能"><a href="#最后，配置无线功能" class="headerlink" title="最后，配置无线功能"></a>最后，配置无线功能</h2><p>上一部添加的打印机可能是有线网络打印机，也可能是串口打印机，都不能让我们的手机直接使用。  </p>
<p>但是通过cups + avahi 就可以将你的有线打印机变成无线打印机了<br>首先在cups里配置，勾选<code>Share This Printer</code>，<br><img src="/images/cups_share.png" alt="cups shares printer"></p>
<p>然后像刚才添加ssh服务一样， 添加打印服务<br>在<code>/etc/avahi/services/</code> 创建一个service后缀的文件<code>airprint.service</code></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" standalone='no'?&gt;</span><span class="comment">&lt;!--*-nxml-*--&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">service-group</span> <span class="meta-keyword">SYSTEM</span> <span class="meta-string">"avahi-service.dtd"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">service-group</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">name</span>&gt;</span>Printer<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">service</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">type</span>&gt;</span>_ipp._tcp<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">subtype</span>&gt;</span>_universal._sub._ipp._tcp<span class="tag">&lt;/<span class="name">subtype</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">port</span>&gt;</span>631<span class="tag">&lt;/<span class="name">port</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">txt-record</span>&gt;</span>txtver=1<span class="tag">&lt;/<span class="name">txt-record</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">txt-record</span>&gt;</span>qtotal=1<span class="tag">&lt;/<span class="name">txt-record</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">txt-record</span>&gt;</span>rp=printers/Ricoh_MP_4055<span class="tag">&lt;/<span class="name">txt-record</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">txt-record</span>&gt;</span>ty=Ricoh_MP_4055<span class="tag">&lt;/<span class="name">txt-record</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">txt-record</span>&gt;</span>adminurl=http://yourip:631/printers/Ricoh_MP_4055<span class="tag">&lt;/<span class="name">txt-record</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">txt-record</span>&gt;</span>note=Ricoh_MP_4055<span class="tag">&lt;/<span class="name">txt-record</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">txt-record</span>&gt;</span>priority=0<span class="tag">&lt;/<span class="name">txt-record</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">txt-record</span>&gt;</span>product=(GPL Ghostscript)<span class="tag">&lt;/<span class="name">txt-record</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">txt-record</span>&gt;</span>printer-state=3<span class="tag">&lt;/<span class="name">txt-record</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">txt-record</span>&gt;</span>printer-type=0x801046<span class="tag">&lt;/<span class="name">txt-record</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">txt-record</span>&gt;</span>Transparent=T<span class="tag">&lt;/<span class="name">txt-record</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">txt-record</span>&gt;</span>Binary=T<span class="tag">&lt;/<span class="name">txt-record</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">txt-record</span>&gt;</span>Fax=F<span class="tag">&lt;/<span class="name">txt-record</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">txt-record</span>&gt;</span>Color=T<span class="tag">&lt;/<span class="name">txt-record</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">txt-record</span>&gt;</span>Duplex=T<span class="tag">&lt;/<span class="name">txt-record</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">txt-record</span>&gt;</span>Staple=F<span class="tag">&lt;/<span class="name">txt-record</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">txt-record</span>&gt;</span>Copies=T<span class="tag">&lt;/<span class="name">txt-record</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">txt-record</span>&gt;</span>Collate=F<span class="tag">&lt;/<span class="name">txt-record</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">txt-record</span>&gt;</span>Punch=F<span class="tag">&lt;/<span class="name">txt-record</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">txt-record</span>&gt;</span>Bind=F<span class="tag">&lt;/<span class="name">txt-record</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">txt-record</span>&gt;</span>Sort=F<span class="tag">&lt;/<span class="name">txt-record</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">txt-record</span>&gt;</span>Scan=F<span class="tag">&lt;/<span class="name">txt-record</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">txt-record</span>&gt;</span>pdl=application/octet-stream,application/pdf,application/postscript,image/jpeg,image/png,image/urf<span class="tag">&lt;/<span class="name">txt-record</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">txt-record</span>&gt;</span>URF=W8,SRGB24,CP1,RS600<span class="tag">&lt;/<span class="name">txt-record</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">service</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">service-group</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>根据情况修改一下内容，就完成了, 亲测iphone可以使用这个服务打印</p>
<h2 id="注意"><a href="#注意" class="headerlink" title="注意"></a>注意</h2><p>上面的情况假设防火墙处于关闭状态，如果启用防火墙的情况下，需要开放avahi、ssh以及ipp服务</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo firewall-cmd --add-service ssh ipp --permanent</span><br><span class="line">sudo firewall-cmd --add-port&#x3D;5353&#x2F;tcp --permanent</span><br><span class="line">sudo firewall-cmd --reload</span><br></pre></td></tr></table></figure>








      
    </div>
    <footer class="article-footer">
      <a data-url="https://energygreek.github.io/2021/03/10/setup-printer-use-avahi/" data-id="ckp6c7an9001pd1ok5bh06eaw" data-title="使用avahi将传统打印机支持无线打印" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/printer-linux/" rel="tag">printer linux</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-variadic-templates" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2021/03/04/variadic-templates/" class="article-date">
  <time class="dt-published" datetime="2021-03-04T09:40:45.000Z" itemprop="datePublished">2021-03-04</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2021/03/04/variadic-templates/">可变模版variadic templates</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>c中有可变参数<code>...</code>和gcc内置<code>__VA_ARGS__</code>宏定义, 实现不同个数的变量打印。这是由编译期实现的，会将format的格式符替换成参数</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">int printf ( const char * format, ... );</span><br></pre></td></tr></table></figure>

<p>c++有模版，而且在c++11之后引入了动态参数模版，即模版函数或类可以使用动态参数</p>
<h2 id="用处"><a href="#用处" class="headerlink" title="用处"></a>用处</h2><p>在实际项目中手动跑单元测试用例的时候，不希望再去看日志文件，而是想日志直接输出到终端, 有以下办法</p>
<h3 id="c-11及以上标准"><a href="#c-11及以上标准" class="headerlink" title="c++11及以上标准"></a>c++11及以上标准</h3><p>可以使用动态参数模版替换原本的日志打印函数</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">undef</span> log_debug</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> First, <span class="keyword">typename</span> ...Rest&gt;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">log_debug</span><span class="params">(First &amp;&amp; first, Rest &amp;&amp; ... rest)</span></span>&#123;</span><br><span class="line">  <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; fmt::format(first, rest ...) &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 这时日志就直接输出到终端了, 这里使用了fmt库</span></span><br><span class="line">log_debug(<span class="string">"aasdas&#123;&#125;"</span>, <span class="string">"bbbb"</span>);</span><br></pre></td></tr></table></figure>

<p>也可简单写成</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> ...Args&gt;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">log_debug</span><span class="params">(Args&amp;&amp; ...args)</span></span>&#123;</span><br><span class="line">	<span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; fmt::format(args...) &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果不使用fmt格式化，还可以用</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">undef</span> log_debug</span></span><br><span class="line"><span class="comment">// 定义一个空函数</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">log_debug</span><span class="params">()</span></span>&#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> First, <span class="keyword">typename</span> Rest&gt;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">log_debug</span><span class="params">(First&amp;&amp; first, Arg&amp;&amp; ...arg)</span></span>&#123;</span><br><span class="line">	<span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; first;</span><br><span class="line">	log_debug(arg...);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>需要解释一下，函数<code>log_debug()</code>必须要先声明，因为模版实例化的的最终要调用这个无参的函数<br>模拟一下堆栈, 因为参数在每次递归时减少一个，所以最终是0个参数</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">log_debug(1, 0.2, &quot;aaa&quot;);</span><br><span class="line">log_debug(0.2, &quot;aaa&quot;);</span><br><span class="line">log_debug(&quot;aaa&quot;);</span><br><span class="line">log_debug();</span><br></pre></td></tr></table></figure>

<h3 id="c-11以前的标准"><a href="#c-11以前的标准" class="headerlink" title="c++11以前的标准"></a>c++11以前的标准</h3><p>可以使用宏定义来替换了, 然后需要重载<code>,</code>方法</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> log_debug(...) std::cout , __VA_ARGS__ , std::endl</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line"><span class="built_in">std</span>::ostream&amp; <span class="keyword">operator</span>,(<span class="built_in">std</span>::ostream&amp; out, <span class="keyword">const</span> T&amp; t) &#123;</span><br><span class="line">  out &lt;&lt; t;</span><br><span class="line">  <span class="keyword">return</span> out;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//overloaded version to handle all those special std::endl and others...</span></span><br><span class="line"><span class="built_in">std</span>::ostream&amp; <span class="keyword">operator</span>,(<span class="built_in">std</span>::ostream&amp; out, <span class="built_in">std</span>::ostream&amp;(*f)(<span class="built_in">std</span>::ostream&amp;)) &#123;</span><br><span class="line">  out &lt;&lt; f;</span><br><span class="line">  <span class="keyword">return</span> out;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h3 id="直接用c的方式"><a href="#直接用c的方式" class="headerlink" title="直接用c的方式"></a>直接用c的方式</h3><p>因为printf是支持varidic的</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">undef</span> log_debug</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> log_debug(...) printf(__VA_ARGS__), printf(<span class="meta-string">"\n"</span>)</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  log_debug(<span class="string">"example"</span>,<span class="string">"output"</span>,<span class="string">"filler"</span>,<span class="string">"text"</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h3 id="c-17-引入了fold-expression"><a href="#c-17-引入了fold-expression" class="headerlink" title="c++17 引入了fold expression"></a>c++17 引入了<code>fold expression</code></h3><p>可以改写为</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> ...Args&gt;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">log_debug</span><span class="params">(Args &amp;&amp; ...args)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    (<span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; ... &lt;&lt; args);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>动态参数模版除了以上的用法，还有更多用处, 例如<code>std::tupe</code>的实现</p>
<p>###模版类型</p>
<p>###模版函数<br>###模版对象<br>##模版与宏定义的区别<br>##模版与虚函数的区别<br>##可变参数模版<br>###可变参数模版与初始化列表的区别</p>
<h2 id="std-forward-转发在模版的使用"><a href="#std-forward-转发在模版的使用" class="headerlink" title="std::forward 转发在模版的使用"></a>std::forward 转发在模版的使用</h2><p>为什么完美转发的对象必须是右值引用</p>
<h2 id="说明一下右值引用"><a href="#说明一下右值引用" class="headerlink" title="说明一下右值引用"></a>说明一下右值引用</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"> 引用类型 	可以引用的值类型 	使用场景</span><br><span class="line">非常量左值 	常量左值 	非常量右值 	常量右值</span><br><span class="line">非常量左值引用 	Y 	N 	N 	N 	无</span><br><span class="line">常量左值引用 	Y 	Y 	Y 	Y 	常用于类中构建拷贝构造函数</span><br><span class="line">非常量右值引用 	N 	N 	Y 	N 	移动语义、完美转发</span><br><span class="line">常量右值引用 	N 	N 	Y 	Y 	无实际用途</span><br></pre></td></tr></table></figure>

<p>##参考<br><a href="https://en.cppreference.com/w/cpp/language/parameter_pack" target="_blank" rel="noopener">https://en.cppreference.com/w/cpp/language/parameter_pack</a><br><a href="https://en.cppreference.com/w/cpp/language/fold" target="_blank" rel="noopener">https://en.cppreference.com/w/cpp/language/fold</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://energygreek.github.io/2021/03/04/variadic-templates/" data-id="ckp6c7ani0027d1okefgc5j7s" data-title="可变模版variadic templates" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/c/" rel="tag">c++</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-temporary-object-and-reference" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2021/03/02/temporary-object-and-reference/" class="article-date">
  <time class="dt-published" datetime="2021-03-02T05:36:54.000Z" itemprop="datePublished">2021-03-02</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2021/03/02/temporary-object-and-reference/">c++ 中的临时变量与常量引用</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="什么是临时变量？"><a href="#什么是临时变量？" class="headerlink" title="什么是临时变量？"></a>什么是临时变量？</h1><p>我们通常说临时变量可能是在函数中定义的短暂生命周期的局部变量，但这是比较口语话的表达。这里讨论的是c++中<code>temporary object</code>,<br>函数内的局部变量<code>local variable</code>, 以及非引用类型参数，并不属于临时变量  </p>
<p>其实，c++中的临时变量出现情况：</p>
<ul>
<li>函数参数为常量类型变量的引用即<code>reference to const</code>, 且实参为常量(1,2,3,’a’,”asd”) //在函数开始时自动创建，在函数结束后自动销毁</li>
<li>函数返回值 // 赋值语句结束后，自动销毁</li>
<li>类型转换   // 赋值语句结束后，自动销毁</li>
</ul>
<p>而临时变量的定义就是<code>编译器自动创建和销毁的没有名字的变量</code>, 并且<code>规定</code>：  </p>
<ul>
<li>常量类型的引用（<code>reference to const</code>）可以绑定到临时变量</li>
<li>非常量类型的引用（<code>reference to non-const</code>）类型不能绑定到临时变量</li>
</ul>
<p>这个规定的原因是： 因为上面说的<code>编译器自动创建和销毁</code>，所以去修改一个会销毁变量是<code>没有意义的</code></p>
<h2 id="什么时候编译器要需要创建临时变量"><a href="#什么时候编译器要需要创建临时变量" class="headerlink" title="什么时候编译器要需要创建临时变量"></a>什么时候编译器要需要创建临时变量</h2><p>主要是以下两个地方会需要临时变量：</p>
<ul>
<li>函数接受引用类型参数的时候</li>
<li>函数返回的时候</li>
<li>类型转换的时候</li>
</ul>
<p>举例：</p>
<p>函数参数</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">foo</span><span class="params">(<span class="keyword">const</span> <span class="keyword">int</span> &amp;arg)</span></span>&#123;&#125;</span><br><span class="line">foo(<span class="number">1</span>);  <span class="comment">// 此时创建了临时变量，可以想象成'foo(int _tmp(i));' 而且这个_tmp 不能被修改</span></span><br></pre></td></tr></table></figure>

<p>函数返回值</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">foo</span><span class="params">()</span></span>&#123;<span class="keyword">return</span> <span class="number">1</span>;&#125;</span><br><span class="line"><span class="keyword">int</span> i=foo(); <span class="comment">// 此时创建了临时变量， int _tmp = foo(); int i = _tmp;</span></span><br></pre></td></tr></table></figure>

<p>类型转换</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> i = <span class="number">1</span>;</span><br><span class="line"><span class="keyword">double</span> d = i; <span class="comment">// double _tmp = i; double d = _tmp;</span></span><br></pre></td></tr></table></figure>

<h2 id="单独讨论这些似乎意义不大，-但是在实际编写代码的时候，可能会有疑惑"><a href="#单独讨论这些似乎意义不大，-但是在实际编写代码的时候，可能会有疑惑" class="headerlink" title="单独讨论这些似乎意义不大， 但是在实际编写代码的时候，可能会有疑惑"></a>单独讨论这些似乎意义不大， 但是在实际编写代码的时候，可能会有疑惑</h2><p>例如如何解释</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">const int&amp; cr &#x3D; 1; &#x2F;&#x2F; ok</span><br><span class="line">int &amp;r &#x3D; 1; &#x2F;&#x2F; ng</span><br></pre></td></tr></table></figure>
<p>这里赋值和函数传参一样， 因为1是常数，这里为常量<code>1</code>创建临时变量， 而只有<code>reference to const</code> 才能绑定到临时变量上</p>
<p>还有解释一个经常被引用的例子</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">foo</span><span class="params">(<span class="keyword">int</span> &amp;arg)</span></span>&#123;&#125;</span><br><span class="line"><span class="keyword">int</span> i = <span class="number">1</span>; foo(i); <span class="comment">// ok</span></span><br><span class="line"><span class="keyword">double</span> d = <span class="number">1.0</span>; foo(d); <span class="comment">// ng</span></span><br></pre></td></tr></table></figure>

<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">foo</span><span class="params">(<span class="keyword">const</span> <span class="keyword">int</span> &amp;arg)</span></span>&#123;&#125;</span><br><span class="line"><span class="keyword">int</span> i = <span class="number">1</span>; foo(i); <span class="comment">// ok</span></span><br><span class="line"><span class="keyword">double</span> d = <span class="number">1.0</span>; foo(d); <span class="comment">// ok</span></span><br></pre></td></tr></table></figure>
<p>这里虽然i和d都不是常量（不会创建临时变量）， 但是因为类型不同， 发生了类型转换，创建了临时变量。同样地，只有<code>reference to const</code> 才能绑定到临时变量上</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://energygreek.github.io/2021/03/02/temporary-object-and-reference/" data-id="ckp6c7ang0023d1okh8pr3t0s" data-title="c++ 中的临时变量与常量引用" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/c/" rel="tag">c++</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-kmp-substring-searching-algorithm" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2021/02/05/kmp-substring-searching-algorithm/" class="article-date">
  <time class="dt-published" datetime="2021-02-05T07:31:38.000Z" itemprop="datePublished">2021-02-05</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2021/02/05/kmp-substring-searching-algorithm/">kmp 子串查找算法</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>leetcode的<a href="https://leetcode-cn.com/problems/implement-strstr/" target="_blank" rel="noopener">题目</a>, 实现strstr,即查找子字符串</p>
<h2 id="最简单的算法"><a href="#最简单的算法" class="headerlink" title="最简单的算法"></a>最简单的算法</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">strStr</span><span class="params">(<span class="keyword">char</span> * haystack, <span class="keyword">char</span> * needle)</span></span>&#123;</span><br><span class="line">    <span class="keyword">char</span> *tmp = haystack;</span><br><span class="line">    <span class="keyword">while</span>(*tmp != <span class="number">0</span>)&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="built_in">strncmp</span>(tmp, needle,<span class="built_in">strlen</span>(needle))==<span class="number">0</span>)&#123;</span><br><span class="line">            <span class="keyword">return</span> tmp - haystack;</span><br><span class="line">        &#125;</span><br><span class="line">        tmp ++;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="kmp-算法"><a href="#kmp-算法" class="headerlink" title="kmp 算法"></a>kmp 算法</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">// C++ program for implementation of KMP pattern searching </span></span><br><span class="line"><span class="comment">// algorithm </span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;bits/stdc++.h&gt; </span></span></span><br><span class="line">  </span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">computeLPSArray</span><span class="params">(<span class="keyword">char</span>* pat, <span class="keyword">int</span> M, <span class="keyword">int</span>* lps)</span></span>; </span><br><span class="line">  </span><br><span class="line"><span class="comment">// Prints occurrences of txt[] in pat[] </span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">KMPSearch</span><span class="params">(<span class="keyword">char</span>* pat, <span class="keyword">char</span>* txt)</span> </span></span><br><span class="line"><span class="function"></span>&#123; </span><br><span class="line">    <span class="keyword">int</span> M = <span class="built_in">strlen</span>(pat); </span><br><span class="line">    <span class="keyword">int</span> N = <span class="built_in">strlen</span>(txt); </span><br><span class="line">  </span><br><span class="line">    <span class="comment">// create lps[] that will hold the longest prefix suffix </span></span><br><span class="line">    <span class="comment">// values for pattern </span></span><br><span class="line">    <span class="keyword">int</span> lps[M]; </span><br><span class="line">  </span><br><span class="line">    <span class="comment">// Preprocess the pattern (calculate lps[] array) </span></span><br><span class="line">    computeLPSArray(pat, M, lps); </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">int</span> i = <span class="number">0</span>; <span class="comment">// index for txt[] </span></span><br><span class="line">    <span class="keyword">int</span> j = <span class="number">0</span>; <span class="comment">// index for pat[] </span></span><br><span class="line">    <span class="keyword">while</span> (i &lt; N) &#123; </span><br><span class="line">        <span class="keyword">if</span> (pat[j] == txt[i]) &#123; </span><br><span class="line">            j++; </span><br><span class="line">            i++; </span><br><span class="line">        &#125; </span><br><span class="line">  </span><br><span class="line">        <span class="keyword">if</span> (j == M) &#123; </span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">"Found pattern at index %d "</span>, i - j); </span><br><span class="line">            j = lps[j - <span class="number">1</span>]; </span><br><span class="line">        &#125; </span><br><span class="line">  </span><br><span class="line">        <span class="comment">// mismatch after j matches </span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (i &lt; N &amp;&amp; pat[j] != txt[i]) &#123; </span><br><span class="line">            <span class="comment">// Do not match lps[0..lps[j-1]] characters, </span></span><br><span class="line">            <span class="comment">// they will match anyway </span></span><br><span class="line">            <span class="keyword">if</span> (j != <span class="number">0</span>) </span><br><span class="line">                j = lps[j - <span class="number">1</span>]; </span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                i = i + <span class="number">1</span>; </span><br><span class="line">        &#125; </span><br><span class="line">    &#125; </span><br><span class="line">&#125; </span><br><span class="line">  </span><br><span class="line"><span class="comment">// Fills lps[] for given patttern pat[0..M-1] </span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">computeLPSArray</span><span class="params">(<span class="keyword">char</span>* pat, <span class="keyword">int</span> M, <span class="keyword">int</span>* lps)</span> </span></span><br><span class="line"><span class="function"></span>&#123; </span><br><span class="line">    <span class="comment">// length of the previous longest prefix suffix </span></span><br><span class="line">    <span class="keyword">int</span> len = <span class="number">0</span>; </span><br><span class="line">  </span><br><span class="line">    lps[<span class="number">0</span>] = <span class="number">0</span>; <span class="comment">// lps[0] is always 0 </span></span><br><span class="line">  </span><br><span class="line">    <span class="comment">// the loop calculates lps[i] for i = 1 to M-1 </span></span><br><span class="line">    <span class="keyword">int</span> i = <span class="number">1</span>; </span><br><span class="line">    <span class="keyword">while</span> (i &lt; M) &#123; </span><br><span class="line">        <span class="keyword">if</span> (pat[i] == pat[len]) &#123; </span><br><span class="line">            len++; </span><br><span class="line">            lps[i] = len; </span><br><span class="line">            i++; </span><br><span class="line">        &#125; </span><br><span class="line">        <span class="keyword">else</span> <span class="comment">// (pat[i] != pat[len]) </span></span><br><span class="line">        &#123; </span><br><span class="line">            <span class="comment">// This is tricky. Consider the example. </span></span><br><span class="line">            <span class="comment">// AAACAAAA and i = 7. The idea is similar </span></span><br><span class="line">            <span class="comment">// to search step. </span></span><br><span class="line">            <span class="keyword">if</span> (len != <span class="number">0</span>) &#123; </span><br><span class="line">                len = lps[len - <span class="number">1</span>]; </span><br><span class="line">  </span><br><span class="line">                <span class="comment">// Also, note that we do not increment </span></span><br><span class="line">                <span class="comment">// i here </span></span><br><span class="line">            &#125; </span><br><span class="line">            <span class="keyword">else</span> <span class="comment">// if (len == 0) </span></span><br><span class="line">            &#123; </span><br><span class="line">                lps[i] = <span class="number">0</span>; </span><br><span class="line">                i++; </span><br><span class="line">            &#125; </span><br><span class="line">        &#125; </span><br><span class="line">    &#125; </span><br><span class="line">&#125; </span><br><span class="line">  </span><br><span class="line"><span class="comment">// Driver program to test above function </span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span></span><br><span class="line"><span class="function"></span>&#123; </span><br><span class="line">    <span class="keyword">char</span> txt[] = <span class="string">"ABABDABACDABABCABAB"</span>; </span><br><span class="line">    <span class="keyword">char</span> pat[] = <span class="string">"ABABCABAB"</span>; </span><br><span class="line">    KMPSearch(pat, txt); </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


      
    </div>
    <footer class="article-footer">
      <a data-url="https://energygreek.github.io/2021/02/05/kmp-substring-searching-algorithm/" data-id="ckp6c7amn000sd1okb2vna1ww" data-title="kmp 子串查找算法" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/algorithm/" rel="tag">algorithm</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-systemd-service" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2021/01/28/systemd-service/" class="article-date">
  <time class="dt-published" datetime="2021-01-28T07:53:33.000Z" itemprop="datePublished">2021-01-28</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2021/01/28/systemd-service/">创建 systemd 服务</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>说一个老话， 现在systemd作为linux的启动管理和服务管理已经越来越重要了， 上周考试也遇到用systemd 来管理容器，这里记录一下如何编写systemd服务</p>
<h2 id="关于systemd"><a href="#关于systemd" class="headerlink" title="关于systemd"></a>关于systemd</h2><p>systemd是只能运行在Linux上的init, 也就是启动后看到的1号进程。 除了启动， systemd还管理着很多东西，例如网络（systemd-networkd）， 域名解析（systemd-resolved），为服务创建socket(systemd.socket) 文件系统挂载，还有系统和用户的服务<br>systemd太大，说不完，需要查看各种文档</p>
<h2 id="systemd-的两种使用模式"><a href="#systemd-的两种使用模式" class="headerlink" title="systemd 的两种使用模式"></a>systemd 的两种使用模式</h2><p>systemd 分为system级别和user级别， 对应的unit文件分别在/etc/systemd/ 和 ～/.config/systemd/下， 前者是系统级别，后者是用户级别。 用户只能运行自己设置的服务</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl start system_service.service</span><br></pre></td></tr></table></figure>
<p>而普通用户只能执行</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl --user user_service.service</span><br></pre></td></tr></table></figure>

<p>这个name就是文件名称，例如必须’/etc/systemd/system/‘下存在’system_service.service’文件，在能执行第一条的命令、 必须在 ‘~/.config/systemd/user/‘下存在’user_service.service’在能执行第二条命令</p>
<h3 id="系统服务以其他用户运行服务"><a href="#系统服务以其他用户运行服务" class="headerlink" title="系统服务以其他用户运行服务"></a>系统服务以其他用户运行服务</h3><p>系统级别的服务默认会以root来运行服务，但是也可以设置以其他用户来运行来最小化权限，例如音视频服务。也可以以某个用户来执行，那么service unit 文件就变为‘system_service@user.service’</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"># system_service@user.service</span><br><span class="line">[Unit]</span><br><span class="line">Description&#x3D;Watchman for user %i</span><br><span class="line">After&#x3D;remote-fs.target</span><br><span class="line">Conflicts&#x3D;shutdown.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">ExecStart&#x3D;&#x2F;usr&#x2F;local&#x2F;bin&#x2F;watchman --foreground --inetd</span><br><span class="line">ExecStop&#x3D;pkill -u %i -x watchman</span><br><span class="line">Restart&#x3D;on-failure</span><br><span class="line">User&#x3D;%i</span><br><span class="line">Group&#x3D;users</span><br><span class="line">StandardInput&#x3D;socket</span><br><span class="line">StandardOutput&#x3D;syslog</span><br><span class="line">SyslogIdentifier&#x3D;watchman-%i</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy&#x3D;multi-user.target</span><br></pre></td></tr></table></figure>

<p>上面的服务以下面的socket 单元启动， 前提要这个服务实现接收socket,通过<code>sd_listen_fds(3)</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"># system_service@user.socket</span><br><span class="line"></span><br><span class="line">[Unit]</span><br><span class="line">Description&#x3D;Watchman socket for user %i</span><br><span class="line"></span><br><span class="line">[Socket]</span><br><span class="line">ListenStream&#x3D;&#x2F;var&#x2F;facebook&#x2F;watchman&#x2F;%i-state&#x2F;sock</span><br><span class="line">Accept&#x3D;false</span><br><span class="line">SocketMode&#x3D;0664</span><br><span class="line">SocketUser&#x3D;%i</span><br><span class="line">SocketGroup&#x3D;othergroup</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy&#x3D;sockets.target</span><br></pre></td></tr></table></figure>

<h3 id="普通用户运行服务"><a href="#普通用户运行服务" class="headerlink" title="普通用户运行服务"></a>普通用户运行服务</h3><p>注意， 普通用户因为只会以自己的身份启动，所以不能想系统服务那样指定’User/Group’</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[Unit]</span><br><span class="line">Description&#x3D;tun2socks for vpn</span><br><span class="line">#Requires&#x3D;ssh_to_alpha.service</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">Type&#x3D;simple</span><br><span class="line">ExecStart&#x3D;&#x2F;usr&#x2F;bin&#x2F;badvpn-tun2socks </span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy&#x3D;default.target</span><br></pre></td></tr></table></figure>

<p>若希望这个用户自定义服务能自启动， WantedBy需要设置成’default.target’</p>
<h2 id="自动创建unit-file"><a href="#自动创建unit-file" class="headerlink" title="自动创建unit-file"></a>自动创建unit-file</h2><p>以下命令可以自动在对应目录创建*.service文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl --user --force --full edit test.service</span><br></pre></td></tr></table></figure>







      
    </div>
    <footer class="article-footer">
      <a data-url="https://energygreek.github.io/2021/01/28/systemd-service/" data-id="ckp6c7ane001zd1okcx8p3ekl" data-title="创建 systemd 服务" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/sysemd-%E8%BF%90%E7%BB%B4/" rel="tag">sysemd, 运维</a></li></ul>

    </footer>
  </div>
  
</article>



  


  <nav id="page-nav">
    
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><span class="space">&hellip;</span><a class="page-number" href="/page/5/">5</a><a class="extend next" rel="next" href="/page/2/">Next &raquo;</a>
  </nav>

</section>
        
          <aside id="sidebar">
  
    

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/Linux-%E5%86%85%E6%A0%B8%E5%8E%9F%E7%90%86/" rel="tag">Linux 内核原理</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/aarch64/" rel="tag">aarch64</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/algorithm/" rel="tag">algorithm</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/c/" rel="tag">c++</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/c-c/" rel="tag">c/c++</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/cmake/" rel="tag">cmake</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/dns/" rel="tag">dns</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/docker/" rel="tag">docker</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/docker-filesystem/" rel="tag">docker, filesystem</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/experience/" rel="tag">experience</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/filesystem/" rel="tag">filesystem</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/git/" rel="tag">git</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/grub/" rel="tag">grub</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/k8s/" rel="tag">k8s</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/linux-%E7%B3%BB%E7%BB%9F%E8%B0%83%E7%94%A8/" rel="tag">linux 系统调用</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/linux%E5%9F%BA%E7%A1%80/" rel="tag">linux基础</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/lvm/" rel="tag">lvm</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/maintaince/" rel="tag">maintaince</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/memory-shared-ptr-unique-ptr-exception-safe/" rel="tag">memory,shared_ptr,unique_ptr,exception-safe</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/misc/" rel="tag">misc</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/printer-linux/" rel="tag">printer linux</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/program-lock/" rel="tag">program,lock</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/python/" rel="tag">python</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/python-%E5%8C%85%E7%AE%A1%E7%90%86/" rel="tag">python 包管理</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/rancher-k8s/" rel="tag">rancher,k8s</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/rhce8/" rel="tag">rhce8</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/safe/" rel="tag">safe</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/socket-udp-socketopt/" rel="tag">socket, udp, socketopt</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/sql/" rel="tag">sql</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/sysemd-%E8%BF%90%E7%BB%B4/" rel="tag">sysemd, 运维</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/systemd-tmpfile/" rel="tag">systemd,tmpfile</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/terminal-urxvt/" rel="tag">terminal,urxvt</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/tool/" rel="tag">tool</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/weechat/" rel="tag">weechat</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E4%BA%8C%E5%8F%89%E6%A0%91/" rel="tag">二叉树</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/Linux-%E5%86%85%E6%A0%B8%E5%8E%9F%E7%90%86/" style="font-size: 10px;">Linux 内核原理</a> <a href="/tags/aarch64/" style="font-size: 10px;">aarch64</a> <a href="/tags/algorithm/" style="font-size: 10px;">algorithm</a> <a href="/tags/c/" style="font-size: 20px;">c++</a> <a href="/tags/c-c/" style="font-size: 13.33px;">c/c++</a> <a href="/tags/cmake/" style="font-size: 10px;">cmake</a> <a href="/tags/dns/" style="font-size: 10px;">dns</a> <a href="/tags/docker/" style="font-size: 10px;">docker</a> <a href="/tags/docker-filesystem/" style="font-size: 10px;">docker, filesystem</a> <a href="/tags/experience/" style="font-size: 10px;">experience</a> <a href="/tags/filesystem/" style="font-size: 10px;">filesystem</a> <a href="/tags/git/" style="font-size: 10px;">git</a> <a href="/tags/grub/" style="font-size: 10px;">grub</a> <a href="/tags/k8s/" style="font-size: 10px;">k8s</a> <a href="/tags/linux-%E7%B3%BB%E7%BB%9F%E8%B0%83%E7%94%A8/" style="font-size: 10px;">linux 系统调用</a> <a href="/tags/linux%E5%9F%BA%E7%A1%80/" style="font-size: 10px;">linux基础</a> <a href="/tags/lvm/" style="font-size: 10px;">lvm</a> <a href="/tags/maintaince/" style="font-size: 10px;">maintaince</a> <a href="/tags/memory-shared-ptr-unique-ptr-exception-safe/" style="font-size: 10px;">memory,shared_ptr,unique_ptr,exception-safe</a> <a href="/tags/misc/" style="font-size: 10px;">misc</a> <a href="/tags/printer-linux/" style="font-size: 10px;">printer linux</a> <a href="/tags/program-lock/" style="font-size: 10px;">program,lock</a> <a href="/tags/python/" style="font-size: 13.33px;">python</a> <a href="/tags/python-%E5%8C%85%E7%AE%A1%E7%90%86/" style="font-size: 10px;">python 包管理</a> <a href="/tags/rancher-k8s/" style="font-size: 10px;">rancher,k8s</a> <a href="/tags/rhce8/" style="font-size: 10px;">rhce8</a> <a href="/tags/safe/" style="font-size: 13.33px;">safe</a> <a href="/tags/socket-udp-socketopt/" style="font-size: 10px;">socket, udp, socketopt</a> <a href="/tags/sql/" style="font-size: 10px;">sql</a> <a href="/tags/sysemd-%E8%BF%90%E7%BB%B4/" style="font-size: 10px;">sysemd, 运维</a> <a href="/tags/systemd-tmpfile/" style="font-size: 10px;">systemd,tmpfile</a> <a href="/tags/terminal-urxvt/" style="font-size: 10px;">terminal,urxvt</a> <a href="/tags/tool/" style="font-size: 16.67px;">tool</a> <a href="/tags/weechat/" style="font-size: 10px;">weechat</a> <a href="/tags/%E4%BA%8C%E5%8F%89%E6%A0%91/" style="font-size: 10px;">二叉树</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/05/">May 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/04/">April 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/03/">March 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/02/">February 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/01/">January 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/11/">November 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/10/">October 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/08/">August 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/07/">July 2020</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2021/05/13/manage-temporary-file-with-systemd-tmpfiles/">使用systemd-tmpfiles来管理临时文件</a>
          </li>
        
          <li>
            <a href="/2021/04/02/ways-to-use-third-party-library-in-cmake/">cmake 使用第三方库</a>
          </li>
        
          <li>
            <a href="/2021/03/25/my-urxvt/">urxvt配置</a>
          </li>
        
          <li>
            <a href="/2021/03/17/static-compile-warning-if-namespace-resolving-function-used/">static compile warning if namespace resolving function used</a>
          </li>
        
          <li>
            <a href="/2021/03/15/shared-pointer/">智能指针</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      
      &copy; 2021 husongtao<br>
      Powered by <a href="https://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    


<script src="/js/jquery-3.4.1.min.js"></script>



  
<script src="/fancybox/jquery.fancybox.min.js"></script>




<script src="/js/script.js"></script>





  </div>
</body>
</html>