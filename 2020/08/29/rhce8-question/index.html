<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  
  <title>rhce8 question | 又是元气满满的一天</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="记录一下上课笔记 进入nfs，autofs目录卡住，如何退出，应该是进入了D状态  chrome 需要笔记本插件，js控制插件 修改root密码时，在linux 选项后面添加 rd.break 然后默认进入内核根目录，然后rw重新挂载系统根目录 &#x2F;sysroot&#x2F;  fdisk 设置分区类型: 在创建分区结束后，使用t来标记文件类型, 然后使用L查看类型代码，查找到Linux swap 对应的代码">
<meta property="og:type" content="article">
<meta property="og:title" content="rhce8 question">
<meta property="og:url" content="https://energygreek.github.io/2020/08/29/rhce8-question/index.html">
<meta property="og:site_name" content="又是元气满满的一天">
<meta property="og:description" content="记录一下上课笔记 进入nfs，autofs目录卡住，如何退出，应该是进入了D状态  chrome 需要笔记本插件，js控制插件 修改root密码时，在linux 选项后面添加 rd.break 然后默认进入内核根目录，然后rw重新挂载系统根目录 &#x2F;sysroot&#x2F;  fdisk 设置分区类型: 在创建分区结束后，使用t来标记文件类型, 然后使用L查看类型代码，查找到Linux swap 对应的代码">
<meta property="og:locale" content="cn">
<meta property="article:published_time" content="2020-08-29T03:40:56.000Z">
<meta property="article:modified_time" content="2021-05-27T03:28:44.083Z">
<meta property="article:author" content="husongtao">
<meta property="article:tag" content="rhce8">
<meta name="twitter:card" content="summary">
  
  
    <link rel="shortcut icon" href="/favicon.png">
  
  
    
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/typeface-source-code-pro@0.0.71/index.min.css">

  
  
<link rel="stylesheet" href="/css/style.css">

  
    
<link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css">

  
<meta name="generator" content="Hexo 4.2.1"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">又是元气满满的一天</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="https://energygreek.github.io"></form>
      </div>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main"><article id="post-rhce8-question" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2020/08/29/rhce8-question/" class="article-date">
  <time class="dt-published" datetime="2020-08-29T03:40:56.000Z" itemprop="datePublished">2020-08-29</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="p-name article-title" itemprop="headline name">
      rhce8 question
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="记录一下上课笔记"><a href="#记录一下上课笔记" class="headerlink" title="记录一下上课笔记"></a>记录一下上课笔记</h1><ol>
<li>进入nfs，autofs目录卡住，如何退出，应该是进入了D状态 </li>
<li>chrome 需要笔记本插件，js控制插件</li>
<li>修改root密码时，在linux 选项后面添加 rd.break 然后默认进入内核根目录，然后rw重新挂载系统根目录 /sysroot/ </li>
<li>fdisk 设置分区类型: 在创建分区结束后，使用<code>t</code>来标记文件类型, 然后使用<code>L</code>查看类型代码，查找到Linux swap 对应的代码是85</li>
</ol>
<h2 id="RHCIA"><a href="#RHCIA" class="headerlink" title="RHCIA"></a>RHCIA</h2><h3 id="修改了网络信息之后，必须使用nmcli-connection-down和up-connection才会生效"><a href="#修改了网络信息之后，必须使用nmcli-connection-down和up-connection才会生效" class="headerlink" title="修改了网络信息之后，必须使用nmcli connection down和up connection才会生效"></a>修改了网络信息之后，必须使用nmcli connection down和up connection才会生效</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">nmtui connection down Wired_connection1</span><br><span class="line">nmtui connection up Wired_connection1</span><br></pre></td></tr></table></figure>

<h3 id="配置httpd服务时，修改port后，因为port非标准端口，需要用semanage打tag。否则失败，可以查看journeyctl-e-查看到错误信息和解决办法"><a href="#配置httpd服务时，修改port后，因为port非标准端口，需要用semanage打tag。否则失败，可以查看journeyctl-e-查看到错误信息和解决办法" class="headerlink" title="配置httpd服务时，修改port后，因为port非标准端口，需要用semanage打tag。否则失败，可以查看journeyctl -e 查看到错误信息和解决办法"></a>配置httpd服务时，修改port后，因为port非标准端口，需要用semanage打tag。否则失败，可以查看journeyctl -e 查看到错误信息和解决办法</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">semanage port -a -t http_port_t -p tcp 82</span><br></pre></td></tr></table></figure>


<h3 id="创建-home-admins-目录，并设置在目录中创建的文件，其组所有权自动设置为-adminusr。-这里就是设置s位，有数值方法和-法"><a href="#创建-home-admins-目录，并设置在目录中创建的文件，其组所有权自动设置为-adminusr。-这里就是设置s位，有数值方法和-法" class="headerlink" title="创建/home/admins 目录，并设置在目录中创建的文件，其组所有权自动设置为 adminusr。 这里就是设置s位，有数值方法和+-法"></a>创建/home/admins 目录，并设置在目录中创建的文件，其组所有权自动设置为 adminusr。 这里就是设置s位，有数值方法和+-法</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">chmod 2770 &#x2F;home&#x2F;admins</span><br><span class="line"></span><br><span class="line"># 或</span><br><span class="line"></span><br><span class="line">chmod o-x &#x2F;home&#x2F;admins</span><br><span class="line">chmod o-r &#x2F;home&#x2F;admins</span><br><span class="line">chmod g+w &#x2F;home&#x2F;admins</span><br><span class="line">chmod g+s &#x2F;home&#x2F;admins # 这里设置组的s位</span><br></pre></td></tr></table></figure>

<p>验证方法，进入目录创建文件，查看组名</p>
<h3 id="autofs-挂载有两个关键，第一在-etc-auto-master-d-目录下创建后缀名为autofs的文件，-第二是编辑挂载配置文件"><a href="#autofs-挂载有两个关键，第一在-etc-auto-master-d-目录下创建后缀名为autofs的文件，-第二是编辑挂载配置文件" class="headerlink" title="autofs 挂载有两个关键，第一在/etc/auto.master.d/ 目录下创建后缀名为autofs的文件， 第二是编辑挂载配置文件"></a>autofs 挂载有两个关键，第一在/etc/auto.master.d/ 目录下创建后缀名为autofs的文件， 第二是编辑挂载配置文件</h3><p>内容格式</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># cat &#x2F;etc&#x2F;auto.master.d&#x2F;indirect</span><br><span class="line">#主挂载点	挂载配置</span><br><span class="line">&#x2F;internal	&#x2F;etc&#x2F;auto.demo</span><br></pre></td></tr></table></figure>

<p>内容配置，* 表示所有目录（根据nfsserver的情况）， 和&amp;搭配使用</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># cat &#x2F;etc&#x2F;auto.demo</span><br><span class="line"># 间接挂载目录	挂载配置	挂载路径（nfs地址）</span><br><span class="line">*	-rw,fstype&#x3D;nfs4,sync	servera:&#x2F;shares&#x2F;indirect&#x2F;&amp;</span><br></pre></td></tr></table></figure>

<h3 id="setfacl-和getfacl-设置和显示文件属性"><a href="#setfacl-和getfacl-设置和显示文件属性" class="headerlink" title="setfacl 和getfacl 设置和显示文件属性"></a>setfacl 和getfacl 设置和显示文件属性</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">设置natash用户读写权限</span><br><span class="line">setfacl u:natasha:rw	&#x2F;var&#x2F;tmp&#x2F;fstab</span><br><span class="line">设置harry用户没有任何权限 </span><br><span class="line">setfacl u:harry:-	&#x2F;var&#x2F;tmp&#x2F;fstab</span><br></pre></td></tr></table></figure>

<h3 id="重置root密码，在linux-行末追加-rd-local-按ctrl-x-启动"><a href="#重置root密码，在linux-行末追加-rd-local-按ctrl-x-启动" class="headerlink" title="重置root密码，在linux 行末追加 rd.local, 按ctrl+x 启动"></a>重置root密码，在linux 行末追加 rd.local, 按ctrl+x 启动</h3><p>重新挂载系统根目录, chroot到根目录和修改密码</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mount -orw,remount &#x2F;systemroot&#x2F;</span><br><span class="line">chroot &#x2F;systemroot&#x2F;</span><br><span class="line">passwd</span><br></pre></td></tr></table></figure>

<h3 id="逻辑卷扩容"><a href="#逻辑卷扩容" class="headerlink" title="逻辑卷扩容"></a>逻辑卷扩容</h3><p>设置分区start位置的时候，输入2048s。 s指扇区，一个扇区为512字节， 2048s指1M，这1M的分区为esp分区</p>
<p>扩容命令lvextrend，这个扩容只是将逻辑卷扩容， 而题目要求对文件系统扩容， 还需要执行文件系统类型对应的扩容命令如resize2fs(ext), xfs_growfs(xfs)。<br>但对lvextend命令添加 -r 参数可以一步到位</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 扩容到300MB</span><br><span class="line">lvextend -r -L 300MB &#x2F;dev&#x2F;new_redhat&#x2F;lv1</span><br></pre></td></tr></table></figure>

<h3 id="创建逻辑分区-注意避免磁盘不够用，尽量共用上一题的磁盘。而且创建卷组的时候不要忘记-s参数"><a href="#创建逻辑分区-注意避免磁盘不够用，尽量共用上一题的磁盘。而且创建卷组的时候不要忘记-s参数" class="headerlink" title="创建逻辑分区, 注意避免磁盘不够用，尽量共用上一题的磁盘。而且创建卷组的时候不要忘记-s参数"></a>创建逻辑分区, 注意避免磁盘不够用，尽量共用上一题的磁盘。而且创建卷组的时候不要忘记-s参数</h3><p>题目可能不是直接给分区大小，而是给出扩展块大小和拓展块个数，其实分区大小=拓展块大小 × 拓展块个数。 在lvcreate -l 来指定块个数 </p>
<p>这时必须使用msdos分区类型才有主分区和拓展分区，而且为拓展分区分配剩余的所有空间。 最后在拓展分区上创建逻辑分区， 并将创建的逻辑分区加入卷组</p>
<p>创建分区，大小通过上面的算法计算出来</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">parted </span><br><span class="line">mkpart</span><br><span class="line">print</span><br><span class="line">exit</span><br></pre></td></tr></table></figure>

<p>创建卷组</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vgcreate -s 20MB -n npgroup &#x2F;dev&#x2F;vdb2</span><br></pre></td></tr></table></figure>
<p>创建逻辑卷, 注意是小写l</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lvcreate -l 45 -n np npgroup</span><br></pre></td></tr></table></figure>
<p>这样就创建了一个 20×45 = 900MB的逻辑卷</p>
<h3 id="创建新的swap分区，注意需要修改fstab-而且验证的时候，不需要重启系统，而是执行"><a href="#创建新的swap分区，注意需要修改fstab-而且验证的时候，不需要重启系统，而是执行" class="headerlink" title="创建新的swap分区，注意需要修改fstab, 而且验证的时候，不需要重启系统，而是执行"></a>创建新的swap分区，注意需要修改fstab, 而且验证的时候，不需要重启系统，而是执行</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">systemctl daemon-reload </span><br><span class="line">swapon -a  # 类似mount -a</span><br><span class="line">swapon --show</span><br></pre></td></tr></table></figure>

<h3 id="vdo-–vdoLogicalSize-5G-不能使用GB"><a href="#vdo-–vdoLogicalSize-5G-不能使用GB" class="headerlink" title="vdo  –vdoLogicalSize 5G, 不能使用GB"></a>vdo  –vdoLogicalSize 5G, 不能使用GB</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vdo create --name test --vdoLogicalSize 5G --device &#x2F;dev&#x2F;vdb</span><br></pre></td></tr></table></figure>
<p><code>blkid</code> 查到 UUID, 最后添加到fstab</p>
<h3 id="vdo-持久挂载-mount"><a href="#vdo-持久挂载-mount" class="headerlink" title="vdo 持久挂载 mount"></a>vdo 持久挂载 mount</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">default,x-systemd.requires&#x3D;vdo.service</span><br></pre></td></tr></table></figure>

<h2 id="RHCE"><a href="#RHCE" class="headerlink" title="RHCE"></a>RHCE</h2><p>ansible的有用命令<br>ansbile-doc -l | grep  查找模块和介绍<br>ansible-doc 模块 查看模块具体说明</p>
<h3 id="创建inventory-文件，-子组的写法为"><a href="#创建inventory-文件，-子组的写法为" class="headerlink" title="创建inventory 文件， 子组的写法为"></a>创建inventory 文件， 子组的写法为</h3><p>[webservices:children]<br>prod</p>
<p>prod 是webserverices组的子组</p>
<h3 id="创建ansible-cfg-文件，可以复制-etc-ansbile-ansible-cfg-到～-ansbile-目录下"><a href="#创建ansible-cfg-文件，可以复制-etc-ansbile-ansible-cfg-到～-ansbile-目录下" class="headerlink" title="创建ansible.cfg 文件，可以复制 /etc/ansbile/ansible.cfg 到～/ansbile/目录下"></a>创建ansible.cfg 文件，可以复制 /etc/ansbile/ansible.cfg 到～/ansbile/目录下</h3><p>容易忘记的选项是远程登陆身份， 即配置 remote_user = devops<br>如果环境没有配置免密登陆，需要在[defaults] 栏添加 <code>ask_pass = True</code></p>
<p>验证方法 <code>ansible all -m ping</code></p>
<h3 id="ansbile-ad-hoc-添加yum-源-ansible-模块的使用方法-ansible-主机名-m-模块-a-‘参数’"><a href="#ansbile-ad-hoc-添加yum-源-ansible-模块的使用方法-ansible-主机名-m-模块-a-‘参数’" class="headerlink" title="ansbile ad-hoc 添加yum 源  ansible 模块的使用方法 ansible 主机名 -m 模块 -a ‘参数’"></a>ansbile ad-hoc 添加yum 源  ansible 模块的使用方法 ansible 主机名 -m 模块 -a ‘参数’</h3><p>脚本要添加可执行权限</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 先要切换到工作目录</span></span><br><span class="line"><span class="built_in">cd</span> /home/devops/ansible/</span><br><span class="line"></span><br><span class="line">ansible all -m yum-repository  -a <span class="string">'name=  description=  baseurl=  enabled= gpgcheck= gpgkey= '</span></span><br></pre></td></tr></table></figure>

<h3 id="安装软件包"><a href="#安装软件包" class="headerlink" title="安装软件包"></a>安装软件包</h3><p>安装软件包如’Development Tools’, 需要在包名前面加‘@’即 ‘@Development Tools’<br>验证yaml 语法格式: <code>ansible-playbook --syntax-check *.yml</code></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">install</span>  <span class="string">development</span> <span class="string">tools</span></span><br><span class="line">  <span class="attr">hosts:</span> <span class="string">dev</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">install</span> <span class="string">development</span> <span class="string">tools</span></span><br><span class="line">        <span class="attr">yum:</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">"@Development Tools"</span></span><br><span class="line">          <span class="attr">state:</span> <span class="string">present</span></span><br></pre></td></tr></table></figure>

<h3 id="同步时间依赖角色，安装角色包’rhel-system-roles’-需要在配置文件里添加上roles路径"><a href="#同步时间依赖角色，安装角色包’rhel-system-roles’-需要在配置文件里添加上roles路径" class="headerlink" title="同步时间依赖角色，安装角色包’rhel-system-roles’ 需要在配置文件里添加上roles路径"></a>同步时间依赖角色，安装角色包’rhel-system-roles’ 需要在配置文件里添加上roles路径</h3><p>playbook 示例在/usr/share/ansibe/roles/rhel-system-roles.timesync/Readme.md<br>现成的yml示例在/usr/share/doc/rhel-system-roles/timesync/example-timesync-playbook.yml</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># ansible.cfg</span><br><span class="line">[default]</span><br><span class="line">roles_path &#x3D; &#x2F;home&#x2F;devops&#x2F;ansible&#x2F;roles:&#x2F;usr&#x2F;share&#x2F;ansible&#x2F;roles</span><br></pre></td></tr></table></figure>

<h3 id="使用ansible-galaxy-命令安装角色，安装到本地roles目录"><a href="#使用ansible-galaxy-命令安装角色，安装到本地roles目录" class="headerlink" title="使用ansible-galaxy 命令安装角色，安装到本地roles目录"></a>使用ansible-galaxy 命令安装角色，安装到本地roles目录</h3><p>yml文件很简单, 执行命令 ansible-galaxy install -r roles/requirement.yml -p roles/<br>-p 表示安装路径 </p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">balancer</span></span><br><span class="line">  <span class="attr">file:</span> <span class="string">/home/devops/ansible/files/5/haproxy.tar</span></span><br></pre></td></tr></table></figure>

<h3 id="创建apache角色，-角色对应一系列的任务和模板文件"><a href="#创建apache角色，-角色对应一系列的任务和模板文件" class="headerlink" title="创建apache角色， 角色对应一系列的任务和模板文件"></a>创建apache角色， 角色对应一系列的任务和模板文件</h3><p>通过<code>ansible-galaxy init apache</code> 来初始化角色目录，修改角色目录下的tasks/mail.yml 来添加任务，任务所需的模板文件在同级目录templates下<br>通过<code>ansible servera -m setup</code> 来查询环境变量， 在模板文件中使用<code>ansible_facts[&#39;fqdn&#39;]</code> 来引用变量<br>题目说的hostname 是<code>serverc.lab.example.com</code> 对应变量是fqdn, 另外一个是ip即 [‘default_ipv4’][‘address’]</p>
<p>例如，安装httpd用到yum模块， 启用httpd 用到service模块， 防火墙配置用到firewalld模块</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># home/devops/ansible/role/apache/tasks/main.yml</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">install</span> <span class="string">httpd</span></span><br><span class="line">  <span class="attr">yum:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">httpd</span></span><br><span class="line">    <span class="attr">state:</span> <span class="string">present</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">enable</span> <span class="string">httpd</span></span><br><span class="line">  <span class="attr">service:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">httpd</span></span><br><span class="line">    <span class="attr">state:</span> <span class="string">started</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">yes</span></span><br><span class="line">    </span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">firewalld</span> <span class="string">config</span></span><br><span class="line">  <span class="attr">firewalld:</span></span><br><span class="line">    <span class="attr">service:</span> <span class="string">httpd</span></span><br><span class="line">    <span class="attr">immediate:</span> <span class="literal">yes</span></span><br><span class="line">    <span class="attr">permanent:</span> <span class="literal">yes</span></span><br><span class="line">    <span class="attr">state:</span> <span class="string">enabled</span></span><br><span class="line">   </span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">install</span> <span class="string">templates</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">src:</span> <span class="string">index.html.j2</span></span><br><span class="line">    <span class="attr">dest:</span> <span class="string">/var/www/html/index.html</span></span><br></pre></td></tr></table></figure>

<p>模块文件放到templates目录下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># home&#x2F;devops&#x2F;ansible&#x2F;role&#x2F;apache&#x2F;templates&#x2F;index.html.j2</span><br><span class="line">Welcome to &#123;&#123; ansible_facts[&#39;fqdn&#39;] &#125;&#125; on &#123;&#123; ansible_facts[&#39;default_ipv4&#39;][&#39;address&#39;] &#125;&#125;</span><br></pre></td></tr></table></figure>

<p>最后还需要创建一个playbook, 如同其他playbook 一样执行</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># newrole.yml</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">install</span> <span class="string">new</span> <span class="string">role</span></span><br><span class="line">  <span class="attr">hosts:</span> <span class="string">webservers</span></span><br><span class="line">  <span class="attr">roles:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">apache</span></span><br></pre></td></tr></table></figure>

<h3 id="执行balancer-角色-创建一个负载均衡"><a href="#执行balancer-角色-创建一个负载均衡" class="headerlink" title="执行balancer 角色, 创建一个负载均衡"></a>执行balancer 角色, 创建一个负载均衡</h3><p>验证：<br>ssh到serverd 上，curl localhost, 先是访问的serverb, 然后访问的serverc</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">deploy</span> <span class="string">apache</span> <span class="string">on</span> <span class="string">webservers</span></span><br><span class="line">  <span class="attr">hosts:</span> <span class="string">webservers</span></span><br><span class="line">  <span class="attr">roles:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">apache</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">deploy</span> <span class="string">balancer</span> <span class="string">on</span> <span class="string">balancer</span></span><br><span class="line">  <span class="attr">hosts:</span> <span class="string">balancers</span></span><br><span class="line">  <span class="attr">roles:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">balancer</span></span><br><span class="line">    </span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">deploy</span> <span class="string">phpinfo</span> <span class="string">on</span> <span class="string">webservers</span></span><br><span class="line">  <span class="attr">hosts:</span> <span class="string">webservers</span></span><br><span class="line">  <span class="attr">roles:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">phpinfo</span></span><br></pre></td></tr></table></figure>

<h4 id="可能出现的错误，提示应该使用bind，这是由于balance-role的template-错误"><a href="#可能出现的错误，提示应该使用bind，这是由于balance-role的template-错误" class="headerlink" title="可能出现的错误，提示应该使用bind，这是由于balance role的template 错误"></a>可能出现的错误，提示应该使用bind，这是由于balance role的template 错误</h4><p>修改办法, 将listen行换行并加上bind</p>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># /home/devops/ansible/roles/balancer/templates/haproxy.cfg.j2</span><br><span class="line"></span><br><span class="line">backend app</span><br><span class="line">  &#123;% for host in groups.balancers %&#125;</span><br><span class="line"><span class="deletion">-  	listen &#123;&#123; daemonname &#125;&#125; 0.0.0.0:&#123;&#123; listenport &#125;&#125;</span></span><br><span class="line"><span class="addition">+  	listen &#123;&#123; daemonname &#125;&#125; </span></span><br><span class="line"><span class="addition">+	bind 0.0.0.0:&#123;&#123; listenport &#125;&#125;</span></span><br><span class="line">  &#123;% endfor %&#125;</span><br></pre></td></tr></table></figure>

<h3 id="创建逻辑卷，考验block-rescue-always-使用lvol，when-和play对齐"><a href="#创建逻辑卷，考验block-rescue-always-使用lvol，when-和play对齐" class="headerlink" title="创建逻辑卷，考验block/rescue/always, 使用lvol，when 和play对齐"></a>创建逻辑卷，考验block/rescue/always, 使用lvol，<code>when</code> 和play对齐</h3><p>使用了block/rescue/always就不需要tasks关键词</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">create</span> <span class="string">a</span> <span class="string">logic</span> <span class="string">volume</span> <span class="string">with</span> <span class="string">size</span> <span class="string">of</span> <span class="number">5000</span> <span class="string">and</span> <span class="string">format</span></span><br><span class="line">  <span class="attr">hosts:</span> <span class="string">all</span></span><br><span class="line">  <span class="attr">block:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">create</span> <span class="string">logic</span> <span class="string">volume</span></span><br><span class="line">	  <span class="attr">lvol:</span></span><br><span class="line">	    <span class="attr">vg:</span> <span class="string">research</span></span><br><span class="line">	    <span class="attr">lv:</span> <span class="string">data</span></span><br><span class="line">	    <span class="attr">size:</span> <span class="number">1500</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">fomat</span> <span class="string">data</span> <span class="string">volume</span></span><br><span class="line">        <span class="attr">filesystem:</span></span><br><span class="line">          <span class="attr">fstype:</span> <span class="string">ext4</span></span><br><span class="line">          <span class="attr">dev:</span> <span class="string">/dev/research/data</span></span><br><span class="line">  <span class="attr">rescue:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">debug</span> <span class="string">message</span></span><br><span class="line">      <span class="attr">debug:</span></span><br><span class="line">        <span class="attr">msg:</span> <span class="string">can't</span> <span class="string">create</span> <span class="string">a</span> <span class="string">size</span> <span class="string">of</span> <span class="number">1800</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">create</span> <span class="string">a</span> <span class="string">logical</span> <span class="string">volume</span> <span class="string">with</span> <span class="string">size</span> <span class="string">of</span> <span class="number">800</span> <span class="string">and</span> <span class="string">format</span></span><br><span class="line">        <span class="attr">lvol:</span></span><br><span class="line">          <span class="attr">vg:</span> <span class="string">research</span></span><br><span class="line">          <span class="attr">lv:</span> <span class="string">data</span></span><br><span class="line">          <span class="attr">size:</span> <span class="number">1500</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">fomat</span> <span class="string">data</span> <span class="string">volume</span></span><br><span class="line">        <span class="attr">filesystem:</span></span><br><span class="line">          <span class="attr">fstype:</span> <span class="string">ext4</span></span><br><span class="line">          <span class="attr">dev:</span> <span class="string">/dev/research/data</span></span><br><span class="line">      <span class="attr">when:</span> <span class="string">ansible_facts['lvm']['vgs']['research']</span> <span class="string">is</span> <span class="string">defined</span></span><br><span class="line">      <span class="attr">ignore_errors:</span> <span class="literal">yes</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">debug</span> <span class="number">2</span> </span><br><span class="line">        <span class="attr">debug:</span></span><br><span class="line">          <span class="attr">msg:</span> <span class="string">volume</span> <span class="string">group</span> <span class="string">does</span> <span class="string">not</span> <span class="string">exist</span></span><br><span class="line">      <span class="attr">when:</span> <span class="string">ansible_facts['lvm']['vgs']['research']</span> <span class="string">is</span> <span class="string">undefined</span></span><br></pre></td></tr></table></figure>

<h3 id="创建hosts文件，-考验jinija-的for循环和读inventory文件"><a href="#创建hosts文件，-考验jinija-的for循环和读inventory文件" class="headerlink" title="创建hosts文件， 考验jinija 的for循环和读inventory文件"></a>创建hosts文件， 考验jinija 的for循环和读inventory文件</h3><p>取facts变量的方法参考balancer的模板：<br>/home/ansible/roles/balancer/roles/template/haproxy.cfg.j2</p>
<p>基于给的hosts.j2 文件修改, 拼凑出<code>ip url alias</code>格式，分别对应 default_ipv4.address, fqdn, hostname<br>ansible_facts在hostvars[host]中</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 取</span></span><br><span class="line"><span class="string">&#123;%</span> <span class="string">for</span> <span class="string">host</span> <span class="string">in</span> <span class="string">groups.all</span> <span class="string">%&#125;</span></span><br><span class="line"><span class="string">&#123;&#123;</span> <span class="string">hostvars[host]['ansible_facts']</span> <span class="string">*忽露不写了*</span> <span class="string">&#125;&#125;</span> <span class="string">×</span> <span class="string">×</span> </span><br><span class="line"><span class="string">&#123;%</span> <span class="string">endfor</span> <span class="string">%&#125;</span></span><br><span class="line"><span class="string">---</span> </span><br><span class="line"></span><br><span class="line"><span class="string">创建playbook的要小心，题目要求生成所有主机的纪录，所以hosts是all,</span> <span class="string">但只部署在dev组的主机上要加when,</span>   </span><br><span class="line"><span class="string">要加`when:</span> <span class="string">'dev'</span> <span class="string">in</span> <span class="string">group_names`</span></span><br><span class="line"></span><br><span class="line"><span class="string">```yml</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">gen</span> <span class="string">hosts</span> <span class="string">and</span> <span class="string">deploy</span> <span class="string">on</span> <span class="string">dev</span> <span class="string">group</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">gen</span> <span class="string">hosts</span> <span class="string">and</span> <span class="string">deploy</span></span><br><span class="line">        <span class="attr">template:</span></span><br><span class="line">          <span class="attr">src:</span> <span class="string">hosts.j2</span></span><br><span class="line">          <span class="attr">dest:</span> <span class="string">/etc/myhosts</span></span><br><span class="line">      <span class="attr">when:</span> <span class="string">"'dev' in group_names"</span></span><br></pre></td></tr></table></figure>

<h3 id="创建web-server-注意将文件标注setype为httpd-system-content-t"><a href="#创建web-server-注意将文件标注setype为httpd-system-content-t" class="headerlink" title="创建web server, 注意将文件标注setype为httpd_system_content_t"></a>创建web server, 注意将文件标注setype为httpd_system_content_t</h3><p>通过man semanager-fcontext 查询setype, 或者使用<code>ls -ldZ</code>来查询selinux标签</p>
<p>创建文件，目录、链接都用file模块，但操作文件内容用copy模块<br>创建组用group模块,创建用户用user模块<br>容易搞反的链接的src是指向的文件，所以是/webdev, 可以看帮助文档</p>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">---</span></span><br><span class="line"><span class="deletion">- name: create web server</span></span><br><span class="line">  hosts: webservers</span><br><span class="line">  tasks:</span><br><span class="line">    - name: add group</span><br><span class="line">        group:</span><br><span class="line">           name: webdev</span><br><span class="line">           state: present</span><br><span class="line">    - name: create directory</span><br><span class="line">        file:</span><br><span class="line">          path: /webdev</span><br><span class="line">          group: webdev</span><br><span class="line">          state: directory</span><br><span class="line">          mode: u+rwx,g+rwxs,o-rx</span><br><span class="line"> -        setype: httpd_system_content_t</span><br><span class="line">    - name: create a symbolic link</span><br><span class="line">        file:</span><br><span class="line"> -        src: /var/www/html/webdev</span><br><span class="line"> -        dest: /webdev</span><br><span class="line"> +        src: /webdev</span><br><span class="line"> +        dest: /var/www/html/webdev</span><br><span class="line">          state: link</span><br><span class="line">    - name: create index.html</span><br><span class="line">        copy:</span><br><span class="line">          content: Development</span><br><span class="line">          dest: /var/www/html/webdev/index.html</span><br><span class="line"><span class="addition">+         setype: httpd_system_content_t</span></span><br></pre></td></tr></table></figure>

<h3 id="创建硬件报告，用到loops进行数组循环，内置变量item和-regexs匹配，lineinfile-进行文件编辑"><a href="#创建硬件报告，用到loops进行数组循环，内置变量item和-regexs匹配，lineinfile-进行文件编辑" class="headerlink" title="创建硬件报告，用到loops进行数组循环，内置变量item和 regexs匹配，lineinfile 进行文件编辑"></a>创建硬件报告，用到loops进行数组循环，内置变量item和 regexs匹配，lineinfile 进行文件编辑</h3><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">generate</span> <span class="string">hw</span> <span class="string">report</span></span><br><span class="line">  <span class="attr">hosts:</span> <span class="string">all</span></span><br><span class="line">  <span class="attr">vars:</span></span><br><span class="line">    <span class="attr">hw_all:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">hw_name:</span> <span class="string">HOST</span></span><br><span class="line">        <span class="attr">hw_content:</span> <span class="string">"<span class="template-variable">&#123;&#123; ansible_facts['hostname'] &#125;&#125;</span>"</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">hw_name:</span> <span class="string">BIOS_version</span></span><br><span class="line">        <span class="attr">hw_content:</span> <span class="string">"<span class="template-variable">&#123;&#123; ansible_facts['bios_version'] &#125;&#125;</span>"</span></span><br></pre></td></tr></table></figure>

<h3 id="创建加密文件，用到ansible-vault命令"><a href="#创建加密文件，用到ansible-vault命令" class="headerlink" title="创建加密文件，用到ansible-vault命令"></a>创建加密文件，用到ansible-vault命令</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ansible-vault encrypt lock.yml --vault-password-file&#x3D;secret.txt</span><br></pre></td></tr></table></figure>

<h3 id="添加用户，-ansible-playbook-通过-–vault-password-file-secret-txt-来传密码文件"><a href="#添加用户，-ansible-playbook-通过-–vault-password-file-secret-txt-来传密码文件" class="headerlink" title="添加用户， ansible-playbook 通过 –vault-password-file=secret.txt 来传密码文件"></a>添加用户， ansible-playbook 通过 –vault-password-file=secret.txt 来传密码文件</h3><p>通过<code>vars_files</code>来读取变量文件， loop 来循环遍历数组变量， 然后模板直接取密码后用’| password_hash(‘sha512’)’ 来加密密码<br>通常情况下在playbook中，开头位置引用一个变量时都需要”“， 但是在when块里，则直接使用 variable。 另外字符串要用“string”  </p>
<p>创建用户时， 指定附属组用groups, 主要组是group</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">- &#123;&#123; variable &#125;&#125; ## 错误</span><br><span class="line">key: &#123;&#123; variable &#125;&#125; ## 错误</span><br><span class="line">- &quot;&#123;&#123; variable&#125;&#125;&quot; ## 正确</span><br><span class="line">key: &quot;&#123;&#123; variable &#125;&#125;&quot; ## 正确</span><br></pre></td></tr></table></figure>

<p>结果</p>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">---</span></span><br><span class="line"><span class="deletion">- name: create user on dev,test</span></span><br><span class="line">  hosts: dev,test</span><br><span class="line">  vars_files:</span><br><span class="line">    - lock.yml</span><br><span class="line">    - user_list.yml</span><br><span class="line">  tasks:</span><br><span class="line">    - name: create group devops</span><br><span class="line">      group:</span><br><span class="line">        name: devops</span><br><span class="line">        state: present</span><br><span class="line">    - name: create user </span><br><span class="line">      user:</span><br><span class="line">        name: "&#123;&#123; item.name &#125;&#125;"</span><br><span class="line"><span class="deletion">-       group: devops</span></span><br><span class="line"><span class="addition">+       groups: devops        </span></span><br><span class="line">        password: "&#123;&#123; pw_developer | password_hash('sha512') &#125;&#125;"</span><br><span class="line">      loop: "&#123;&#123; user &#125;&#125;"</span><br><span class="line"><span class="deletion">-     when: "&#123;&#123; item.job &#125;&#125;" == developer</span></span><br><span class="line"><span class="addition">+     when: item.job == "developer"</span></span><br><span class="line"><span class="deletion">- name: create user on prod</span></span><br><span class="line">  hosts: prod</span><br><span class="line">  vars_files:</span><br><span class="line">    - lock.yml</span><br><span class="line">    - users_list.yml</span><br><span class="line">  tasks:</span><br><span class="line">    - name: create group manager</span><br><span class="line">      group:</span><br><span class="line">        name: manager</span><br><span class="line">        state: present</span><br><span class="line">    - name: create user</span><br><span class="line">      user:</span><br><span class="line">        name: "&#123;&#123; item.name &#125;&#125;"</span><br><span class="line">        groups: manager</span><br><span class="line">        password: "&#123;&#123; pw_manager | password_hash('sha512') &#125;&#125;"</span><br><span class="line">      loop: "&#123;&#123; user &#125;&#125;"</span><br><span class="line"><span class="deletion">-     when: "&#123;&#123; item.job &#125;&#125;" == manager</span></span><br><span class="line"><span class="addition">+     when: item.job == "manager"</span></span><br></pre></td></tr></table></figure>

<h3 id="修改密码-使用ansible-vault-rekey-修改密码，或者先解密后加密"><a href="#修改密码-使用ansible-vault-rekey-修改密码，或者先解密后加密" class="headerlink" title="修改密码, 使用ansible-vault rekey 修改密码，或者先解密后加密"></a>修改密码, 使用<code>ansible-vault rekey</code> 修改密码，或者先解密后加密</h3><h3 id="修改文件内容-使用copy模块，以及when条件判断"><a href="#修改文件内容-使用copy模块，以及when条件判断" class="headerlink" title="修改文件内容, 使用copy模块，以及when条件判断"></a>修改文件内容, 使用copy模块，以及when条件判断</h3><p>在playbook的内建变量 inventory_hostname 表示定义在inventory里的主机名称<br>也可以使用ansible_facts[‘hostname’],前提是被管理节点的hostname必须如果管理节点定义名称一样。 因为后者是到被管理节点获取。</p>
<p>使用when 限定条件， 满足条件才能执行这个task</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">create</span> <span class="string">issue</span></span><br><span class="line">  <span class="attr">hosts:</span> <span class="string">all</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">create</span> <span class="string">issue</span> <span class="string">file</span></span><br><span class="line">      <span class="attr">copy:</span></span><br><span class="line">        <span class="attr">content:</span> <span class="string">"Development"</span></span><br><span class="line">        <span class="attr">dest:</span> <span class="string">/etc/issue</span></span><br><span class="line">      <span class="attr">when:</span> <span class="string">inventory_name</span> <span class="string">in</span> <span class="string">groups.dev</span>  </span><br><span class="line"><span class="string">```</span>      </span><br><span class="line"></span><br><span class="line"><span class="comment">### 第二次排错</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#### ansible-galaxy 安装角色, 指定方法分别是 src/name</span></span><br><span class="line"></span><br><span class="line"><span class="string">```yml</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">src:</span> <span class="string">files/5/balancer.tar</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">balancer</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">src:</span> <span class="string">files/5/phpinfo.tar</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">phpinfo</span></span><br></pre></td></tr></table></figure>

<h3 id="timesync-看doc-示例，-验证方法是看timedatectl-看system-clock-syncronize-为-yes"><a href="#timesync-看doc-示例，-验证方法是看timedatectl-看system-clock-syncronize-为-yes" class="headerlink" title="timesync 看doc 示例， 验证方法是看timedatectl 看system clock syncronize 为 yes"></a>timesync 看doc 示例， 验证方法是看timedatectl 看system clock syncronize 为 yes</h3><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">use</span> <span class="string">timesync</span> <span class="string">role</span></span><br><span class="line">  <span class="attr">hosts:</span> <span class="string">all</span></span><br><span class="line">  <span class="attr">vars:</span></span><br><span class="line">    <span class="attr">timesync_ntp_servers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">hostname:</span> </span><br><span class="line">        <span class="attr">iburst:</span> <span class="literal">yes</span></span><br><span class="line">  <span class="attr">roles:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">rhel_system_roles.timesync</span></span><br></pre></td></tr></table></figure>

<h3 id="创建hosts-要用"><a href="#创建hosts-要用" class="headerlink" title="创建hosts, 要用 "></a>创建hosts, 要用 </h3><h3 id="使用firewalld模块时，需要指定immediate-参数，确保能立即生效"><a href="#使用firewalld模块时，需要指定immediate-参数，确保能立即生效" class="headerlink" title="使用firewalld模块时，需要指定immediate 参数，确保能立即生效"></a>使用firewalld模块时，需要指定immediate 参数，确保能立即生效</h3><h3 id="设置文件的权限时，应使用u-rwx-g-rwxs-o-rw-而不是u-rwx，原因很好理解"><a href="#设置文件的权限时，应使用u-rwx-g-rwxs-o-rw-而不是u-rwx，原因很好理解" class="headerlink" title="设置文件的权限时，应使用u=rwx,g=rwxs,o=rw, 而不是u+rwx，原因很好理解"></a>设置文件的权限时，应使用u=rwx,g=rwxs,o=rw, 而不是u+rwx，原因很好理解</h3>
      
    </div>
    <footer class="article-footer">
      <a data-url="https://energygreek.github.io/2020/08/29/rhce8-question/" data-id="ckp6c7an8001nd1okcwmp0mfo" data-title="rhce8 question" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/rhce8/" rel="tag">rhce8</a></li></ul>

    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2020/10/19/Linux-Interrupts/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          Linux Interrupts
        
      </div>
    </a>
  
  
    <a href="/2020/08/28/sql-operator-priority/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">sql operator priority</div>
    </a>
  
</nav>

  
</article>


</section>
        
          <aside id="sidebar">
  
    

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/Linux-%E5%86%85%E6%A0%B8%E5%8E%9F%E7%90%86/" rel="tag">Linux 内核原理</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/aarch64/" rel="tag">aarch64</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/algorithm/" rel="tag">algorithm</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/c/" rel="tag">c++</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/c-c/" rel="tag">c/c++</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/cmake/" rel="tag">cmake</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/dns/" rel="tag">dns</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/docker/" rel="tag">docker</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/docker-filesystem/" rel="tag">docker, filesystem</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/experience/" rel="tag">experience</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/filesystem/" rel="tag">filesystem</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/git/" rel="tag">git</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/grub/" rel="tag">grub</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/k8s/" rel="tag">k8s</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/linux-%E7%B3%BB%E7%BB%9F%E8%B0%83%E7%94%A8/" rel="tag">linux 系统调用</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/linux%E5%9F%BA%E7%A1%80/" rel="tag">linux基础</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/lvm/" rel="tag">lvm</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/maintaince/" rel="tag">maintaince</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/memory-shared-ptr-unique-ptr-exception-safe/" rel="tag">memory,shared_ptr,unique_ptr,exception-safe</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/misc/" rel="tag">misc</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/printer-linux/" rel="tag">printer linux</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/program-lock/" rel="tag">program,lock</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/python/" rel="tag">python</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/python-%E5%8C%85%E7%AE%A1%E7%90%86/" rel="tag">python 包管理</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/rancher-k8s/" rel="tag">rancher,k8s</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/rhce8/" rel="tag">rhce8</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/safe/" rel="tag">safe</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/socket-udp-socketopt/" rel="tag">socket, udp, socketopt</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/sql/" rel="tag">sql</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/sysemd-%E8%BF%90%E7%BB%B4/" rel="tag">sysemd, 运维</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/systemd-tmpfile/" rel="tag">systemd,tmpfile</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/terminal-urxvt/" rel="tag">terminal,urxvt</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/tool/" rel="tag">tool</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/weechat/" rel="tag">weechat</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E4%BA%8C%E5%8F%89%E6%A0%91/" rel="tag">二叉树</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/Linux-%E5%86%85%E6%A0%B8%E5%8E%9F%E7%90%86/" style="font-size: 10px;">Linux 内核原理</a> <a href="/tags/aarch64/" style="font-size: 10px;">aarch64</a> <a href="/tags/algorithm/" style="font-size: 10px;">algorithm</a> <a href="/tags/c/" style="font-size: 20px;">c++</a> <a href="/tags/c-c/" style="font-size: 13.33px;">c/c++</a> <a href="/tags/cmake/" style="font-size: 10px;">cmake</a> <a href="/tags/dns/" style="font-size: 10px;">dns</a> <a href="/tags/docker/" style="font-size: 10px;">docker</a> <a href="/tags/docker-filesystem/" style="font-size: 10px;">docker, filesystem</a> <a href="/tags/experience/" style="font-size: 10px;">experience</a> <a href="/tags/filesystem/" style="font-size: 10px;">filesystem</a> <a href="/tags/git/" style="font-size: 10px;">git</a> <a href="/tags/grub/" style="font-size: 10px;">grub</a> <a href="/tags/k8s/" style="font-size: 10px;">k8s</a> <a href="/tags/linux-%E7%B3%BB%E7%BB%9F%E8%B0%83%E7%94%A8/" style="font-size: 10px;">linux 系统调用</a> <a href="/tags/linux%E5%9F%BA%E7%A1%80/" style="font-size: 10px;">linux基础</a> <a href="/tags/lvm/" style="font-size: 10px;">lvm</a> <a href="/tags/maintaince/" style="font-size: 10px;">maintaince</a> <a href="/tags/memory-shared-ptr-unique-ptr-exception-safe/" style="font-size: 10px;">memory,shared_ptr,unique_ptr,exception-safe</a> <a href="/tags/misc/" style="font-size: 10px;">misc</a> <a href="/tags/printer-linux/" style="font-size: 10px;">printer linux</a> <a href="/tags/program-lock/" style="font-size: 10px;">program,lock</a> <a href="/tags/python/" style="font-size: 13.33px;">python</a> <a href="/tags/python-%E5%8C%85%E7%AE%A1%E7%90%86/" style="font-size: 10px;">python 包管理</a> <a href="/tags/rancher-k8s/" style="font-size: 10px;">rancher,k8s</a> <a href="/tags/rhce8/" style="font-size: 10px;">rhce8</a> <a href="/tags/safe/" style="font-size: 13.33px;">safe</a> <a href="/tags/socket-udp-socketopt/" style="font-size: 10px;">socket, udp, socketopt</a> <a href="/tags/sql/" style="font-size: 10px;">sql</a> <a href="/tags/sysemd-%E8%BF%90%E7%BB%B4/" style="font-size: 10px;">sysemd, 运维</a> <a href="/tags/systemd-tmpfile/" style="font-size: 10px;">systemd,tmpfile</a> <a href="/tags/terminal-urxvt/" style="font-size: 10px;">terminal,urxvt</a> <a href="/tags/tool/" style="font-size: 16.67px;">tool</a> <a href="/tags/weechat/" style="font-size: 10px;">weechat</a> <a href="/tags/%E4%BA%8C%E5%8F%89%E6%A0%91/" style="font-size: 10px;">二叉树</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/05/">May 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/04/">April 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/03/">March 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/02/">February 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/01/">January 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/11/">November 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/10/">October 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/08/">August 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/07/">July 2020</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2021/05/13/manage-temporary-file-with-systemd-tmpfiles/">使用systemd-tmpfiles来管理临时文件</a>
          </li>
        
          <li>
            <a href="/2021/04/02/ways-to-use-third-party-library-in-cmake/">cmake 使用第三方库</a>
          </li>
        
          <li>
            <a href="/2021/03/25/my-urxvt/">urxvt配置</a>
          </li>
        
          <li>
            <a href="/2021/03/17/static-compile-warning-if-namespace-resolving-function-used/">static compile warning if namespace resolving function used</a>
          </li>
        
          <li>
            <a href="/2021/03/15/shared-pointer/">智能指针</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      
      &copy; 2021 husongtao<br>
      Powered by <a href="https://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    


<script src="/js/jquery-3.4.1.min.js"></script>



  
<script src="/fancybox/jquery.fancybox.min.js"></script>




<script src="/js/script.js"></script>





  </div>
</body>
</html>